System.register(["./coordinates-converts-utils-bf8713a9.js","./base.js","./index-6f89fc06.js","./event-enum-5a5aa40e.js","./deprecated-3.0.0-f3f53c89.js","./renderable-component-658e90bd.js","./texture-buffer-pool-d3259f64.js","./transform-utils-1f4a2037.js","./view-7d20208a.js","./screen-d46ce30a.js","./json-asset-0797cbb7.js","./camera-component-f1234106.js","./find-5191dd26.js","./factory-9595a1ce.js","./mesh-3d4ecfd0.js","./skeleton-c02c55ca.js","./index-7b16c266.js","./collision-matrix-fb9744d2.js","./terrain-asset-59d38d9d.js","./physics-framework.js","./_commonjsHelpers-19d0a8b5.js","./tuple-dictionary-5e20c301.js","./ammo-instantiated-1ba44ae5.js","./array-collision-matrix-ec6af177.js"],(function(){"use strict";var t,i,e,s,o,n,r,a,l,h,d,c,u,p,_,S,y,f;return{setters:[function(d){t=d.cD,i=d.e4,e=d.b2,s=d.b6,o=d.g4,n=d.e,r=d.e3,a=d.bB,l=d.d,h=d.w},function(){},function(){},function(t){d=t.T},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(){},function(t){c=t.P,u=t.s},function(t){p=t.a,_=t.P},function(){},function(){},function(){},function(t){S=t.T},function(t){y=t.A},function(t){f=t.A}],execute:function(){function g(t,i){return t.setValue(i.x,i.y,i.z),t}function C(t,i){return t.x=i.x(),t.y=i.y(),t.z=i.z(),t}function E(t,i){return t.setValue(i.x,i.y,i.z,i.w),t}function T(t,i){return t.x=i.x(),t.y=i.y(),t.z=i.z(),t.w=i.w(),t}function m(t,i){delete y.getCache(i)[y.getPointer(t)]}function A(i,e){for(var s=e.renderingSubMeshes.length,o=0;o<s;o++){var n=e.renderingSubMeshes[o],r=n.geometricInfo;if(r){var a=n.primitiveMode,l=r.positions,h=r.indices,d=new y.btVector3,c=new y.btVector3,u=new y.btVector3;if(a===t.TRIANGLE_LIST)for(var p=h.length,_=0;_<p;_+=3){var S=3*h[_],f=3*h[_+1],g=3*h[_+2];d.setValue(l[S],l[S+1],l[S+2]),c.setValue(l[f],l[f+1],l[f+2]),u.setValue(l[g],l[g+1],l[g+2]),i.addTriangle(d,c,u)}else if(a===t.TRIANGLE_STRIP)for(var C=h.length-2,E=0,T=0;T<C;T+=1){var m=3*h[T-E],A=3*h[T+E+1],b=3*h[T+2];E=~E,d.setValue(l[m],l[m+1],l[m+2]),c.setValue(l[A],l[A+1],l[A+2]),u.setValue(l[b],l[b+1],l[b+2]),i.addTriangle(d,c,u)}else if(a===t.TRIANGLE_FAN){var O=h.length-1,P=3*h[0];d.setValue(l[P],l[P+1],l[P+2]);for(var B=1;B<O;B+=1){var R=3*h[B],I=3*h[B+1];c.setValue(l[R],l[R+1],l[R+2]),u.setValue(l[I],l[I+1],l[I+2]),i.addTriangle(d,c,u)}}y.destroy(d),y.destroy(c),y.destroy(u)}}return i}var b,O,P,B,R,I,v,w,D;!function(t){t[t.BODY_RE_ADD=1]="BODY_RE_ADD",t[t.GHOST_RE_ADD=2]="GHOST_RE_ADD"}(b||(b={})),function(t){t[t.CF_STATIC_OBJECT=1]="CF_STATIC_OBJECT",t[t.CF_KINEMATIC_OBJECT=2]="CF_KINEMATIC_OBJECT",t[t.CF_NO_CONTACT_RESPONSE=4]="CF_NO_CONTACT_RESPONSE",t[t.CF_CUSTOM_MATERIAL_CALLBACK=8]="CF_CUSTOM_MATERIAL_CALLBACK",t[t.CF_CHARACTER_OBJECT=16]="CF_CHARACTER_OBJECT",t[t.CF_DISABLE_VISUALIZE_OBJECT=32]="CF_DISABLE_VISUALIZE_OBJECT",t[t.CF_DISABLE_SPU_COLLISION_PROCESSING=64]="CF_DISABLE_SPU_COLLISION_PROCESSING"}(O||(O={})),y.AmmoCollisionFlags=O,function(t){t[t.CO_COLLISION_OBJECT=1]="CO_COLLISION_OBJECT",t[t.CO_RIGID_BODY=2]="CO_RIGID_BODY",t[t.CO_GHOST_OBJECT=4]="CO_GHOST_OBJECT",t[t.CO_SOFT_BODY=8]="CO_SOFT_BODY",t[t.CO_HF_FLUID=16]="CO_HF_FLUID",t[t.CO_USER_TYPE=32]="CO_USER_TYPE",t[t.CO_FEATHERSTONE_LINK=64]="CO_FEATHERSTONE_LINK"}(P||(P={})),y.AmmoCollisionObjectTypes=P,function(t){t[t.ACTIVE_TAG=1]="ACTIVE_TAG",t[t.ISLAND_SLEEPING=2]="ISLAND_SLEEPING",t[t.WANTS_DEACTIVATION=3]="WANTS_DEACTIVATION",t[t.DISABLE_DEACTIVATION=4]="DISABLE_DEACTIVATION",t[t.DISABLE_SIMULATION=5]="DISABLE_SIMULATION"}(B||(B={})),function(t){t[t.CF_ANISOTROPIC_FRICTION_DISABLED=0]="CF_ANISOTROPIC_FRICTION_DISABLED",t[t.CF_ANISOTROPIC_FRICTION=1]="CF_ANISOTROPIC_FRICTION",t[t.CF_ANISOTROPIC_ROLLING_FRICTION=2]="CF_ANISOTROPIC_ROLLING_FRICTION"}(R||(R={})),y.AmmoAnisotropicFrictionFlags=R,function(t){t[t.BT_DISABLE_WORLD_GRAVITY=1]="BT_DISABLE_WORLD_GRAVITY",t[t.BT_ENABLE_GYROPSCOPIC_FORCE=2]="BT_ENABLE_GYROPSCOPIC_FORCE"}(I||(I={})),y.AmmoRigidBodyFlags=I,function(t){t[t.BOX_SHAPE_PROXYTYPE=0]="BOX_SHAPE_PROXYTYPE",t[t.TRIANGLE_SHAPE_PROXYTYPE=1]="TRIANGLE_SHAPE_PROXYTYPE",t[t.TETRAHEDRAL_SHAPE_PROXYTYPE=2]="TETRAHEDRAL_SHAPE_PROXYTYPE",t[t.CONVEX_TRIANGLEMESH_SHAPE_PROXYTYPE=3]="CONVEX_TRIANGLEMESH_SHAPE_PROXYTYPE",t[t.CONVEX_HULL_SHAPE_PROXYTYPE=4]="CONVEX_HULL_SHAPE_PROXYTYPE",t[t.CONVEX_POINT_CLOUD_SHAPE_PROXYTYPE=5]="CONVEX_POINT_CLOUD_SHAPE_PROXYTYPE",t[t.CUSTOM_POLYHEDRAL_SHAPE_TYPE=6]="CUSTOM_POLYHEDRAL_SHAPE_TYPE",t[t.IMPLICIT_CONVEX_SHAPES_START_HERE=7]="IMPLICIT_CONVEX_SHAPES_START_HERE",t[t.SPHERE_SHAPE_PROXYTYPE=8]="SPHERE_SHAPE_PROXYTYPE",t[t.MULTI_SPHERE_SHAPE_PROXYTYPE=9]="MULTI_SPHERE_SHAPE_PROXYTYPE",t[t.CAPSULE_SHAPE_PROXYTYPE=10]="CAPSULE_SHAPE_PROXYTYPE",t[t.CONE_SHAPE_PROXYTYPE=11]="CONE_SHAPE_PROXYTYPE",t[t.CONVEX_SHAPE_PROXYTYPE=12]="CONVEX_SHAPE_PROXYTYPE",t[t.CYLINDER_SHAPE_PROXYTYPE=13]="CYLINDER_SHAPE_PROXYTYPE",t[t.UNIFORM_SCALING_SHAPE_PROXYTYPE=14]="UNIFORM_SCALING_SHAPE_PROXYTYPE",t[t.MINKOWSKI_SUM_SHAPE_PROXYTYPE=15]="MINKOWSKI_SUM_SHAPE_PROXYTYPE",t[t.MINKOWSKI_DIFFERENCE_SHAPE_PROXYTYPE=16]="MINKOWSKI_DIFFERENCE_SHAPE_PROXYTYPE",t[t.BOX_2D_SHAPE_PROXYTYPE=17]="BOX_2D_SHAPE_PROXYTYPE",t[t.CONVEX_2D_SHAPE_PROXYTYPE=18]="CONVEX_2D_SHAPE_PROXYTYPE",t[t.CUSTOM_CONVEX_SHAPE_TYPE=19]="CUSTOM_CONVEX_SHAPE_TYPE",t[t.CONCAVE_SHAPES_START_HERE=20]="CONCAVE_SHAPES_START_HERE",t[t.TRIANGLE_MESH_SHAPE_PROXYTYPE=21]="TRIANGLE_MESH_SHAPE_PROXYTYPE",t[t.SCALED_TRIANGLE_MESH_SHAPE_PROXYTYPE=22]="SCALED_TRIANGLE_MESH_SHAPE_PROXYTYPE",t[t.FAST_CONCAVE_MESH_PROXYTYPE=23]="FAST_CONCAVE_MESH_PROXYTYPE",t[t.TERRAIN_SHAPE_PROXYTYPE=24]="TERRAIN_SHAPE_PROXYTYPE",t[t.GIMPACT_SHAPE_PROXYTYPE=25]="GIMPACT_SHAPE_PROXYTYPE",t[t.MULTIMATERIAL_TRIANGLE_MESH_PROXYTYPE=26]="MULTIMATERIAL_TRIANGLE_MESH_PROXYTYPE",t[t.EMPTY_SHAPE_PROXYTYPE=27]="EMPTY_SHAPE_PROXYTYPE",t[t.STATIC_PLANE_PROXYTYPE=28]="STATIC_PLANE_PROXYTYPE",t[t.CUSTOM_CONCAVE_SHAPE_TYPE=29]="CUSTOM_CONCAVE_SHAPE_TYPE",t[t.CONCAVE_SHAPES_END_HERE=30]="CONCAVE_SHAPES_END_HERE",t[t.COMPOUND_SHAPE_PROXYTYPE=31]="COMPOUND_SHAPE_PROXYTYPE",t[t.SOFTBODY_SHAPE_PROXYTYPE=32]="SOFTBODY_SHAPE_PROXYTYPE",t[t.HFFLUID_SHAPE_PROXYTYPE=33]="HFFLUID_SHAPE_PROXYTYPE",t[t.HFFLUID_BUOYANT_CONVEX_SHAPE_PROXYTYPE=34]="HFFLUID_BUOYANT_CONVEX_SHAPE_PROXYTYPE",t[t.INVALID_SHAPE_PROXYTYPE=35]="INVALID_SHAPE_PROXYTYPE",t[t.MAX_BROADPHASE_COLLISION_TYPES=36]="MAX_BROADPHASE_COLLISION_TYPES"}(v||(v={})),y.AmmoBroadphaseNativeTypes=v,function(t){t[t.DefaultFilter=1]="DefaultFilter",t[t.StaticFilter=2]="StaticFilter",t[t.KinematicFilter=4]="KinematicFilter",t[t.DebrisFilter=8]="DebrisFilter",t[t.SensorTrigger=16]="SensorTrigger",t[t.CharacterFilter=32]="CharacterFilter",t[t.AllFilter=-1]="AllFilter"}(w||(w={})),y.AmmoCollisionFilterGroups=w,function(t){t[t.CD_STATIC_STATIC_REPORTED=1]="CD_STATIC_STATIC_REPORTED",t[t.CD_USE_RELATIVE_CONTACT_BREAKING_THRESHOLD=2]="CD_USE_RELATIVE_CONTACT_BREAKING_THRESHOLD",t[t.CD_DISABLE_CONTACTPOOL_DYNAMIC_ALLOCATION=4]="CD_DISABLE_CONTACTPOOL_DYNAMIC_ALLOCATION"}(D||(D={})),y.AmmoDispatcherFlags=D;var Y={type:"onTriggerEnter",selfCollider:null,otherCollider:null,impl:null},F={type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[],impl:null},M=function(){function t(){this.EMPTY_SHAPE=new y.btEmptyShape,this.TRANSFORM=new y.btTransform,this.TRANSFORM_1=new y.btTransform,this.VECTOR3_0=new y.btVector3,this.VECTOR3_1=new y.btVector3,this.QUAT_0=new y.btQuaternion}return i(t,null,[{key:"instance",get:function(){return null==t._instance&&(t._instance=new t),t._instance}}]),t}();M._instance=void 0;var N=new e,L=new e,H=new s,V=N,G=L,k=function(){var t=s.prototype;function s(){this.id=void 0,this._isEnabled=!1,this.id=s.idCounter++}return t.setMass=function(t){if(this._rigidBody.isDynamic){var i=M.instance.VECTOR3_0;i.setValue(1.6666666269302368,1.6666666269302368,1.6666666269302368);var e=this.impl.getCollisionShape();e.isCompound()?this._sharedBody.bodyCompoundShape.getNumChildShapes()>0&&e.calculateLocalInertia(this._rigidBody.mass,i):e.calculateLocalInertia(this._rigidBody.mass,i),this.impl.setMassProps(t,i),this._wakeUpIfSleep(),this._sharedBody.dirty|=b.BODY_RE_ADD}},t.setType=function(t){var i=this.impl.getCollisionFlags(),e=this._sharedBody.ghost.getCollisionFlags(),s=M.instance.VECTOR3_0;switch(t){case p.DYNAMIC:i&=~O.CF_KINEMATIC_OBJECT,i&=~O.CF_STATIC_OBJECT,this.impl.setCollisionFlags(i),this.setMass(this._rigidBody.mass),this.useGravity(this._rigidBody.useGravity),this.setAllowSleep(this._rigidBody.allowSleep),e&=~O.CF_STATIC_OBJECT,e|=O.CF_KINEMATIC_OBJECT,this._sharedBody.ghost.setCollisionFlags(e);break;case p.KINEMATIC:s.setValue(0,0,0),this.impl.setMassProps(0,s),i|=O.CF_KINEMATIC_OBJECT,i&=~O.CF_STATIC_OBJECT,this.impl.setCollisionFlags(i),this.impl.forceActivationState(B.DISABLE_DEACTIVATION),e|=O.CF_KINEMATIC_OBJECT,e&=~O.CF_STATIC_OBJECT,this._sharedBody.ghost.setCollisionFlags(e);break;case p.STATIC:default:s.setValue(0,0,0),this.impl.setMassProps(0,s),i|=O.CF_STATIC_OBJECT,i&=~O.CF_KINEMATIC_OBJECT,this.impl.setCollisionFlags(i),this.impl.forceActivationState(B.DISABLE_DEACTIVATION),e&=~O.CF_KINEMATIC_OBJECT,e|=O.CF_STATIC_OBJECT,this._sharedBody.ghost.setCollisionFlags(e)}this._sharedBody.dirty|=b.BODY_RE_ADD,this._sharedBody.dirty|=b.GHOST_RE_ADD},t.setLinearDamping=function(){this.impl.setDamping(this._rigidBody.linearDamping,this._rigidBody.angularDamping)},t.setAngularDamping=function(){this.impl.setDamping(this._rigidBody.linearDamping,this._rigidBody.angularDamping)},t.useGravity=function(t){if(this._rigidBody.isDynamic){var i=this.impl.getFlags();t?i&=~I.BT_DISABLE_WORLD_GRAVITY:(this.impl.setGravity(g(M.instance.VECTOR3_0,e.ZERO)),i|=I.BT_DISABLE_WORLD_GRAVITY),this.impl.setFlags(i),this._wakeUpIfSleep(),this._sharedBody.dirty|=b.BODY_RE_ADD}},t.setLinearFactor=function(t){this.impl.setLinearFactor(g(M.instance.VECTOR3_0,t)),this._wakeUpIfSleep()},t.setAngularFactor=function(t){this.impl.setAngularFactor(g(M.instance.VECTOR3_0,t)),this._wakeUpIfSleep()},t.setAllowSleep=function(t){this._rigidBody.isDynamic&&(t?this.impl.forceActivationState(B.ACTIVE_TAG):this.impl.forceActivationState(B.DISABLE_DEACTIVATION),this._wakeUpIfSleep())},i(s,[{key:"isAwake",get:function(){var t=this.impl.getActivationState();return t===B.ACTIVE_TAG||t===B.DISABLE_DEACTIVATION}},{key:"isSleepy",get:function(){return this.impl.getActivationState()===B.WANTS_DEACTIVATION}},{key:"isSleeping",get:function(){return this.impl.getActivationState()===B.ISLAND_SLEEPING}},{key:"isEnabled",get:function(){return this._isEnabled}},{key:"impl",get:function(){return this._sharedBody.body}},{key:"rigidBody",get:function(){return this._rigidBody}},{key:"sharedBody",get:function(){return this._sharedBody}}]),t.clearState=function(){this.impl.clearState()},t.clearVelocity=function(){this.setLinearVelocity(e.ZERO),this.setAngularVelocity(e.ZERO)},t.clearForces=function(){this.impl.clearForces()},t.initialize=function(t){this._rigidBody=t,this._sharedBody=c.instance.physicsWorld.getSharedBody(this._rigidBody.node,this),this._sharedBody.reference=!0},t.onEnable=function(){this._isEnabled=!0,this.setMass(this._rigidBody.mass),this.setType(this._rigidBody.type),this.setAllowSleep(this._rigidBody.allowSleep),this.setLinearDamping(this._rigidBody.linearDamping),this.setAngularDamping(this._rigidBody.angularDamping),this.setLinearFactor(this._rigidBody.linearFactor),this.setAngularFactor(this._rigidBody.angularFactor),this.useGravity(this._rigidBody.useGravity),this._sharedBody.bodyEnabled=!0},t.onDisable=function(){this._isEnabled=!1,this._sharedBody.bodyEnabled=!1},t.onDestroy=function(){this._sharedBody.reference=!1,this._rigidBody=null,this._sharedBody=null},t.wakeUp=function(t){void 0===t&&(t=!0),this.impl.activate(t)},t.sleep=function(){return this.impl.wantsSleeping()},t.setSleepThreshold=function(t){this._wakeUpIfSleep(),this.impl.setSleepingThresholds(t,t)},t.getSleepThreshold=function(){return this.impl.getLinearSleepingThreshold()},t.getLinearVelocity=function(t){return C(t,this.impl.getLinearVelocity())},t.setLinearVelocity=function(t){this._wakeUpIfSleep(),g(this.impl.getLinearVelocity(),t)},t.getAngularVelocity=function(t){return C(t,this.impl.getAngularVelocity())},t.setAngularVelocity=function(t){this._wakeUpIfSleep(),g(this.impl.getAngularVelocity(),t)},t.applyLocalForce=function(t,i){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var s=this._sharedBody.node.worldRotation,o=e.transformQuat(V,t,s),n=i?e.transformQuat(G,i,s):e.ZERO;this.impl.applyForce(g(M.instance.VECTOR3_0,o),g(M.instance.VECTOR3_1,n))},t.applyLocalTorque=function(t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),e.transformQuat(V,t,this._sharedBody.node.worldRotation),this.impl.applyTorque(g(M.instance.VECTOR3_0,V))},t.applyLocalImpulse=function(t,i){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var s=this._sharedBody.node.worldRotation,o=e.transformQuat(V,t,s),n=i?e.transformQuat(G,i,s):e.ZERO;this.impl.applyImpulse(g(M.instance.VECTOR3_0,o),g(M.instance.VECTOR3_1,n))},t.applyForce=function(t,i){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var s=i||e.ZERO;this.impl.applyForce(g(M.instance.VECTOR3_0,t),g(M.instance.VECTOR3_1,s))},t.applyTorque=function(t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),this.impl.applyTorque(g(M.instance.VECTOR3_0,t))},t.applyImpulse=function(t,i){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep();var s=i||e.ZERO;this.impl.applyImpulse(g(M.instance.VECTOR3_0,t),g(M.instance.VECTOR3_1,s))},t.getGroup=function(){return this._sharedBody.collisionFilterGroup},t.setGroup=function(t){this._sharedBody.collisionFilterGroup=t},t.addGroup=function(t){this._sharedBody.collisionFilterGroup|=t},t.removeGroup=function(t){this._sharedBody.collisionFilterGroup&=~t},t.getMask=function(){return this._sharedBody.collisionFilterMask},t.setMask=function(t){this._sharedBody.collisionFilterMask=t},t.addMask=function(t){this._sharedBody.collisionFilterMask|=t},t.removeMask=function(t){this._sharedBody.collisionFilterMask&=~t},t._wakeUpIfSleep=function(){this.isAwake||this.impl.activate(!0)},s}();k.idCounter=0;var x=function(){function t(){}return i(t,null,[{key:"bodyStructs",get:function(){return this.bodyAndGhosts}},{key:"ghostStructs",get:function(){return this.bodyAndGhosts}}]),t}();x.bodyAndGhosts={};var X=N,U=H,W=0,j=function(){function t(i,e){this.id=void 0,this.node=void 0,this.wrappedWorld=void 0,this.wrappedJoints0=[],this.wrappedJoints1=[],this.dirty=0,this._collisionFilterGroup=c.PhysicsGroup.DEFAULT,this._collisionFilterMask=-1,this.ref=0,this.bodyIndex=-1,this.ghostIndex=-1,this._wrappedBody=null,this.id=t.idCounter++,this.wrappedWorld=e,this.node=i}t.getSharedBody=function(i,e,s){var o,n=i.uuid;if(t.sharedBodesMap.has(n))o=t.sharedBodesMap.get(n);else{o=new t(i,e);var r=_.DEFAULT,a=c.instance.collisionMatrix[r];o._collisionFilterGroup=r,o._collisionFilterMask=a,t.sharedBodesMap.set(i.uuid,o)}if(s){o._wrappedBody=s;var l=s.rigidBody.group,h=c.instance.collisionMatrix[l];o._collisionFilterGroup=l,o._collisionFilterMask=h}return o},i(t,[{key:"wrappedBody",get:function(){return this._wrappedBody}},{key:"bodyCompoundShape",get:function(){return this.bodyStruct.shape}},{key:"ghostCompoundShape",get:function(){return this.ghostStruct.shape}},{key:"body",get:function(){return this.bodyStruct.body}},{key:"ghost",get:function(){return this.ghostStruct.ghost}},{key:"collisionFilterGroup",get:function(){return this._collisionFilterGroup},set:function(t){t!==this._collisionFilterGroup&&(this._collisionFilterGroup=t,this.dirty|=b.BODY_RE_ADD,this.dirty|=b.GHOST_RE_ADD)}},{key:"collisionFilterMask",get:function(){return this._collisionFilterMask},set:function(t){t!==this._collisionFilterMask&&(this._collisionFilterMask=t,this.dirty|=b.BODY_RE_ADD,this.dirty|=b.GHOST_RE_ADD)}},{key:"bodyStruct",get:function(){return this._instantiateBodyStruct(),this._bodyStruct}},{key:"ghostStruct",get:function(){return this._instantiateGhostStruct(),this._ghostStruct}},{key:"bodyEnabled",set:function(t){t?this.bodyIndex<0&&(this.bodyIndex=this.wrappedWorld.bodies.length,this.body.clearState(),this.wrappedWorld.addSharedBody(this),this.syncInitialBody()):this.bodyIndex>=0&&(0===this.bodyStruct.wrappedShapes.length&&null==this.wrappedBody||0===this.bodyStruct.wrappedShapes.length&&null!=this.wrappedBody&&!this.wrappedBody.isEnabled||0===this.bodyStruct.wrappedShapes.length&&null!=this.wrappedBody&&!this.wrappedBody.rigidBody.enabledInHierarchy)&&(this.body.clearState(),this.bodyIndex=-1,this.wrappedWorld.removeSharedBody(this))}},{key:"ghostEnabled",set:function(t){t?this.ghostIndex<0&&this.ghostStruct.wrappedShapes.length>0&&(this.ghostIndex=1,this.wrappedWorld.addGhostObject(this),this.syncInitialGhost()):this.ghostIndex>=0&&0===this.ghostStruct.wrappedShapes.length&&this.ghost&&(this.ghostIndex=-1,this.wrappedWorld.removeGhostObject(this))}},{key:"reference",set:function(t){t?this.ref++:this.ref--,0===this.ref&&this.destroy()}}]);var e=t.prototype;return e._instantiateBodyStruct=function(){if(!this._bodyStruct){var t=new y.btTransform;t.setIdentity(),g(t.getOrigin(),this.node.worldPosition);var i=new y.btQuaternion;E(i,this.node.worldRotation),t.setRotation(i);var e=new y.btDefaultMotionState(t),s=new y.btVector3(1.6666666269302368,1.6666666269302368,1.6666666269302368),o=new y.btCompoundShape,n=0;this._wrappedBody&&this._wrappedBody.rigidBody.isDynamic&&(n=this._wrappedBody.rigidBody.mass),0===n&&s.setValue(0,0,0);var r=new y.btRigidBodyConstructionInfo(n,e,M.instance.EMPTY_SHAPE,s),a=new y.btRigidBody(r),l=c.instance.sleepThreshold;a.setSleepingThresholds(l,l),this._bodyStruct={id:W++,body:a,localInertia:s,motionState:e,startTransform:t,shape:o,rbInfo:r,worldQuat:i,wrappedShapes:[],useCompound:!1},x.bodyStructs["KEY"+this._bodyStruct.id]=this._bodyStruct,this.body.setUserIndex2(2),this.body.setUserIndex(this._bodyStruct.id),0===n&&this.body.setActivationState(B.DISABLE_DEACTIVATION),y.CC_CONFIG.ignoreSelfBody&&this._ghostStruct&&this.ghost.setIgnoreCollisionCheck(this.body,!0)}},e._instantiateGhostStruct=function(){if(!this._ghostStruct){var t=new y.btCollisionObject,i=new y.btCompoundShape;t.setCollisionShape(i),t.setCollisionFlags(O.CF_STATIC_OBJECT|O.CF_NO_CONTACT_RESPONSE),this._ghostStruct={id:W++,ghost:t,shape:i,worldQuat:new y.btQuaternion,wrappedShapes:[]},x.ghostStructs["KEY"+this._ghostStruct.id]=this._ghostStruct,this.ghost.setUserIndex2(2),this.ghost.setUserIndex(this._ghostStruct.id),this.ghost.setActivationState(B.DISABLE_DEACTIVATION),y.CC_CONFIG.ignoreSelfBody&&this._bodyStruct&&this.ghost.setIgnoreCollisionCheck(this.body,!0)}},e.addShape=function(t,i){function e(t,i){t.body.setCollisionShape(i),t.dirty|=b.BODY_RE_ADD,t._wrappedBody&&t._wrappedBody.isEnabled&&t._wrappedBody.setMass(t._wrappedBody.rigidBody.mass)}if(i)this.ghostStruct.wrappedShapes.indexOf(t)<0&&(this.ghostStruct.wrappedShapes.push(t),t.setCompound(this.ghostCompoundShape),this.ghostEnabled=!0);else if(this.bodyStruct.wrappedShapes.indexOf(t)<0){if(this.bodyStruct.wrappedShapes.push(t),this.bodyStruct.useCompound)t.setCompound(this.bodyCompoundShape);else{var s=this.bodyStruct.wrappedShapes.length;if(1!==s||t.needCompound()){this.bodyStruct.useCompound=!0;for(var o=0;o<s;o++)this.bodyStruct.wrappedShapes[o].setCompound(this.bodyCompoundShape);e(this,this.bodyStruct.shape)}else e(this,t.impl)}this.bodyEnabled=!0}},e.removeShape=function(t,i){if(i){var e=this.ghostStruct.wrappedShapes.indexOf(t);e>=0&&(o(this.ghostStruct.wrappedShapes,e),t.setCompound(null),this.ghostEnabled=!1)}else{var s=this.bodyStruct.wrappedShapes.indexOf(t);s>=0&&(this.bodyStruct.useCompound?t.setCompound(null):this.body.setCollisionShape(M.instance.EMPTY_SHAPE),this.body.activate(!0),this.dirty|=b.BODY_RE_ADD,o(this.bodyStruct.wrappedShapes,s),this.bodyEnabled=!1)}},e.addJoint=function(t,i){i?this.wrappedJoints1.indexOf(t)<0&&this.wrappedJoints1.push(t):this.wrappedJoints0.indexOf(t)<0&&this.wrappedJoints0.push(t)},e.removeJoint=function(t,i){if(i){var e=this.wrappedJoints1.indexOf(t);e>=0&&o(this.wrappedJoints1,e)}else{var s=this.wrappedJoints0.indexOf(t);s>=0&&o(this.wrappedJoints0,s)}},e.updateDirty=function(){this.dirty&&(this.bodyIndex>=0&&this.dirty&b.BODY_RE_ADD&&this.updateBodyByReAdd(),this.ghostIndex>=0&&this.dirty&b.GHOST_RE_ADD&&this.updateGhostByReAdd(),this.dirty=0)},e.syncSceneToPhysics=function(){if(this.node.hasChangedFlags){var t=this.body.getWorldTransform();if(g(t.getOrigin(),this.node.worldPosition),E(this.bodyStruct.worldQuat,this.node.worldRotation),t.setRotation(this.bodyStruct.worldQuat),this.node.hasChangedFlags&d.SCALE&&this.syncBodyScale(),this.body.isKinematicObject()){var i=this.body.getMotionState();i&&i.setWorldTransform(t)}else this.isBodySleeping()&&this.body.activate()}},e.syncPhysicsToScene=function(){if(!this.body.isStaticOrKinematicObject()&&!this.isBodySleeping()){var t=this.bodyStruct.startTransform;this.body.getMotionState().getWorldTransform(t),this.node.worldPosition=C(X,t.getOrigin()),t.getBasis().getRotation(this.bodyStruct.worldQuat),this.node.worldRotation=T(U,this.bodyStruct.worldQuat);var i=this.ghost.getWorldTransform();g(i.getOrigin(),this.node.worldPosition),E(this.ghostStruct.worldQuat,this.node.worldRotation),i.setRotation(this.ghostStruct.worldQuat)}},e.syncSceneToGhost=function(){if(this.node.hasChangedFlags){var t=this.ghost.getWorldTransform();g(t.getOrigin(),this.node.worldPosition),E(this.ghostStruct.worldQuat,this.node.worldRotation),t.setRotation(this.ghostStruct.worldQuat),this.node.hasChangedFlags&d.SCALE&&this.syncGhostScale(),this.ghost.activate()}},e.syncInitialBody=function(){var t=this.body.getWorldTransform();g(t.getOrigin(),this.node.worldPosition),E(this.bodyStruct.worldQuat,this.node.worldRotation),t.setRotation(this.bodyStruct.worldQuat),this.syncBodyScale(),this.body.activate()},e.syncInitialGhost=function(){var t=this.ghost.getWorldTransform();g(t.getOrigin(),this.node.worldPosition),E(this.ghostStruct.worldQuat,this.node.worldRotation),t.setRotation(this.ghostStruct.worldQuat),this.syncGhostScale(),this.ghost.activate()},e.syncBodyScale=function(){for(var t=0;t<this.bodyStruct.wrappedShapes.length;t++)this.bodyStruct.wrappedShapes[t].setScale();for(var i=0;i<this.wrappedJoints0.length;i++)this.wrappedJoints0[i].updateScale0();for(var e=0;e<this.wrappedJoints1.length;e++)this.wrappedJoints1[e].updateScale1()},e.syncGhostScale=function(){for(var t=0;t<this.ghostStruct.wrappedShapes.length;t++)this.ghostStruct.wrappedShapes[t].setScale()},e.updateBodyByReAdd=function(){this.bodyIndex>=0&&(this.wrappedWorld.removeSharedBody(this),this.bodyIndex=this.wrappedWorld.bodies.length,this.wrappedWorld.addSharedBody(this))},e.updateGhostByReAdd=function(){this.ghostIndex>=0&&(this.wrappedWorld.removeGhostObject(this),this.ghostIndex=this.wrappedWorld.ghosts.length,this.wrappedWorld.addGhostObject(this))},e.destroy=function(){if(t.sharedBodesMap.delete(this.node.uuid),this.node=null,this.wrappedWorld=null,this._bodyStruct){var i=this._bodyStruct;y.destroy(i.localInertia),y.destroy(i.worldQuat),y.destroy(i.startTransform),y.destroy(i.motionState),y.destroy(i.rbInfo),y.destroy(i.shape),m(i.shape,y.btCollisionShape),y.castObject(i.body,y.btRigidBody).wrapped=null,m(i.body,y.btRigidBody),m(i.body,y.btCollisionObject);var e="KEY"+i.id;delete x.bodyStructs[e],this._bodyStruct=null}if(this._ghostStruct){var s=this._ghostStruct;y.destroy(s.worldQuat),y.destroy(s.shape),m(s.shape,y.btCollisionShape),y.destroy(s.ghost);var o="KEY"+s.id;delete x.bodyStructs[o],this._ghostStruct=null}},e.isBodySleeping=function(){return this.body.getActivationState()===B.ISLAND_SLEEPING},t}();j.idCounter=0,j.sharedBodesMap=new Map;var J=function(){function t(t){this.impl=null,this.event=void 0,this.event=t}i(t,[{key:"isBodyA",get:function(){var t=this.event.selfCollider.shape.sharedBody.body,i=this.event.impl.getBody0();return Ammo.compare(i,t)}}]);var o=t.prototype;return o.getLocalPointOnA=function(t){this.impl&&C(t,this.impl.m_localPointA)},o.getLocalPointOnB=function(t){this.impl&&C(t,this.impl.m_localPointB)},o.getWorldPointOnA=function(t){this.impl&&C(t,this.impl.m_positionWorldOnA)},o.getWorldPointOnB=function(t){this.impl&&C(t,this.impl.m_positionWorldOnB)},o.getLocalNormalOnA=function(t){if(this.impl){C(t,this.impl.m_normalWorldOnB),this.isBodyA||e.negate(t,t);var i=H,o=M.instance.QUAT_0;this.event.impl.getBody0().getWorldTransform().getBasis().getRotation(o),T(i,o),s.conjugate(i,i),e.transformQuat(t,t,i)}},o.getLocalNormalOnB=function(t){if(this.impl){var i=H,o=M.instance.QUAT_0;this.event.impl.getBody1().getWorldTransform().getBasis().getRotation(o),T(i,o),s.conjugate(i,i),C(t,this.impl.m_normalWorldOnB),e.transformQuat(t,t,i)}},o.getWorldNormalOnA=function(t){this.impl&&(C(t,this.impl.m_normalWorldOnB),this.isBodyA||e.negate(t,t))},o.getWorldNormalOnB=function(t){this.impl&&C(t,this.impl.m_normalWorldOnB)},t}(),K=[],z=N,Q=L,Z=function(){var t=s.prototype;function s(){this._btWorld=void 0,this._btBroadphase=void 0,this._btSolver=void 0,this._btDispatcher=void 0,this._btCollisionConfiguration=void 0,this.bodies=[],this.ghosts=[],this.constraints=[],this.triggerArrayMat=new f,this.collisionArrayMat=new f,this.contactsDic=new S,this.oldContactsDic=new S,this._btCollisionConfiguration=new y.btDefaultCollisionConfiguration,this._btDispatcher=new y.btCollisionDispatcher(this._btCollisionConfiguration),this._btBroadphase=new y.btDbvtBroadphase,this._btSolver=new y.btSequentialImpulseConstraintSolver,this._btWorld=new y.btDiscreteDynamicsWorld(this._btDispatcher,this._btBroadphase,this._btSolver,this._btCollisionConfiguration),this._btWorld.getPairCache().setOverlapFilterCallback(new y.ccOverlapFilterCallback);var t=M.instance.VECTOR3_0;t.setValue(0,-10,0),this._btWorld.setGravity(t),s.closeHitCB||(s.closeHitCB=new y.ClosestRayResultCallback(t,t)),s.allHitsCB||(s.allHitsCB=new y.AllHitsRayResultCallback(t,t)),s.closeHitCB.setUseCC(!0),s.allHitsCB.setUseCC(!0)}return t.setAllowSleep=function(){},t.setDefaultMaterial=function(){},t.setGravity=function(t){var i=M.instance.VECTOR3_0;g(i,t),this._btWorld.setGravity(i)},i(s,[{key:"impl",get:function(){return this._btWorld}}]),t.destroy=function(){(this.constraints.length||this.bodies.length)&&n("You should destroy all physics component first."),y.destroy(this._btWorld),y.destroy(this._btSolver),y.destroy(this._btBroadphase),y.destroy(this._btDispatcher),y.destroy(this._btCollisionConfiguration),this._btCollisionConfiguration=null,this._btDispatcher=null,this._btBroadphase=null,this._btSolver=null,this._btWorld=null,this.bodies=null,this.ghosts=null,this.constraints=null,this.triggerArrayMat=null,this.collisionArrayMat=null,this.contactsDic=null,this.oldContactsDic=null,K.length=0},t.step=function(t,i,e){if(void 0===e&&(e=0),0!==this.bodies.length||0!==this.ghosts.length){void 0===i&&(i=t),this._btWorld.stepSimulation(i,e,t);for(var s=0;s<this.bodies.length;s++)this.bodies[s].syncPhysicsToScene()}},t.syncSceneToPhysics=function(){for(var t=0;t<this.ghosts.length;t++)this.ghosts[t].updateDirty(),this.ghosts[t].syncSceneToGhost();for(var i=0;i<this.bodies.length;i++)this.bodies[i].updateDirty(),this.bodies[i].syncSceneToPhysics()},t.syncAfterEvents=function(){this.syncSceneToPhysics()},t.raycast=function(t,i,o,n){var r=s.allHitsCB,a=g(r.m_rayFromWorld,t.o);t.computeHit(z,i.maxDistance);var l=g(r.m_rayToWorld,z);r.m_collisionFilterGroup=-1,r.m_collisionFilterMask=i.mask,r.m_closestHitFraction=1,r.m_shapePart=-1,r.m_collisionObject=null,r.m_shapeParts.clear(),r.m_hitFractions.clear(),r.m_collisionObjects.clear();var h=r.m_hitPointWorld,d=r.m_hitNormalWorld;if(h.clear(),d.clear(),this._btWorld.rayTest(a,l,r),r.hasHit()){for(var c=0,u=r.m_collisionObjects.size();c<u;c++){var p=r.m_collisionObjects.at(c),_=p.getCollisionShape(),S=void 0;if(_.isCompound()){var y=r.m_shapeParts.at(c),f=p.getUserIndex();S=x.bodyAndGhosts["KEY"+f].wrappedShapes[y]}else S=_.wrapped;C(z,h.at(c)),C(Q,d.at(c));var E=e.distance(t.o,z),T=o.add();T._assign(z,E,S.collider,Q),n.push(T)}return!0}return!1},t.raycastClosest=function(t,i,o){var n=s.closeHitCB,r=g(n.m_rayFromWorld,t.o);t.computeHit(z,i.maxDistance);var a=g(n.m_rayToWorld,z);if(n.m_collisionFilterGroup=-1,n.m_collisionFilterMask=i.mask,n.m_closestHitFraction=1,n.m_collisionObject=null,this._btWorld.rayTest(r,a,n),n.hasHit()){var l,h=n.m_collisionObject,d=h.getCollisionShape();if(d.isCompound()){var c=h.getUserIndex(),u=x.bodyAndGhosts["KEY"+c],p=n.m_shapePart;l=u.wrappedShapes[p]}else l=d.wrapped;C(z,n.m_hitPointWorld),C(Q,n.m_hitNormalWorld);var _=e.distance(t.o,z);return o._assign(z,_,l.collider,Q),!0}return!1},t.getSharedBody=function(t,i){return j.getSharedBody(t,this,i)},t.addSharedBody=function(t){this.bodies.indexOf(t)<0&&(this.bodies.push(t),this._btWorld.addRigidBody(t.body,t.collisionFilterGroup,t.collisionFilterMask))},t.removeSharedBody=function(t){var i=this.bodies.indexOf(t);i>=0&&(o(this.bodies,i),this._btWorld.removeRigidBody(t.body))},t.addGhostObject=function(t){this.ghosts.indexOf(t)<0&&(this.ghosts.push(t),this._btWorld.addCollisionObject(t.ghost,t.collisionFilterGroup,t.collisionFilterMask))},t.removeGhostObject=function(t){var i=this.ghosts.indexOf(t);i>=0&&(o(this.ghosts,i),this._btWorld.removeCollisionObject(t.ghost))},t.addConstraint=function(t){var i=this.constraints.indexOf(t);i<0&&(this.constraints.push(t),this._btWorld.addConstraint(t.impl,!t.constraint.enableCollision),t.index=i)},t.removeConstraint=function(t){var i=this.constraints.indexOf(t);i>=0&&(this.constraints.splice(i,1),this._btWorld.removeConstraint(t.impl),t.index=-1)},t.emitEvents=function(){for(var t=this._btDispatcher.getNumManifolds(),i=0;i<t;i++){var e=this._btDispatcher.getManifoldByIndexInternal(i),s=e.getBody0(),o=e.getBody1();if(!s.useCharacter&&!o.useCharacter)for(var n=s.useCCD||o.useCCD,r=e.getNumContacts(),a=0;a<r;a++){var l=e.getContactPoint(a),h=l.getShape0(),d=l.getShape1(),c=void 0,u=void 0;if(n){if(s.useCCD){var p=s.wrapped.sharedBody;if(!p)continue;c=p.bodyStruct.wrappedShapes[0]}else{var _=s.getCollisionShape();if(_.isCompound())continue;c=_.wrapped}if(o.useCCD){var S=o.wrapped.sharedBody;if(!S)continue;u=S.bodyStruct.wrappedShapes[0]}else{var f=o.getCollisionShape();if(f.isCompound())continue;u=f.wrapped}}else c=h.isCompound()?y.castObject(h,y.btCompoundShape).getChildShape(l.m_index0).wrapped:h.wrapped,u=d.isCompound()?y.castObject(d,y.btCompoundShape).getChildShape(l.m_index1).wrapped:d.wrapped;if(c.collider.needTriggerEvent||u.collider.needTriggerEvent||c.collider.needCollisionEvent||u.collider.needCollisionEvent){var g=this.contactsDic.get(c.id,u.id);null==g&&(g=this.contactsDic.set(c.id,u.id,{shape0:c,shape1:u,contacts:[],impl:e})),g.contacts.push(l)}}}for(var C=this.contactsDic.getLength();C--;){K.push.apply(K,F.contacts),F.contacts.length=0;var E=this.contactsDic.getKeyByIndex(C),T=this.contactsDic.getDataByKey(E),m=T.shape0,A=T.shape1;this.oldContactsDic.set(m.id,A.id,T);var b=m.collider,O=A.collider;if(b&&O){if(b.isTrigger||O.isTrigger)this.triggerArrayMat.get(m.id,A.id)?Y.type="onTriggerStay":(Y.type="onTriggerEnter",this.triggerArrayMat.set(m.id,A.id,!0)),Y.impl=T.impl,Y.selfCollider=b,Y.otherCollider=O,b.emit(Y.type,Y),Y.selfCollider=O,Y.otherCollider=b,O.emit(Y.type,Y);else{var P=b.attachedRigidBody,B=O.attachedRigidBody;if(P&&B){if(P.isSleeping&&B.isSleeping)continue}else if(null==P&&B){if(B.isSleeping)continue}else if(null==B&&P&&P.isSleeping)continue;this.collisionArrayMat.get(m.id,A.id)?F.type="onCollisionStay":(F.type="onCollisionEnter",this.collisionArrayMat.set(m.id,A.id,!0));for(var R=0;R<T.contacts.length;R++){var I=T.contacts[R];if(K.length>0){var v=K.pop();v.impl=I,F.contacts.push(v)}else{var w=new J(F);w.impl=I,F.contacts.push(w)}}F.impl=T.impl,F.selfCollider=b,F.otherCollider=O,b.emit(F.type,F),F.selfCollider=O,F.otherCollider=b,O.emit(F.type,F)}null==this.oldContactsDic.get(m.id,A.id)&&this.oldContactsDic.set(m.id,A.id,T)}}for(var D=this.oldContactsDic.getLength();D--;){var M=this.oldContactsDic.getKeyByIndex(D),N=this.oldContactsDic.getDataByKey(M),L=N.shape0,H=N.shape1,V=L.collider,G=H.collider;if(V&&G){var k=V.isTrigger||G.isTrigger;null==this.contactsDic.getDataByKey(M)&&(k?this.triggerArrayMat.get(L.id,H.id)&&(Y.type="onTriggerExit",Y.selfCollider=V,Y.otherCollider=G,V.emit(Y.type,Y),Y.selfCollider=G,Y.otherCollider=V,G.emit(Y.type,Y),this.triggerArrayMat.set(L.id,H.id,!1),this.oldContactsDic.set(L.id,H.id,null)):this.collisionArrayMat.get(L.id,H.id)&&(K.push.apply(K,F.contacts),F.contacts.length=0,F.type="onCollisionExit",F.selfCollider=V,F.otherCollider=G,V.emit(F.type,F),F.selfCollider=G,F.otherCollider=V,G.emit(F.type,F),this.collisionArrayMat.set(L.id,H.id,!1),this.oldContactsDic.set(L.id,H.id,null)))}}this.contactsDic.reset()},s}();Z.closeHitCB=void 0,Z.allHitsCB=void 0;var q=N,$=function(){var t=o.prototype;function o(t){this.id=void 0,this.type=void 0,this._index=-1,this._isEnabled=!1,this._isBinding=!1,this._isTrigger=!1,this._btCompound=null,this.transform=void 0,this.quat=void 0,this.scale=void 0,this.type=t,this.id=o.idCounter++,this.quat=new y.btQuaternion,this.transform=new y.btTransform,this.transform.setIdentity(),this.scale=new y.btVector3(1,1,1)}return t.updateEventListener=function(){},t.setMaterial=function(t){!this._isTrigger&&this._isEnabled&&t&&(this._btCompound?this._btCompound.setMaterial(this._index,t.friction,t.restitution,t.rollingFriction,t.spinningFriction,2):(this._sharedBody.body.setFriction(t.friction),this._sharedBody.body.setRestitution(t.restitution),this._sharedBody.body.setRollingFriction(t.rollingFriction),this._sharedBody.body.setSpinningFriction(t.spinningFriction),this._sharedBody.body.setUserIndex2(2)))},t.setCenter=function(t){e.copy(q,t),q.multiply(this._collider.node.worldScale),g(this.transform.getOrigin(),q),this.updateCompoundTransform()},t.setAsTrigger=function(t){this._isTrigger!==t&&(this._isEnabled&&(this._sharedBody.removeShape(this,!t),this._sharedBody.addShape(this,t)),this._isTrigger=t)},i(o,[{key:"attachedRigidBody",get:function(){return this._sharedBody.wrappedBody?this._sharedBody.wrappedBody.rigidBody:null}},{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"index",get:function(){return this._index}}]),t.getAABB=function(t){var i=M.instance.TRANSFORM;i.setIdentity(),i.setRotation(E(M.instance.QUAT_0,this._collider.node.worldRotation));var s=M.instance.VECTOR3_0,o=M.instance.VECTOR3_1;this._btShape.getAabb(i,s,o),t.halfExtents.set((o.x()-s.x())/2,(o.y()-s.y())/2,(o.z()-s.z())/2),e.add(t.center,this._collider.node.worldPosition,this._collider.center)},t.getBoundingSphere=function(t){t.radius=this._btShape.getLocalBoundingSphere(),e.add(t.center,this._collider.node.worldPosition,this._collider.center)},t.initialize=function(t){this._collider=t,this._isBinding=!0,this.onComponentSet(),this.setWrapper(),this._sharedBody=c.instance.physicsWorld.getSharedBody(this._collider.node),this._sharedBody.reference=!0},t.onComponentSet=function(){},t.onLoad=function(){this.setCenter(this._collider.center),this.setAsTrigger(this._collider.isTrigger)},t.onEnable=function(){this._isEnabled=!0,this._sharedBody.addShape(this,this._isTrigger),this.setMaterial(this.collider.sharedMaterial)},t.onDisable=function(){this._isEnabled=!1,this._sharedBody.removeShape(this,this._isTrigger)},t.onDestroy=function(){this._sharedBody.reference=!1,this._btCompound=null,this._collider=null,y.castObject(this._btShape,y.btCollisionShape).wrapped=null,y.destroy(this.quat),y.destroy(this.scale),y.destroy(this.transform),this._btShape!==M.instance.EMPTY_SHAPE&&(y.destroy(this._btShape),m(this._btShape,y.btCollisionShape)),this._btShape=null,this.transform=null,this.quat=null,this.scale=null},t.getGroup=function(){return this._sharedBody.collisionFilterGroup},t.setGroup=function(t){this._sharedBody.collisionFilterGroup=t},t.addGroup=function(t){this._sharedBody.collisionFilterGroup|=t},t.removeGroup=function(t){this._sharedBody.collisionFilterGroup&=~t},t.getMask=function(){return this._sharedBody.collisionFilterMask},t.setMask=function(t){this._sharedBody.collisionFilterMask=t},t.addMask=function(t){this._sharedBody.collisionFilterMask|=t},t.removeMask=function(t){this._sharedBody.collisionFilterMask&=~t},t.setCompound=function(t){this._btCompound&&(this._btCompound.removeChildShape(this._btShape),this._index=-1),t&&(this._index=t.getNumChildShapes(),t.addChildShape(this.transform,this._btShape)),this._btCompound=t},t.setWrapper=function(){y.castObject(this._btShape,y.btCollisionShape).wrapped=this},t.setScale=function(){this.setCenter(this._collider.center)},t.updateCompoundTransform=function(){this._btCompound?this._btCompound.updateChildTransform(this.index,this.transform,!0):this._isEnabled&&!this._isTrigger&&this._sharedBody&&!this._sharedBody.bodyStruct.useCompound&&(this._sharedBody.dirty|=b.BODY_RE_ADD)},t.needCompound=function(){return this.type===v.TERRAIN_SHAPE_PROXYTYPE||!this._collider.center.equals(e.ZERO)},t.debugTransform=function(t){var i;null==o._debugTransform&&(o._debugTransform=new y.btTransform),i=this._isTrigger?this._sharedBody.ghost.getWorldTransform():this._sharedBody.body.getWorldTransform();var n=this.transform;o._debugTransform.setIdentity(),o._debugTransform.op_mul(i).op_mul(n);var r=o._debugTransform.getOrigin();t.worldPosition=new e(r.x(),r.y(),r.z());var a=o._debugTransform.getRotation();t.worldRotation=new s(a.x(),a.y(),a.z(),a.w());var l=this.impl.getLocalScaling();t.scale=new e(l.x(),l.y(),l.z())},o}();$.idCounter=0,$._debugTransform=void 0;var tt=function(t){r(o,t);var s=o.prototype;function o(){return t.call(this,v.BOX_SHAPE_PROXYTYPE)||this}return s.setSize=function(t){var i=N;e.multiplyScalar(i,t,.5);var s=M.instance.VECTOR3_0;g(s,i),this.impl.setUnscaledHalfExtents(s),this.updateCompoundTransform()},i(o,[{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),s.onComponentSet=function(){var t=this.collider.size,i=M.instance.VECTOR3_0;i.setValue(t.x/2,t.y/2,t.z/2),this._btShape=new y.btBoxShape(i),this.setScale()},s.setScale=function(){t.prototype.setScale.call(this),g(this.scale,this._collider.node.worldScale),this._btShape.setLocalScaling(this.scale),this.updateCompoundTransform()},o}($),it=function(t){r(s,t);var e=s.prototype;function s(){return t.call(this,v.SPHERE_SHAPE_PROXYTYPE)||this}return e.setRadius=function(t){this.impl.setUnscaledRadius(t),this.updateCompoundTransform()},i(s,[{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),e.onComponentSet=function(){this._btShape=new y.btSphereShape(this.collider.radius),this.setScale()},e.setScale=function(){t.prototype.setScale.call(this);var i=N,e=this._collider.node.worldScale,s=Math.abs(e.x),o=Math.abs(e.y),n=Math.abs(e.z),r=Math.max(Math.max(s,o),n);i.set(r,r,r),g(this.scale,i),this._btShape.setLocalScaling(this.scale),this.updateCompoundTransform()},s}($),et=function(t){r(s,t);var e=s.prototype;function s(){return t.call(this,v.CAPSULE_SHAPE_PROXYTYPE)||this}return e.setCylinderHeight=function(){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)},e.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)},e.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.cylinderHeight,this.collider.direction,this._collider.node.worldScale)},i(s,[{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),e.onComponentSet=function(){this._btShape=new y.btCapsuleShape(.5,1),this.setRadius(this.collider.radius)},e.setScale=function(){t.prototype.setScale.call(this),this.setRadius(this.collider.radius)},e.updateProperties=function(t,i,e,s){var o=s,n=e;if(1===n){var r=t*Math.abs(a(o.x,o.z)),l=i/2*Math.abs(o.y);this.impl.updateProp(r,l,n)}else if(0===n){var h=t*Math.abs(a(o.y,o.z)),d=i/2*Math.abs(o.x);this.impl.updateProp(h,d,n)}else{var c=t*Math.abs(a(o.x,o.y)),u=i/2*Math.abs(o.z);this.impl.updateProp(c,u,n)}this.updateCompoundTransform()},s}($),st=function(t){r(s,t);var e=s.prototype;function s(){var i;return(i=t.call(this,v.TRIANGLE_MESH_SHAPE_PROXYTYPE)||this).refBtTriangleMesh=null,i}return e.setMesh=function(t){if(this._isBinding)if(null!=this._btShape&&this._btShape!==M.instance.EMPTY_SHAPE)l(9620);else{var i=t;if(i&&i.renderingSubMeshes.length>0){var e=this._getBtTriangleMesh(i);this.collider.convex?this._btShape=new y.btConvexTriangleMeshShape(e,!0):this._btShape=new y.btBvhTriangleMeshShape(e,!0,!0),g(this.scale,this._collider.node.worldScale),this._btShape.setMargin(.01),this._btShape.setLocalScaling(this.scale),this.setWrapper(),this.setCompound(this._btCompound)}else this._btShape=M.instance.EMPTY_SHAPE}},i(s,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._btShape}}]),e.onComponentSet=function(){this.setMesh(this.collider.mesh)},e.onDestroy=function(){this.refBtTriangleMesh&&y.destroy(this.refBtTriangleMesh),t.prototype.onDestroy.call(this)},e.setCompound=function(i){t.prototype.setCompound.call(this,i),this.impl.setUserIndex(this._index)},e.setScale=function(){t.prototype.setScale.call(this),g(this.scale,this._collider.node.worldScale),this._btShape.setLocalScaling(this.scale),this.updateCompoundTransform()},e._getBtTriangleMesh=function(t){var i,e=y.CC_CACHE;if(e.btTriangleMesh.enable){if(null==e.btTriangleMesh[t._uuid]){var s=new y.btTriangleMesh;e.btTriangleMesh[t._uuid]=s,A(s,t)}i=e.btTriangleMesh[t._uuid]}else this.refBtTriangleMesh=i=new y.btTriangleMesh,A(i,t);return i},s}($),ot=function(t){r(s,t);var e=s.prototype;function s(){return t.call(this,v.CYLINDER_SHAPE_PROXYTYPE)||this}return e.setHeight=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},e.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},e.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},i(s,[{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),e.onComponentSet=function(){var t=M.instance.VECTOR3_0;t.setValue(.5,1,.5),this._btShape=new y.btCylinderShape(t),this.setRadius(this.collider.radius)},e.setScale=function(){t.prototype.setScale.call(this),this.setRadius(this.collider.radius)},e.updateProperties=function(t,i,e,s){var o=s,n=e;if(1===n){var r=i*Math.abs(o.y),l=t*Math.abs(a(o.x,o.z)),h=r/2;this.impl.updateProp(l,h,n)}else if(0===n){var d=i*Math.abs(o.x),c=t*Math.abs(a(o.y,o.z)),u=d/2;this.impl.updateProp(c,u,n)}else{var p=i*Math.abs(o.z),_=t*Math.abs(a(o.x,o.y)),S=p/2;this.impl.updateProp(_,S,n)}this.updateCompoundTransform()},s}($),nt=function(t){r(s,t);var e=s.prototype;function s(){return t.call(this,v.CONE_SHAPE_PROXYTYPE)||this}return e.setHeight=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},e.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},e.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.height,this.collider.direction,this._collider.node.worldScale)},i(s,[{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),e.onComponentSet=function(){this._btShape=new y.btConeShape(.5,1),this.setRadius(this.collider.radius)},e.setScale=function(){t.prototype.setScale.call(this),this.setRadius(this.collider.radius)},e.updateProperties=function(t,i,e,s){var o=s,n=e;if(1===n){var r=i*Math.abs(o.y),l=t*Math.abs(a(o.x,o.z));this.impl.setRadius(l),this.impl.setHeight(r)}else if(0===n){var h=i*Math.abs(o.x),d=t*Math.abs(a(o.y,o.z));this.impl.setRadius(d),this.impl.setHeight(h)}else{var c=i*Math.abs(o.z),u=t*Math.abs(a(o.x,o.y));this.impl.setRadius(u),this.impl.setHeight(c)}this.impl.setConeUpIndex(n),this.scale.setValue(1,1,1),this.impl.setLocalScaling(this.scale),this.updateCompoundTransform()},s}($),rt=function(t){r(o,t);var s=o.prototype;function o(){var i;return(i=t.call(this,v.TERRAIN_SHAPE_PROXYTYPE)||this)._terrainID=void 0,i._buffPtr=void 0,i._tileSize=void 0,i._localOffset=void 0,i._terrainID="",i._buffPtr=0,i._tileSize=0,i._localOffset=new e,i}return s.setTerrain=function(t){if(this._isBinding)if(null!=this._btShape&&this._btShape!==M.instance.EMPTY_SHAPE)h("[Physics] Ammo change the terrain asset after initialization is not support.");else{var i=t;if(i){this._terrainID=i._uuid,this._tileSize=i.tileSize;var e=i.getVertexCountI(),s=i.getVertexCountJ();this._buffPtr=y._malloc(4*e*s);for(var o=0,n=Number.MIN_VALUE,r=Number.MAX_VALUE,a=0;a<s;a++)for(var l=0;l<e;l++){var d=i.getHeight(l,a);y.HEAPF32[this._buffPtr+o>>2]=d,n=n<d?d:n,r=r>d?d:r,o+=4}n+=.1,r-=.1,this._localOffset.set((e-1)/2*this._tileSize,(n+r)/2,(s-1)/2*this._tileSize),this._btShape=new y.btHeightfieldTerrainShape(e,s,this._buffPtr,1,r,n,1,"PHY_FLOAT",!1),this.scale.setValue(this._tileSize,1,this._tileSize),this._btShape.setLocalScaling(this.scale)}else this._btShape=M.instance.EMPTY_SHAPE}},i(o,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._btShape}}]),s.onComponentSet=function(){this.setTerrain(this.collider.terrain)},s.onDestroy=function(){this._buffPtr&&y._free(this._buffPtr),t.prototype.onDestroy.call(this)},s.setCompound=function(i){t.prototype.setCompound.call(this,i),this.impl.setUserIndex(this._index)},s.setCenter=function(t){e.copy(N,t),N.add(this._localOffset),g(this.transform.getOrigin(),N),this.updateCompoundTransform()},o}($),at=function(t){r(s,t);var e=s.prototype;function s(){var i;return(i=t.call(this,v.TETRAHEDRAL_SHAPE_PROXYTYPE)||this).VERTICES=[],i}return e.setShapeType=function(){this._isBinding},e.setVertices=function(t){for(var i=this.VERTICES.length,e=0;e<i;e++)g(this.VERTICES[e],t[e]);g(this.scale,this._collider.node.worldScale),this._btShape.setLocalScaling(this.scale),this._btCompound&&this._btCompound.updateChildTransform(this.index,this.transform,!0)},i(s,[{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),e.onComponentSet=function(){this._btShape=new y.btBU_Simplex1to4;for(var t=this.collider.shapeType,i=this.collider.vertices,e=0;e<t;e++)this.VERTICES[e]=new y.btVector3,g(this.VERTICES[e],i[e]),this.impl.addVertex(this.VERTICES[e]);g(this.scale,this._collider.node.worldScale),this._btShape.setLocalScaling(this.scale)},e.onLoad=function(){t.prototype.onLoad.call(this),this.collider.updateVertices()},e.onDestroy=function(){for(var i=this.VERTICES.length,e=0;e<i;e++)y.destroy(this.VERTICES[e]);this.VERTICES=null,t.prototype.onDestroy.call(this)},e.setScale=function(){t.prototype.setScale.call(this),g(this.scale,this._collider.node.worldScale),this._btShape.setLocalScaling(this.scale),this._btCompound&&this._btCompound.updateChildTransform(this.index,this.transform,!0)},s}($),lt=function(t){r(s,t);var e=s.prototype;function s(){return t.call(this,v.STATIC_PLANE_PROXYTYPE)||this}return e.setNormal=function(t){g(this.impl.getPlaneNormal(),t),this.updateCompoundTransform()},e.setConstant=function(t){this.impl.setPlaneConstant(t),this.updateCompoundTransform()},e.setScale=function(){t.prototype.setScale.call(this),g(this.scale,this._collider.node.worldScale),this._btShape.setLocalScaling(this.scale),this.updateCompoundTransform()},i(s,[{key:"impl",get:function(){return this._btShape}},{key:"collider",get:function(){return this._collider}}]),e.onComponentSet=function(){var t=M.instance.VECTOR3_0;g(t,this.collider.normal),this._btShape=new y.btStaticPlaneShape(t,this.collider.constant),this.setScale()},s}($),ht=function(){function t(){this.dirty=0,this.index=-1,this._collided=!1}var e=t.prototype;return e.setConnectedBody=function(){},e.setEnableCollision=function(t){this._collided!==t&&(this._collided=t,this.updateByReAdd())},e.updateByReAdd=function(){if(this._rigidBody&&this.index>=0){var t=this._rigidBody.body.sharedBody;t.wrappedWorld.removeConstraint(this),t.wrappedWorld.addConstraint(this)}},e.initialize=function(t){this._com=t,this._rigidBody=t.attachedBody,this._collided=t.enableCollision,this.onComponentSet()},e.onComponentSet=function(){},e.updateScale0=function(){},e.updateScale1=function(){},e.onEnable=function(){var t=this._rigidBody.body.sharedBody;t.wrappedWorld.addConstraint(this),t.addJoint(this,0);var i=this.constraint.connectedBody;i&&i.body.sharedBody.addJoint(this,1)},e.onDisable=function(){var t=this._rigidBody.body.sharedBody;t.wrappedWorld.removeConstraint(this),t.removeJoint(this,0);var i=this.constraint.connectedBody;i&&i.body.sharedBody.removeJoint(this,1)},e.onDestroy=function(){y.destroy(this._impl),this._com=null,this._rigidBody=null,this._impl=null},i(t,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),t}(),dt=function(t){function s(){return t.apply(this,arguments)||this}r(s,t);var o=s.prototype;return o.setPivotA=function(){var t=M.instance.VECTOR3_0,i=this.constraint;e.multiply(N,i.node.worldScale,i.pivotA),g(t,N),this.impl.setPivotA(t),i.connectedBody||this.setPivotB(i.pivotB)},o.setPivotB=function(){var t=this.constraint,i=this._rigidBody.node,s=M.instance.VECTOR3_0,o=t.connectedBody;o?(e.multiply(N,o.node.worldScale,t.pivotB),g(s,N)):(e.multiply(N,i.worldScale,t.pivotA),e.add(N,N,i.worldPosition),e.add(N,N,t.pivotB),g(s,N)),this.impl.setPivotB(s)},o.onComponentSet=function(){var t,i=this._rigidBody.body.impl,e=this.constraint.connectedBody;e&&(t=e.body.impl);var s=M.instance.VECTOR3_0;if(t){var o=M.instance.VECTOR3_1;this._impl=new y.btPoint2PointConstraint(i,t,s,o)}else this._impl=new y.btPoint2PointConstraint(i,s);this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB)},o.updateScale0=function(){this.setPivotA(this.constraint.pivotA)},o.updateScale1=function(){this.setPivotB(this.constraint.pivotB)},i(s,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),s}(ht),ct=function(t){function o(){return t.apply(this,arguments)||this}r(o,t);var n=o.prototype;return n.setPivotA=function(){this.updateFrames()},n.setPivotB=function(){this.updateFrames()},n.setAxis=function(){this.updateFrames()},n.onComponentSet=function(){var t=this._rigidBody.body.sharedBody,i=this.constraint.connectedBody,e=i?i.body.impl:t.wrappedWorld.impl.getFixedBody(),s=M.instance.TRANSFORM,o=M.instance.TRANSFORM_1;this._impl=new y.btHingeConstraint(t.body,e,s,o),this.updateFrames()},n.updateFrames=function(){var t=this.constraint,i=t.node,o=N,n=H,r=M.instance.TRANSFORM;e.multiply(o,i.worldScale,t.pivotA),g(r.getOrigin(),o);var a=M.instance.QUAT_0;s.rotationTo(n,e.UNIT_Z,t.axis),r.setRotation(E(a,n));var l=M.instance.TRANSFORM_1,h=this.constraint.connectedBody;h?e.multiply(o,h.node.worldScale,t.pivotB):(e.multiply(o,i.worldScale,t.pivotA),e.add(o,o,i.worldPosition),e.add(o,o,t.pivotB),s.multiply(n,n,i.worldRotation)),g(l.getOrigin(),o),l.setRotation(E(a,n)),this.impl.setFrames(r,l)},n.updateScale0=function(){this.updateFrames()},n.updateScale1=function(){this.updateFrames()},i(o,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),o}(ht);u.select("ammo.js",{PhysicsWorld:Z,RigidBody:k,BoxShape:tt,SphereShape:it,CapsuleShape:et,TrimeshShape:st,CylinderShape:ot,ConeShape:nt,TerrainShape:rt,SimplexShape:at,PlaneShape:lt,PointToPointConstraint:dt,HingeConstraint:ct}),window.Ammo=y,y.CC_CONFIG={ignoreSelfBody:!0},y.CC_CACHE={btTriangleMesh:{enable:!1}}}}}));
