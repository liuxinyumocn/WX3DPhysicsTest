System.register(["./coordinates-converts-utils-bf8713a9.js","./event-enum-5a5aa40e.js","./deprecated-3.0.0-f3f53c89.js"],(function(t){"use strict";var e,i,n,s,r,a,o,h,l,_,c,u,d,f,p,g,m,y,v,A,I,S,N,E,R,T,b,C,O,L,M,D,w,P,B,H,F,k,W,U,x,G,z,V,j,Y,Z,Q,X,K,q,$,J,tt,et,it,nt,st,rt,at,ot,ht,lt,_t,ct,ut,dt,ft,pt,gt,mt,yt,vt,At,It,St,Nt,Et,Rt,Tt,bt,Ct,Ot,Lt,Mt,Dt,wt,Pt,Bt,Ht,Ft,kt,Wt,Ut,xt,Gt,zt,Vt,jt,Yt;return{setters:[function(t){e=t.e4,i=t.a1,n=t.a8,s=t.ar,r=t.ab,a=t.ad,o=t.t,h=t.aq,l=t.bM,_=t.bL,c=t.dY,u=t.l,d=t.S,f=t.b2,p=t.e3,g=t.b4,m=t.aL,y=t.aK,v=t.aj,A=t.Q,I=t.a3,S=t.a4,N=t.ai,E=t.f7,R=t.co,T=t.Z,b=t.a0,C=t.A,O=t.b9,L=t.P,M=t.X,D=t.cM,w=t.cN,P=t.f8,B=t.al,H=t.a7,F=t.a9,k=t.ak,W=t.ae,U=t.$,x=t.ap,G=t.ao,z=t.e0,V=t.Y,j=t.ex,Y=t.a2,Z=t.d4,Q=t.d7,X=t.f9,K=t.fa,q=t.B,$=t.v,J=t.M,tt=t.b6,et=t.aB,it=t.d,nt=t.bU,st=t.e2,rt=t.e,at=t.e7,ot=t.e8,ht=t.eM,lt=t.a,_t=t.f,ct=t.fb,ut=t.ci,dt=t.fc,ft=t.d_,pt=t.ep,gt=t.e5,mt=t.fd,yt=t.e9,vt=t.eA,At=t.ea,It=t.b8,St=t.ec,Nt=t.av,Et=t.au,Rt=t.fe,Tt=t.ff,bt=t.fg,Ct=t.fh,Ot=t.fi,Lt=t.cb,Mt=t.eb,Dt=t.fj},function(t){wt=t.T,Pt=t.e,Bt=t.A,Ht=t.L,Ft=t.g,kt=t.I,Wt=t.n,Ut=t.q,xt=t.l,Gt=t.N,zt=t.M},function(t){Vt=t.A,jt=t.F,Yt=t.r}],execute:function(){t("M",void 0);var Zt=t("R",function(){function t(t){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._scenePoolHandle=i,this._modelArrayHandle=i,this._batchArrayHandle=i,this._sphereLightsHandle=i,this._spotLightsHandle=i,this._root=t,this._createHandles()}t.registerCreateFunc=function(e){e._createSceneFun=function(e){return new t(e)}},e(t,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"handle",get:function(){return this._scenePoolHandle}},{key:"batches",get:function(){return this._batches}}]);var l=t.prototype;return l.initialize=function(t){return this._name=t.name,this._createHandles(),!0},l.update=function(t){var e=this._mainLight;e&&e.update();for(var i=this._sphereLights,n=0;n<i.length;n++)i[n].update();for(var s=this._spotLights,r=0;r<s.length;r++)s[r].update();for(var a=this._models,o=0;o<a.length;o++){var h=a[o];h.enabled&&(h.updateTransform(t),h.updateUBOs(t))}},l.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._modelArrayHandle&&(n.free(this._modelArrayHandle),this._modelArrayHandle=i),this._scenePoolHandle&&(s.free(this._scenePoolHandle),this._scenePoolHandle=i),this._sphereLightsHandle&&(r.free(this._sphereLightsHandle),this._sphereLightsHandle=i),this._spotLightsHandle&&(r.free(this._spotLightsHandle),this._spotLightsHandle=i),this._batchArrayHandle&&(a.free(this._batchArrayHandle),this._batchArrayHandle=i)},l.addCamera=function(t){t.attachToScene(this),this._cameras.push(t)},l.removeCamera=function(t){for(var e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return this._cameras.splice(e,1),void t.detachFromScene()},l.removeCameras=function(){for(var t,e=o(this._cameras);!(t=e()).done;)t.value.detachFromScene();this._cameras.splice(0)},l.setMainLight=function(t){this._mainLight=t,s.set(this._scenePoolHandle,h.MAIN_LIGHT,t.handle)},l.unsetMainLight=function(t){if(this._mainLight===t){var e=this._directionalLights;e.length?(this._mainLight=e[e.length-1],this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=wt.ROTATION)):this._mainLight=null}},l.addDirectionalLight=function(t){t.attachToScene(this),this._directionalLights.push(t)},l.removeDirectionalLight=function(t){for(var e=0;e<this._directionalLights.length;++e)if(this._directionalLights[e]===t)return t.detachFromScene(),void this._directionalLights.splice(e,1)},l.addSphereLight=function(t){t.attachToScene(this),this._sphereLights.push(t),r.push(this._sphereLightsHandle,t.handle)},l.removeSphereLight=function(t){for(var e=0;e<this._sphereLights.length;++e)if(this._sphereLights[e]===t)return t.detachFromScene(),this._sphereLights.splice(e,1),void r.erase(this._sphereLightsHandle,e)},l.addSpotLight=function(t){t.attachToScene(this),this._spotLights.push(t),r.push(this._spotLightsHandle,t.handle)},l.removeSpotLight=function(t){for(var e=0;e<this._spotLights.length;++e)if(this._spotLights[e]===t)return t.detachFromScene(),this._spotLights.splice(e,1),void r.erase(this._spotLightsHandle,e)},l.removeSphereLights=function(){for(var t=0;t<this._sphereLights.length;++t)this._sphereLights[t].detachFromScene();this._sphereLights.length=0,r.clear(this._sphereLightsHandle)},l.removeSpotLights=function(){for(var t=0;t<this._spotLights.length;++t)this._spotLights[t].detachFromScene();this._spotLights=[],r.clear(this._spotLightsHandle)},l.addModel=function(t){t.attachToScene(this),this._models.push(t),n.push(this._modelArrayHandle,t.handle)},l.removeModel=function(t){for(var e=0;e<this._models.length;++e)if(this._models[e]===t)return t.detachFromScene(),this._models.splice(e,1),void n.erase(this._modelArrayHandle,e)},l.removeModels=function(){for(var t,e=o(this._models);!(t=e()).done;){var i=t.value;i.detachFromScene(),i.destroy()}this._models.length=0,n.clear(this._modelArrayHandle)},l.addBatch=function(t){this._batches.push(t),a.push(this._batchArrayHandle,t.handle)},l.removeBatch=function(t){for(var e=0;e<this._batches.length;++e)if(this._batches[e]===t)return this._batches.splice(e,1),void a.erase(this._batchArrayHandle,e)},l.removeBatches=function(){this._batches.length=0,a.clear(this._batchArrayHandle)},l.onGlobalPipelineStateChanged=function(){for(var t,e=o(this._models);!(t=e()).done;)t.value.onGlobalPipelineStateChanged()},l.generateModelId=function(){return this._modelId++},l._createHandles=function(){this._modelArrayHandle||(this._modelArrayHandle=n.alloc(),this._scenePoolHandle=s.alloc(),s.set(this._scenePoolHandle,h.MODEL_ARRAY,this._modelArrayHandle),this._spotLightsHandle=r.alloc(),s.set(this._scenePoolHandle,h.SPOT_LIGHT_ARRAY,this._spotLightsHandle),this._sphereLightsHandle=r.alloc(),s.set(this._scenePoolHandle,h.SPHERE_LIGHT_ARRAY,this._sphereLightsHandle)),this._batchArrayHandle||(this._batchArrayHandle=a.alloc(),s.set(this._scenePoolHandle,h.BATCH_ARRAY_2D,this._batchArrayHandle))},t}());l(Zt.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),l(Zt.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllModels",suggest:"using intersect.rayModel in geometry"},{name:"raycastSingleModel",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllCanvas",suggest:"using intersect.rayAABB in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);var Qt=t("C",{});l(Qt,"CameraVisFlags",[{name:"GENERAL"}]),_(Qt,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:c.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:c.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:c.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:c.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:c.BitMask,targetName:"UI_2D"}]),u.CameraVisFlags=Qt;var Xt=t("V",{});l(Xt,"VisibilityFlags",[{name:"GENERAL"}]),_(Xt,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:c.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:c.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:c.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:c.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:c.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:c.Enum,targetName:"UI_2D"}]),u.VisibilityFlags=Xt,_(d.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),l(Pt.prototype,"Camera.prototype",[{name:"getSplitFrustum"}]);var Kt,qt=new f(0,0,-1),$t=new f,Jt=(t("D",function(t){function i(){var e;return(e=t.call(this)||this)._dir=new f(1,-1,-1),e._shadowRange=1e3,e._shadowIntensity=0,e._shadowFadeDistance=0,e._shadowDistance=0,e._fadeStart=.8,e._splits=new g(1,0,0,0),e._biasAutoAdjust=1,e}p(i,t),e(i,[{key:"shadowRange",set:function(t){this._shadowRange=t},get:function(){return this._shadowRange}},{key:"shadowIntensitywRange",set:function(t){this._shadowIntensity=t}},{key:"shadowIntensity",get:function(){return this._shadowIntensity}},{key:"shadowFadeDistance",set:function(t){this._shadowFadeDistance=t},get:function(){return this._shadowFadeDistance}},{key:"shadowDistance",set:function(t){this._shadowDistance=t},get:function(){return this._shadowDistance}},{key:"fadeStart",set:function(t){this._fadeStart=t},get:function(){return this._fadeStart}},{key:"splits",set:function(t){this._splits=t},get:function(){return this._splits}},{key:"biasAutoAdjust",set:function(t){this._biasAutoAdjust=t},get:function(){return this._biasAutoAdjust}},{key:"direction",set:function(t){f.normalize(this._dir,t),m.setVec3(this._handle,y.DIRECTION,this._dir)},get:function(){return this._dir}},{key:"illuminance",set:function(t){m.set(this._handle,y.ILLUMINANCE,t)},get:function(){return m.get(this._handle,y.ILLUMINANCE)}}]);var n=i.prototype;return n.initialize=function(){t.prototype.initialize.call(this),m.set(this._handle,y.ILLUMINANCE,Bt.SUN_ILLUM),m.setVec3(this._handle,y.DIRECTION,this._dir),m.set(this._handle,y.TYPE,Ht.DIRECTIONAL)},n.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=f.transformQuat($t,qt,this._node.worldRotation))},i}(Ft)),new R(null)),te=t("c",function(){function t(){this._device=null,this._passes=null,this._subMesh=null,this._patches=null,this._handle=i,this._priority=E.DEFAULT,this._inputAssembler=null,this._descriptorSet=null}var n=t.prototype;return n.initialize=function(t,e,i){void 0===i&&(i=null),this._device=u.director.root.device,this._subMesh=t,this._patches=i,this._passes=e,this._handle=v.alloc(),this._flushPassInfo(),e[0].batchingScheme===A.VB_MERGING&&this._subMesh.genFlatBuffers(),Jt.layout=e[0].localSetLayout;var n=I.alloc(this._device,Jt),s=S.alloc(this._device,t.iaInfo);v.set(this._handle,N.PRIORITY,E.DEFAULT),v.set(this._handle,N.INPUT_ASSEMBLER,s),v.set(this._handle,N.DESCRIPTOR_SET,n),v.set(this._handle,N.SUB_MESH,t.handle),this._inputAssembler=S.get(s),this._descriptorSet=I.get(n)},n.initPlanarShadowShader=function(){var t=u.director.root.pipeline.shadows.getPlanarShader(this._patches);v.set(this._handle,N.PLANAR_SHADER,t)},n.destroy=function(){I.free(v.get(this._handle,N.DESCRIPTOR_SET)),S.free(v.get(this._handle,N.INPUT_ASSEMBLER)),v.free(this._handle),this._descriptorSet=null,this._inputAssembler=null,this._priority=E.DEFAULT,this._handle=i,this._patches=null,this._subMesh=null,this._passes=null},n.update=function(){for(var t=0;t<this._passes.length;++t)this._passes[t].update();this._descriptorSet.update()},n.onPipelineStateChanged=function(){var t=this._passes;if(t){for(var e=0;e<t.length;e++){var i=t[e];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},n.onMacroPatchesStateChanged=function(t){this._patches=t;var e=this._passes;if(e){for(var i=0;i<e.length;i++){var n=e[i];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}},n._flushPassInfo=function(){var t=this._passes;if(t){v.set(this._handle,N.PASS_COUNT,t.length);for(var e=N.PASS_0,i=N.SHADER_0,n=0;n<t.length;n++,e++,i++)v.set(this._handle,e,t[n].handle),v.set(this._handle,i,t[n].getShaderVariant(this._patches))}},e(t,[{key:"passes",set:function(t){if(this._passes=t,this._flushPassInfo(),this._descriptorSet){I.free(v.get(this._handle,N.DESCRIPTOR_SET)),Jt.layout=t[0].localSetLayout;var e=I.alloc(this._device,Jt);v.set(this._handle,N.DESCRIPTOR_SET,e),this._descriptorSet=I.get(e)}},get:function(){return this._passes}},{key:"subMesh",set:function(t){this._subMesh=t,this._inputAssembler.destroy(),this._inputAssembler.initialize(t.iaInfo),this._passes[0].batchingScheme===A.VB_MERGING&&this._subMesh.genFlatBuffers(),v.set(this._handle,N.SUB_MESH,t.handle)},get:function(){return this._subMesh}},{key:"priority",set:function(t){this._priority=t,v.set(this._handle,N.PRIORITY,t)},get:function(){return this._priority}},{key:"handle",get:function(){return this._handle}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarShaderHandel",get:function(){return v.get(this._handle,N.PLANAR_SHADER)}}]),t}()),ee=new T(b.ATTRIBUTE,(function(t,e){return e||new C})),ie=new O,ne=new L((function(){return new te}),32),se=[{name:"CC_RECEIVE_SHADOW",value:!0}];!function(t){t[t.DEFAULT=0]="DEFAULT",t[t.SKINNING=1]="SKINNING",t[t.BAKED_SKINNING=2]="BAKED_SKINNING",t[t.BATCH_2D=3]="BATCH_2D",t[t.PARTICLE_BATCH=4]="PARTICLE_BATCH",t[t.LINE=5]="LINE"}(Kt||(Kt=t("M",{})));var re,ae,oe,he,le,_e,ce,ue,de,fe=M([D.LINEAR,D.LINEAR,D.NONE,w.CLAMP,w.CLAMP,w.CLAMP]),pe=M([D.LINEAR,D.LINEAR,D.LINEAR,w.CLAMP,w.CLAMP,w.CLAMP]),ge=(t("a",function(){function t(){this.type=Kt.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._transformUpdated=!0,this._handle=i,this._hWorldBounds=i,this._localData=new Float32Array(P.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new g,this._device=u.director.root.device}e(t,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"receiveShadow",get:function(){return!!B.get(this._handle,k.RECEIVE_SHADOW)},set:function(t){B.set(this._handle,k.RECEIVE_SHADOW,t?1:0),this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return!!B.get(this._handle,k.CAST_SHADOW)},set:function(t){B.set(this._handle,k.CAST_SHADOW,t?1:0)}},{key:"handle",get:function(){return this._handle}},{key:"node",get:function(){return this._node},set:function(t){this._node=t,B.set(this._handle,k.NODE,t.handle)}},{key:"transform",get:function(){return this._transform},set:function(t){this._transform=t,B.set(this._handle,k.TRANSFORM,t.handle)}},{key:"visFlags",get:function(){return B.get(this._handle,k.VIS_FLAGS)},set:function(t){B.set(this._handle,k.VIS_FLAGS,t)}},{key:"enabled",get:function(){return!!B.get(this._handle,k.ENABLED)},set:function(t){B.set(this._handle,k.ENABLED,t?1:0)}}]);var n=t.prototype;return n.initialize=function(){if(!this._inited){this._handle=B.alloc();var t=H.alloc(),e=F.alloc();B.set(this._handle,k.INSTANCED_ATTR_ARRAY,e),B.set(this._handle,k.SUB_MODEL_ARRAY,t),B.set(this._handle,k.VIS_FLAGS,c.Enum.NONE),B.set(this._handle,k.ENABLED,1),B.set(this._handle,k.RECEIVE_SHADOW,1),B.set(this._handle,k.CAST_SHADOW,0),this._inited=!0}},n.destroy=function(){for(var t=this._subModels,e=0;e<t.length;e++){var n=this._subModels[e];n.destroy(),ne.free(n)}if(this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._transformUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._handle){var s=B.get(this._handle,k.SUB_MODEL_ARRAY);s&&H.free(s);var r=B.get(this._handle,k.INSTANCED_BUFFER);r&&W.free(r);var a=B.get(this._handle,k.INSTANCED_ATTR_ARRAY);a&&U(a,F,ee),B.free(this._handle),this._handle=i}this._hWorldBounds&&(x.free(this._hWorldBounds),this._hWorldBounds=i)},n.attachToScene=function(t){this.scene=t},n.detachFromScene=function(){this.scene=null},n.updateTransform=function(){var t=this.transform;if(t.hasChangedFlags||t._dirtyFlags){t.updateWorldTransform(),this._transformUpdated=!0;var e=this._worldBounds;this._modelBounds&&e&&(this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e),x.setVec3(this._hWorldBounds,G.CENTER,e.center),x.setVec3(this._hWorldBounds,G.HALF_EXTENSION,e.halfExtents))}},n.updateWorldBound=function(){var t=this.transform;if(null!==t){t.updateWorldTransform(),this._transformUpdated=!0;var e=this._worldBounds;this._modelBounds&&e&&(this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e),x.setVec3(this._hWorldBounds,G.CENTER,e.center),x.setVec3(this._hWorldBounds,G.HALF_EXTENSION,e.halfExtents))}},n.updateUBOs=function(t){for(var e=this._subModels,i=0;i<e.length;i++)e[i].update();if(this._updateStamp=t,this._transformUpdated){this._transformUpdated=!1;var n,s,r,a,o=this.transform._mat,h=this._instMatWorldIdx;if(h>=0){var l=this.instancedAttributes.views;n=o,s=l[h],r=l[h+1],a=l[h+2],s[0]=n.m00,s[1]=n.m01,s[2]=n.m02,s[3]=n.m12,r[0]=n.m04,r[1]=n.m05,r[2]=n.m06,r[3]=n.m13,a[0]=n.m08,a[1]=n.m09,a[2]=n.m10,a[3]=n.m14}else this._localBuffer&&(O.toArray(this._localData,o,P.MAT_WORLD_OFFSET),O.inverseTranspose(ie,o),O.toArray(this._localData,ie,P.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData))}},n.createBoundingShape=function(t,e){t&&e&&(this._modelBounds=Vt.fromPoints(Vt.create(),t,e),this._worldBounds=Vt.clone(this._modelBounds),this._hWorldBounds===i&&(this._hWorldBounds=x.alloc(),B.set(this._handle,k.WORLD_BOUNDS,this._hWorldBounds)),x.setVec3(this._hWorldBounds,G.CENTER,this._worldBounds.center),x.setVec3(this._hWorldBounds,G.HALF_EXTENSION,this._worldBounds.halfExtents))},n.initSubModel=function(t,e,i){this.initialize();var n=!1;if(null==this._subModels[t]?(this._subModels[t]=ne.alloc(),n=!0):this._subModels[t].destroy(),this._subModels[t].initialize(e,i.passes,this.getMacroPatches(t)),this._subModels[t].initPlanarShadowShader(),this._updateAttributesAndBinding(t),n){var s=B.get(this._handle,k.SUB_MODEL_ARRAY);H.assign(s,t,this._subModels[t].handle)}},n.setSubModelMesh=function(t,e){this._subModels[t]&&(this._subModels[t].subMesh=e)},n.setSubModelMaterial=function(t,e){this._subModels[t]&&(this._subModels[t].passes=e.passes,this._updateAttributesAndBinding(t))},n.onGlobalPipelineStateChanged=function(){for(var t=this._subModels,e=0;e<t.length;e++)t[e].onPipelineStateChanged()},n.onMacroPatchesStateChanged=function(){for(var t=this._subModels,e=0;e<t.length;e++)t[e].onMacroPatchesStateChanged(this.getMacroPatches(e))},n.updateLightingmap=function(t,e){g.toArray(this._localData,e,P.LIGHTINGMAP_UVPARAM),this._lightmap=t,this._lightmapUVParam=e,null===t&&(t=z.get("empty-texture"));var i=t.getGFXTexture();if(i)for(var n=V.getSampler(this._device,t.mipmaps.length>1?pe:fe),s=this._subModels,r=0;r<s.length;r++){var a=s[r].descriptorSet;a.bindTexture(j,i),a.bindSampler(j,n),a.update()}},n.getMacroPatches=function(){return this.receiveShadow?se:null},n._updateAttributesAndBinding=function(t){var e=this._subModels[t];if(e){this._initLocalDescriptors(t),this._updateLocalDescriptors(t,e.descriptorSet);var i=Y.get(v.get(e.handle,N.SHADER_0));this._updateInstancedAttributes(i.attributes,e.passes[0])}},n._getInstancedAttributeIndex=function(t){for(var e=this.instancedAttributes.attributes,i=0;i<e.length;i++)if(e[i].name===t)return i;return-1},n._updateInstancedAttributes=function(t,e){if(e.device.hasFeature(Z.INSTANCED_ARRAYS)){var i=B.get(this._handle,k.INSTANCED_BUFFER);i&&W.free(i);var n=B.get(this._handle,k.INSTANCED_ATTR_ARRAY);n&&U(n,F,ee,!1);for(var s=0,r=0;r<t.length;r++){var a=t[r];a.isInstanced&&(s+=Q[a.format].size)}var o=W.alloc(s),h=W.getBuffer(o);B.set(this._handle,k.INSTANCED_BUFFER,o);var l=this.instancedAttributes;l.buffer=new Uint8Array(h),l.views.length=l.attributes.length=0;for(var _=0,c=0;c<t.length;c++){var u=t[c];if(u.isInstanced){var d=ee.alloc(),f=ee.get(d);f.format=u.format,f.name=u.name,f.isNormalized=u.isNormalized,f.location=u.location,l.attributes.push(f),F.push(n,d);var p=Q[u.format];l.views.push(new(X(p))(h,_,p.count)),_+=p.size}}e.batchingScheme===A.INSTANCING&&kt.get(e).destroy(),this._instMatWorldIdx=this._getInstancedAttributeIndex(K),this._transformUpdated=!0}},n._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new q($.UNIFORM|$.TRANSFER_DST,J.HOST|J.DEVICE,P.SIZE,P.SIZE)))},n._updateLocalDescriptors=function(t,e){this._localBuffer&&e.bindBuffer(P.BINDING,this._localBuffer)},t}()),t("S",function(t){function n(){var e;return(e=t.call(this)||this)._needUpdate=!1,e._pos=void 0,e._aabb=void 0,e._hAABB=i,e._aabb=Vt.create(),e._pos=new f,e}p(n,t),e(n,[{key:"position",get:function(){return this._pos}},{key:"size",set:function(t){m.set(this._handle,y.SIZE,t)},get:function(){return m.get(this._handle,y.SIZE)}},{key:"range",set:function(t){m.set(this._handle,y.RANGE,t),this._needUpdate=!0},get:function(){return m.get(this._handle,y.RANGE)}},{key:"luminance",set:function(t){m.set(this._handle,y.ILLUMINANCE,t)},get:function(){return m.get(this._handle,y.ILLUMINANCE)}},{key:"aabb",get:function(){return this._aabb}}]);var s=n.prototype;return s.initialize=function(){t.prototype.initialize.call(this),this._hAABB=x.alloc(),m.set(this._handle,y.TYPE,Ht.SPHERE),m.set(this._handle,y.SIZE,.15),m.set(this._handle,y.RANGE,1),m.set(this._handle,y.AABB,this._hAABB),m.set(this._handle,y.ILLUMINANCE,1700/Wt(.15))},s.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var t=m.get(this._handle,y.RANGE);Vt.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,t,t,t),this._needUpdate=!1,m.setVec3(this._handle,y.POSITION,this._pos),x.setVec3(this._hAABB,G.CENTER,this._aabb.center),x.setVec3(this._hAABB,G.HALF_EXTENSION,this._aabb.halfExtents)}},s.destroy=function(){return this._hAABB&&(x.free(this._hAABB),this._hAABB=i),t.prototype.destroy.call(this)},n}(Ft)),new f(0,0,-1)),me=new tt,ye=new O,ve=new O,Ae=new O,Ie=new O,Se=(t("b",function(t){function n(){var e;return(e=t.call(this)||this)._dir=new f(1,-1,-1),e._range=5,e._spotAngle=Math.cos(Math.PI/6),e._pos=void 0,e._aabb=void 0,e._frustum=void 0,e._angle=0,e._needUpdate=!1,e._hAABB=i,e._hFrustum=i,e._aabb=Vt.create(),e._frustum=jt.create(),e._pos=new f,e}p(n,t),e(n,[{key:"position",get:function(){return this._pos}},{key:"size",set:function(t){m.set(this._handle,y.SIZE,t)},get:function(){return m.get(this._handle,y.SIZE)}},{key:"range",set:function(t){this._range=t,m.set(this._handle,y.RANGE,t),this._needUpdate=!0},get:function(){return m.get(this._handle,y.RANGE)}},{key:"luminance",set:function(t){m.set(this._handle,y.ILLUMINANCE,t)},get:function(){return m.get(this._handle,y.ILLUMINANCE)}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return m.get(this._handle,y.SPOT_ANGLE)},set:function(t){this._angle=t,m.set(this._handle,y.SPOT_ANGLE,Math.cos(.5*t)),this._needUpdate=!0}},{key:"aspect",set:function(t){m.set(this._handle,y.ASPECT,t),this._needUpdate=!0},get:function(){return m.get(this._handle,y.ASPECT)}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]);var s=n.prototype;return s.initialize=function(){t.prototype.initialize.call(this),this._hAABB=x.alloc(),this._hFrustum=et.alloc(),m.set(this._handle,y.TYPE,Ht.SPOT),m.set(this._handle,y.SIZE,.15),m.set(this._handle,y.AABB,this._hAABB),m.set(this._handle,y.ILLUMINANCE,1700/Wt(.15)),m.set(this._handle,y.RANGE,Math.cos(Math.PI/6)),m.set(this._handle,y.ASPECT,1),m.setVec3(this._handle,y.DIRECTION,this._dir)},s.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),f.transformQuat(this._dir,ge,this._node.getWorldRotation(me)),f.normalize(this._dir,this._dir),m.setVec3(this._handle,y.DIRECTION,this._dir),Vt.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(ye),O.invert(ye,ye),O.perspective(ve,this._angle,1,.001,this._range),O.multiply(Ae,ve,ye),this._frustum.update(Ae,Ie),this._needUpdate=!1,m.setVec3(this._handle,y.POSITION,this._pos),x.setVec3(this._hAABB,G.CENTER,this._aabb.center),x.setVec3(this._hAABB,G.HALF_EXTENSION,this._aabb.halfExtents),Yt(this._hFrustum,this._frustum))},s.destroy=function(){return this._hAABB&&(x.free(this._hAABB),this._hAABB=i),this._hFrustum&&(et.free(this._hFrustum),this._hFrustum=i),t.prototype.destroy.call(this)},n}(Ft)),function(){function t(t){this._uiComp=null,this.opacity=1,this._uiTransformComp=null,this._node=void 0,this._node=t}return e(t,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp},set:function(t){this._uiTransformComp=t}},{key:"uiComp",get:function(){return this._uiComp},set:function(t){this._uiComp&&t?it(12002):this._uiComp=t}}]),t}()),Ne=(nt.Flags.Destroying,nt.Flags.Destroying),Ee=nt.Flags.DontDestroy,Re=nt.Flags.Deactivating,Te=new vt("Node");function be(t){return t?"string"==typeof t?ct(t):t:(_t(3804),null)}var Ce,Oe,Le,Me,De,we,Pe,Be,He,Fe,ke,We=t("B",st("cc.BaseNode")((de=ue=function(t){p(n,t),n._setScene=function(t){t._updateScene()},n._findComponent=function(t,e){var i=e,n=t._components;if(i._sealed)for(var s=0;s<n.length;++s){var r=n[s];if(r.constructor===e)return r}else for(var a=0;a<n.length;++a){var o=n[a];if(o instanceof e)return o}return null},n._findComponents=function(t,e,i){var n=e,s=t._components;if(n._sealed)for(var r=0;r<s.length;++r){var a=s[r];a.constructor===e&&i.push(a)}else for(var o=0;o<s.length;++o){var h=s[o];h instanceof e&&i.push(h)}},n._findChildComponent=function(t,e){for(var i=0;i<t.length;++i){var s=t[i],r=n._findComponent(s,e);if(r)return r;if(s._children.length>0&&(r=n._findChildComponent(s._children,e)))return r}return null},n._findChildComponents=function(t,e,i){for(var s=0;s<t.length;++s){var r=t[s];n._findComponents(r,e,i),r._children.length>0&&n._findChildComponents(r._children,e,i)}};var i=n.prototype;function n(e){var i;return i=t.call(this,e)||this,at(i,"_parent",oe,ot(i)),at(i,"_children",he,ot(i)),at(i,"_active",le,ot(i)),at(i,"_components",_e,ot(i)),at(i,"_prefab",ce,ot(i)),i._scene=null,i._activeInHierarchy=!1,i._id=Te.getNewId(),i._name=void 0,i._eventProcessor=new u.NodeEventProcessor(ot(i)),i._eventMask=0,i._siblingIndex=0,i._registerIfAttached=void 0,i._name=void 0!==e?e:"New Node",i}return i._updateScene=function(){null==this._parent?rt("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene},e(n,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&Ee)>0},set:function(t){t?this._objFlags|=Ee:this._objFlags&=~Ee}},{key:"name",get:function(){return this._name},set:function(t){this._name=t}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(t){if(this._active!==t){this._active=t;var e=this._parent;e&&e._activeInHierarchy&&u.director._nodeActivator.activateNode(this,t)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(t){this.setParent(t)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}]),i.attr=function(t){ht(this,t)},i.getParent=function(){return this._parent},i.setParent=function(t,e){if(void 0===e&&(e=!1),this._parent!==t){var i=this._parent,n=t;if(this._parent=n,this._siblingIndex=0,this._onSetParent(i,e),this.emit&&this.emit(Ut.PARENT_CHANGED,i),i&&!(i._objFlags&Ne)){var s=i._children.indexOf(this);i._children.splice(s,1),i._updateSiblingIndex(),i.emit&&i.emit(Ut.CHILD_REMOVED,this)}n&&(n._children.push(this),this._siblingIndex=n._children.length-1,n.emit&&n.emit(Ut.CHILD_ADDED,this)),this._onHierarchyChanged(i)}},i.getChildByUuid=function(t){if(!t)return lt("Invalid uuid"),null;for(var e=this._children,i=0,n=e.length;i<n;i++)if(e[i]._id===t)return e[i];return null},i.getChildByName=function(t){if(!t)return lt("Invalid name"),null;for(var e=this._children,i=0,n=e.length;i<n;i++)if(e[i]._name===t)return e[i];return null},i.getChildByPath=function(t){for(var e=t.split("/"),i=this,n=function(t){var n=e[t];if(0===n.length)return"continue";var s=i.children.find((function(t){return t.name===n}));if(!s)return{v:null};i=s},s=0;s<e.length;++s){var r=n(s);switch(r){case"continue":continue;default:if("object"==typeof r)return r.v}}return i},i.addChild=function(t){t.setParent(this)},i.insertChild=function(t,e){t.parent=this,t.setSiblingIndex(e)},i.getSiblingIndex=function(){return this._siblingIndex},i.setSiblingIndex=function(t){if(this._parent)if(this._parent._objFlags&Re)_t(3821);else{var e=this._parent._children;t=-1!==t?t:e.length-1;var i=e.indexOf(this);t!==i&&(e.splice(i,1),t<e.length?e.splice(t,0,this):e.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(t))}},i.walk=function(t,e){var i=1,s=null,r=null,a=0,o=n._stacks[n._stackId];o||(o=[],n._stacks.push(o)),n._stackId++,o.length=0,o[0]=this;for(var h=null,l=!1;i;)if(r=o[--i])if(!l&&t?t(r):l&&e&&e(r),o[i]=null,l){if(h===this._parent)break;if(l=!1,s)if(s[++a])o[i]=s[a],i++;else if(h&&(o[i]=h,i++,l=!0,h._parent?(a=(s=h._parent._children).indexOf(h),h=h._parent):(h=null,s=null),a<0))break}else r._children.length>0?(h=r,s=r._children,a=0,o[i]=s[a],i++):(o[i]=r,i++,l=!0);o.length=0,n._stackId--},i.removeFromParent=function(){this._parent&&this._parent.removeChild(this)},i.removeChild=function(t){this._children.indexOf(t)>-1&&(t.parent=null)},i.removeAllChildren=function(){for(var t=this._children,e=t.length-1;e>=0;e--){var i=t[e];i&&(i.parent=null)}this._children.length=0},i.isChildOf=function(t){var e=this;do{if(e===t)return!0;e=e._parent}while(e);return!1},i.getComponent=function(t){var e=be(t);return e?n._findComponent(this,e):null},i.getComponents=function(t){var e=be(t),i=[];return e&&n._findComponents(this,e,i),i},i.getComponentInChildren=function(t){var e=be(t);return e?n._findChildComponent(this._children,e):null},i.getComponentsInChildren=function(t){var e=be(t),i=[];return e&&(n._findComponents(this,e,i),n._findChildComponents(this._children,e,i)),i},i.addComponent=function(t){var e;if("string"==typeof t){if(!(e=ct(t)))throw u._RF.peek()&&_t(3808,t),TypeError(ut(3807,t))}else{if(!t)throw TypeError(ut(3804));e=t}if("function"!=typeof e)throw TypeError(ut(3809));if(!dt(e,u.Component))throw TypeError(ut(3810));var i=e._requireComponent;i&&!this.getComponent(i)&&this.addComponent(i);var n=new e;return n.node=this,this._components.push(n),this._activeInHierarchy&&u.director._nodeActivator.activateComp(n),n},i.removeComponent=function(t){if(t){var e=null;(e=t instanceof ft?t:this.getComponent(t))&&e.destroy()}else _t(3813)},i.on=function(t,e,i,n){switch(void 0===n&&(n=!1),t){case Ut.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(t,e,i,n)},i.off=function(t,e,i,n){if(void 0===n&&(n=!1),this._eventProcessor.off(t,e,i,n),!this._eventProcessor.hasEventListener(t))switch(t){case Ut.TRANSFORM_CHANGED:this._eventMask&=-2}},i.once=function(t,e,i,n){this._eventProcessor.once(t,e,i,n)},i.emit=function(t,e,i,n,s,r){this._eventProcessor.emit(t,e,i,n,s,r)},i.dispatchEvent=function(t){this._eventProcessor.dispatchEvent(t)},i.hasEventListener=function(t,e,i){return this._eventProcessor.hasEventListener(t,e,i)},i.targetOff=function(t){this._eventProcessor.targetOff(t),1&this._eventMask&&!this._eventProcessor.hasEventListener(Ut.TRANSFORM_CHANGED)&&(this._eventMask&=-2)},i.destroy=function(){return!!t.prototype.destroy.call(this)&&(this.active=!1,!0)},i.destroyAllChildren=function(){for(var t=this._children,e=0;e<t.length;++e)t[e].destroy()},i._removeComponent=function(t){if(t){if(!(this._objFlags&Ne)){var e=this._components.indexOf(t);-1!==e?this._components.splice(e,1):t.node!==this&&_t(3815)}}else _t(3814)},i._updateSiblingIndex=function(){for(var t=0;t<this._children.length;++t)this._children[t]._siblingIndex=t;this.emit(Ut.SIBLING_ORDER_CHANGED)},i._onSetParent=function(t){this._parent&&(null!=t&&t._scene===this._parent._scene||null==this._parent._scene||this.walk(n._setScene))},i._onPostActivated=function(){},i._onBatchCreated=function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))},i._onPreDestroy=function(){this._onPreDestroyBase()},i._onHierarchyChanged=function(t){return this._onHierarchyChangedBase(t)},i._instantiate=function(t,e){return t||(t=u.instantiate._clone(this,this)),t._prefab,t._parent=null,t._onBatchCreated(e),t},i._onHierarchyChangedBase=function(){var t=this._parent;!this._persistNode||t instanceof u.Scene||u.game.removePersistRootNode(this);var e=this._active&&!(!t||!t._activeInHierarchy);this._activeInHierarchy!==e&&u.director._nodeActivator.activateNode(this,e)},i._onPreDestroyBase=function(){this._objFlags|=Ne;var t=this._parent,e=!!t&&0!=(t._objFlags&Ne);if(!e&&pt&&this._registerIfAttached(!1),this._persistNode&&u.game.removePersistRootNode(this),!e&&t){this.emit(Ut.PARENT_CHANGED,this);var i=t._children.indexOf(this);t._children.splice(i,1),this._siblingIndex=0,t._updateSiblingIndex(),t.emit&&t.emit(Ut.CHILD_REMOVED,this)}this.emit(Ut.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var n=this._children,s=0;s<n.length;++s)n[s]._destroyImmediate();for(var r=this._components,a=0;a<r.length;++a)r[a]._destroyImmediate();return e},n}(nt),ue.idGenerator=Te,ue._stacks=[[]],ue._stackId=0,gt((ae=de).prototype,"_persistNode",[mt],Object.getOwnPropertyDescriptor(ae.prototype,"_persistNode"),ae.prototype),gt(ae.prototype,"name",[yt],Object.getOwnPropertyDescriptor(ae.prototype,"name"),ae.prototype),gt(ae.prototype,"children",[yt],Object.getOwnPropertyDescriptor(ae.prototype,"children"),ae.prototype),gt(ae.prototype,"active",[yt],Object.getOwnPropertyDescriptor(ae.prototype,"active"),ae.prototype),gt(ae.prototype,"activeInHierarchy",[yt],Object.getOwnPropertyDescriptor(ae.prototype,"activeInHierarchy"),ae.prototype),gt(ae.prototype,"parent",[yt],Object.getOwnPropertyDescriptor(ae.prototype,"parent"),ae.prototype),oe=gt(ae.prototype,"_parent",[At],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),he=gt(ae.prototype,"_children",[At],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),le=gt(ae.prototype,"_active",[At],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_e=gt(ae.prototype,"_components",[At],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ce=gt(ae.prototype,"_prefab",[At],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),re=ae))||re);u._BaseNode=We;var Ue,xe,Ge,ze,Ve,je,Ye,Ze,Qe,Xe,Ke=new f,qe=new tt,$e=new tt,Je=new Array(10),ti=new tt,ei=new It,ii=new It,ni=new O,si=new Map,ri=t("N",(Ce=st("cc.Node"),Oe=St(f),Ce((ke=Fe=function(t){function n(e){var n;return(n=t.call(this,e)||this)._uiProps=new Se(ot(n)),n._static=!1,n._pos=new f,n._rot=new tt,n._scale=new f(1,1,1),n._mat=new O,at(n,"_lpos",De,ot(n)),at(n,"_lrot",we,ot(n)),at(n,"_lscale",Pe,ot(n)),at(n,"_layer",Be,ot(n)),at(n,"_euler",He,ot(n)),n._dirtyFlags=wt.NONE,n._eulerDirty=!1,n._poolHandle=i,n._poolHandle=Nt.alloc(),Nt.set(n._poolHandle,Et.LAYER,n._layer),n}p(n,t),n.isNode=function(t){return t instanceof n&&(t.constructor===n||!(t instanceof u.Scene))};var s=n.prototype;return s.destroy=function(){return this._poolHandle&&(Nt.free(this._poolHandle),this._poolHandle=i),t.prototype.destroy.call(this)},s.setParent=function(e,i){void 0===i&&(i=!1),i&&this.updateWorldTransform(),t.prototype.setParent.call(this,e,i)},s._onSetParent=function(e,i){if(t.prototype._onSetParent.call(this,e,i),i){var n=this._parent;n?(n.updateWorldTransform(),O.multiply(ni,O.invert(ni,n._mat),this._mat),O.toRTS(ni,this._lrot,this._lpos,this._lscale)):(f.copy(this._lpos,this._pos),tt.copy(this._lrot,this._rot),f.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(wt.TRS)},s._onBatchCreated=function(e){var i;t.prototype._onBatchCreated.call(this,e),Nt.set(this._poolHandle,Et.LAYER,this._layer),Nt.setVec3(this._poolHandle,Et.WORLD_SCALE,this._scale);var n=null===(i=this._prefab)||void 0===i?void 0:i.instance;!e&&n&&Rt(this),this.hasChangedFlags=wt.TRS,this._dirtyFlags=wt.TRS;for(var s=this._children.length,r=0;r<s;++r)this._children[r]._onBatchCreated(e);if(!e&&n){var a={};n.targetMap=a,Tt(this,a,!0),bt(this,n.mountedChildren,a),Ct(this,n.propertyOverrides,a)}Ot(this)},s._onBeforeSerialize=function(){this.eulerAngles},s._onPostActivated=function(t){t?(xt.resumeTarget(this),this.eventProcessor.reattach(),this.invalidateChildren(wt.TRS)):xt.pauseTarget(this)},s.translate=function(t,e){var i=e||Gt.LOCAL;if(i===Gt.LOCAL)f.transformQuat(Ke,t,this._lrot),this._lpos.x+=Ke.x,this._lpos.y+=Ke.y,this._lpos.z+=Ke.z;else if(i===Gt.WORLD)if(this._parent){tt.invert(qe,this._parent.worldRotation),f.transformQuat(Ke,t,qe);var n=this.worldScale;this._lpos.x+=Ke.x/n.x,this._lpos.y+=Ke.y/n.y,this._lpos.z+=Ke.z/n.z}else this._lpos.x+=t.x,this._lpos.y+=t.y,this._lpos.z+=t.z;this.invalidateChildren(wt.POSITION),1&this._eventMask&&this.emit(Ut.TRANSFORM_CHANGED,wt.POSITION)},s.rotate=function(t,e){var i=e||Gt.LOCAL;if(tt.normalize(qe,t),i===Gt.LOCAL)tt.multiply(this._lrot,this._lrot,qe);else if(i===Gt.WORLD){var n=this.worldRotation;tt.multiply($e,qe,n),tt.invert(qe,n),tt.multiply($e,qe,$e),tt.multiply(this._lrot,this._lrot,$e)}this._eulerDirty=!0,this.invalidateChildren(wt.ROTATION),1&this._eventMask&&this.emit(Ut.TRANSFORM_CHANGED,wt.ROTATION)},s.lookAt=function(t,e){this.getWorldPosition(Ke),f.subtract(Ke,Ke,t),f.normalize(Ke,Ke),tt.fromViewUp(qe,Ke,e),this.setWorldRotation(qe)},s.invalidateChildren=function(t){var e=this.hasChangedFlags;if((this._dirtyFlags&e&t)!==t){this._dirtyFlags|=t,this.hasChangedFlags=e|t;for(var i=t|wt.POSITION,n=this._children.length,s=0;s<n;++s){var r=this._children[s];r.isValid&&r.invalidateChildren(i)}}},s.updateWorldTransform=function(){if(this._dirtyFlags){for(var t,e=this,i=0;e&&e._dirtyFlags;)Je[i++]=e,e=e._parent;for(var n=0;i;)n|=(t=Je[--i])._dirtyFlags,e?(n&wt.POSITION&&(f.transformMat4(t._pos,t._lpos,e._mat),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z,Nt.setVec3(t._poolHandle,Et.WORLD_POSITION,t._pos)),n&wt.RS&&(O.fromRTS(t._mat,t._lrot,t._lpos,t._lscale),O.multiply(t._mat,e._mat,t._mat),n&wt.ROTATION&&(tt.multiply(t._rot,e._rot,t._lrot),Nt.setVec4(t._poolHandle,Et.WORLD_ROTATION,t._rot)),It.fromQuat(ei,tt.conjugate(ti,t._rot)),It.multiplyMat4(ei,ei,t._mat),t._scale.x=ei.m00,t._scale.y=ei.m04,t._scale.z=ei.m08,Nt.setVec3(t._poolHandle,Et.WORLD_SCALE,t._scale))):(n&wt.POSITION&&(f.copy(t._pos,t._lpos),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z,Nt.setVec3(t._poolHandle,Et.WORLD_POSITION,t._pos)),n&wt.RS&&(n&wt.ROTATION&&(tt.copy(t._rot,t._lrot),Nt.setVec4(t._poolHandle,Et.WORLD_ROTATION,t._rot)),n&wt.SCALE&&(f.copy(t._scale,t._lscale),Nt.setVec3(t._poolHandle,Et.WORLD_SCALE,t._scale),O.fromRTS(t._mat,t._rot,t._pos,t._scale)))),n!==wt.NONE&&Nt.setMat4(t._poolHandle,Et.WORLD_MATRIX,t._mat),t._dirtyFlags=wt.NONE,e=t}},s.setPosition=function(t,e,i){void 0===e&&void 0===i?f.copy(this._lpos,t):void 0===i?f.set(this._lpos,t,e,this._lpos.z):f.set(this._lpos,t,e,i),this.invalidateChildren(wt.POSITION),1&this._eventMask&&this.emit(Ut.TRANSFORM_CHANGED,wt.POSITION)},s.getPosition=function(t){return t?f.set(t,this._lpos.x,this._lpos.y,this._lpos.z):f.copy(new f,this._lpos)},s.setRotation=function(t,e,i,n){void 0===e||void 0===i||void 0===n?tt.copy(this._lrot,t):tt.set(this._lrot,t,e,i,n),this._eulerDirty=!0,this.invalidateChildren(wt.ROTATION),1&this._eventMask&&this.emit(Ut.TRANSFORM_CHANGED,wt.ROTATION)},s.setRotationFromEuler=function(t,e,i){var n=void 0===i?this._euler.z:i;void 0===e?(f.copy(this._euler,t),tt.fromEuler(this._lrot,t.x,t.y,t.z)):(f.set(this._euler,t,e,n),tt.fromEuler(this._lrot,t,e,n)),this._eulerDirty=!1,this.invalidateChildren(wt.ROTATION),1&this._eventMask&&this.emit(Ut.TRANSFORM_CHANGED,wt.ROTATION)},s.getRotation=function(t){return t?tt.set(t,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):tt.copy(new tt,this._lrot)},s.setScale=function(t,e,i){void 0===e&&void 0===i?f.copy(this._lscale,t):void 0===i?f.set(this._lscale,t,e,this._lscale.z):f.set(this._lscale,t,e,i),this.invalidateChildren(wt.SCALE),1&this._eventMask&&this.emit(Ut.TRANSFORM_CHANGED,wt.SCALE)},s.getScale=function(t){return t?f.set(t,this._lscale.x,this._lscale.y,this._lscale.z):f.copy(new f,this._lscale)},s.inverseTransformPoint=function(t,e){f.copy(t,e);for(var i=this,n=0;i._parent;)Je[n++]=i,i=i._parent;for(;n>=0;)f.transformInverseRTS(t,t,i._lrot,i._lpos,i._lscale),i=Je[--n];return t},s.setWorldPosition=function(t,e,i){void 0===e||void 0===i?f.copy(this._pos,t):f.set(this._pos,t,e,i),Nt.setVec3(this._poolHandle,Et.WORLD_POSITION,this._pos);var n=this._parent,s=this._lpos;n?(n.updateWorldTransform(),f.transformMat4(s,this._pos,O.invert(ni,n._mat))):f.copy(s,this._pos),this.invalidateChildren(wt.POSITION),1&this._eventMask&&this.emit(Ut.TRANSFORM_CHANGED,wt.POSITION)},s.getWorldPosition=function(t){return this.updateWorldTransform(),t?f.copy(t,this._pos):f.copy(new f,this._pos)},s.setWorldRotation=function(t,e,i,n){void 0===e||void 0===i||void 0===n?tt.copy(this._rot,t):tt.set(this._rot,t,e,i,n),Nt.setVec4(this._poolHandle,Et.WORLD_ROTATION,this._rot),this._parent?(this._parent.updateWorldTransform(),tt.multiply(this._lrot,tt.conjugate(this._lrot,this._parent._rot),this._rot)):tt.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(wt.ROTATION),1&this._eventMask&&this.emit(Ut.TRANSFORM_CHANGED,wt.ROTATION)},s.setWorldRotationFromEuler=function(t,e,i){tt.fromEuler(this._rot,t,e,i),this._parent?(this._parent.updateWorldTransform(),tt.multiply(this._lrot,tt.conjugate(this._lrot,this._parent._rot),this._rot)):tt.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(wt.ROTATION),1&this._eventMask&&this.emit(Ut.TRANSFORM_CHANGED,wt.ROTATION)},s.getWorldRotation=function(t){return this.updateWorldTransform(),t?tt.copy(t,this._rot):tt.copy(new tt,this._rot)},s.setWorldScale=function(t,e,i){void 0===e||void 0===i?f.copy(this._scale,t):f.set(this._scale,t,e,i),Nt.setVec3(this._poolHandle,Et.WORLD_SCALE,this._scale);var n=this._parent;n?(n.updateWorldTransform(),It.fromQuat(ei,tt.conjugate(ti,n._rot)),It.multiplyMat4(ei,ei,n._mat),ii.m00=this._scale.x,ii.m04=this._scale.y,ii.m08=this._scale.z,It.multiply(ei,ii,It.invert(ei,ei)),this._lscale.x=f.set(Ke,ei.m00,ei.m01,ei.m02).length(),this._lscale.y=f.set(Ke,ei.m03,ei.m04,ei.m05).length(),this._lscale.z=f.set(Ke,ei.m06,ei.m07,ei.m08).length()):f.copy(this._lscale,this._scale),this.invalidateChildren(wt.SCALE),1&this._eventMask&&this.emit(Ut.TRANSFORM_CHANGED,wt.SCALE)},s.getWorldScale=function(t){return this.updateWorldTransform(),t?f.copy(t,this._scale):f.copy(new f,this._scale)},s.getWorldMatrix=function(t){this.updateWorldTransform();var e=t||new O;return O.copy(e,this._mat)},s.getWorldRS=function(t){this.updateWorldTransform();var e=t||new O;return O.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e},s.getWorldRT=function(t){this.updateWorldTransform();var e=t||new O;return O.fromRT(e,this._rot,this._pos)},s.setRTS=function(t,e,i){var n=0;t&&(n|=wt.ROTATION,void 0!==t.w?(tt.copy(this._lrot,t),this._eulerDirty=!0):(f.copy(this._euler,t),tt.fromEuler(this._lrot,t.x,t.y,t.z),this._eulerDirty=!1)),e&&(f.copy(this._lpos,e),n|=wt.POSITION),i&&(f.copy(this._lscale,i),n|=wt.SCALE),n&&(this.invalidateChildren(n),1&this._eventMask&&this.emit(Ut.TRANSFORM_CHANGED,n))},s.pauseSystemEvents=function(t){xt.pauseTarget(this,t)},s.resumeSystemEvents=function(t){xt.resumeTarget(this,t)},e(n,[{key:"handle",get:function(){return this._poolHandle}},{key:"position",get:function(){return this._lpos},set:function(t){this.setPosition(t)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(t){this.setWorldPosition(t)}},{key:"rotation",get:function(){return this._lrot},set:function(t){this.setRotation(t)}},{key:"eulerAngles",set:function(t){this.setRotationFromEuler(t.x,t.y,t.z)},get:function(){return this._eulerDirty&&(tt.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler}},{key:"angle",get:function(){return this._euler.z},set:function(t){f.set(this._euler,0,0,t),tt.fromAngleZ(this._lrot,t),this._eulerDirty=!1,this.invalidateChildren(wt.ROTATION),1&this._eventMask&&this.emit(Ut.TRANSFORM_CHANGED,wt.ROTATION)}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(t){this.setWorldRotation(t)}},{key:"scale",get:function(){return this._lscale},set:function(t){this.setScale(t)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(t){this.setWorldScale(t)}},{key:"matrix",set:function(t){O.toRTS(t,this._lrot,this._lpos,this._lscale),this.invalidateChildren(wt.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(Ut.TRANSFORM_CHANGED,wt.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return f.transformQuat(new f,f.FORWARD,this.worldRotation)},set:function(t){var e=t.length();f.multiplyScalar(Ke,t,-1/e),tt.fromViewUp(qe,Ke),this.setWorldRotation(qe)}},{key:"layer",set:function(t){this._layer=t,Nt.set(this._poolHandle,Et.LAYER,this._layer),this.emit(Ut.LAYER_CHANGED,this._layer)},get:function(){return this._layer}},{key:"hasChangedFlags",get:function(){return si.get(this)||0},set:function(t){si.set(this,t),Nt.set(this._poolHandle,Et.FLAGS_CHANGED,t)}}]),n}(We),Fe.bookOfChange=si,Fe.EventType=Ut,Fe.NodeSpace=Gt,Fe.TransformDirtyBit=wt,Fe.TransformBit=wt,De=gt((Me=ke).prototype,"_lpos",[At],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new f}}),we=gt(Me.prototype,"_lrot",[At],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new tt}}),Pe=gt(Me.prototype,"_lscale",[At],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new f(1,1,1)}}),Be=gt(Me.prototype,"_layer",[At],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return c.Enum.DEFAULT}}),He=gt(Me.prototype,"_euler",[At],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new f}}),gt(Me.prototype,"eulerAngles",[Oe],Object.getOwnPropertyDescriptor(Me.prototype,"eulerAngles"),Me.prototype),gt(Me.prototype,"angle",[yt],Object.getOwnPropertyDescriptor(Me.prototype,"angle"),Me.prototype),gt(Me.prototype,"layer",[yt],Object.getOwnPropertyDescriptor(Me.prototype,"layer"),Me.prototype),Le=Me))||Le));u.Node=ri;var ai={parent:null,owner:null,subModelIdx:0},oi=t("d",(Ue=st("cc.RenderableComponent"),xe=St([Lt]),Ge=St(Lt),ze=Mt(),Ve=Dt(),Ue((Xe=function(t){function i(){for(var e,i=arguments.length,n=new Array(i),s=0;s<i;s++)n[s]=arguments[s];return e=t.call.apply(t,[this].concat(n))||this,at(e,"_materials",Ze,ot(e)),at(e,"_visFlags",Qe,ot(e)),e._materialInstances=[],e._models=[],e}p(i,t);var n=i.prototype;return n.getMaterial=function(t){return t<0||t>=this._materials.length?null:this._materials[t]},n.setMaterial=function(t,e){t&&t instanceof zt&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[e]=t;var i=this._materialInstances[e];i?i.parent!==this._materials[e]&&(i.destroy(),this._materialInstances[e]=null,this._onMaterialModified(e,this._materials[e])):this._onMaterialModified(e,this._materials[e])},n.getMaterialInstance=function(t){if(!this._materials[t])return null;if(!this._materialInstances[t]){ai.parent=this._materials[t],ai.owner=this,ai.subModelIdx=t;var e=new zt(ai);this.setMaterialInstance(t,e)}return this._materialInstances[t]},n.setMaterialInstance=function(t,e){e&&e.parent?e!==this._materialInstances[t]&&(this._materialInstances[t]=e,this._onMaterialModified(t,e)):e!==this._materials[t]&&this.setMaterial(e,t)},n.getRenderMaterial=function(t){return this._materialInstances[t]||this._materials[t]},n._collectModels=function(){return this._models},n._attachToScene=function(){},n._detachFromScene=function(){},n._onMaterialModified=function(){},n._onRebuildPSO=function(){},n._clearMaterials=function(){},n._onVisibilityChange=function(){},e(i,[{key:"visibility",get:function(){return this._visFlags},set:function(t){this._visFlags=t,this._onVisibilityChange(t)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(t){for(var e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setMaterial(t[e],e);if(t.length<this._materials.length){for(var i=t.length;i<this._materials.length;i++)this.setMaterial(null,i);this._materials.splice(t.length)}}},{key:"materials",get:function(){for(var t=0;t<this._materials.length;t++)this._materialInstances[t]=this.getMaterialInstance(t);return this._materialInstances},set:function(t){var e=t.length-this._materials.length;if(e>0)this._materials.length=t.length,this._materialInstances.length=t.length;else if(e<0)for(var i=this._materials.length-e;i<this._materials.length;++i)this.setMaterialInstance(i,null);for(var n=0;n<this._materialInstances.length;n++)this._materialInstances[n]!=t[n]&&this.setMaterialInstance(n,t[n])}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(t){1===this._materials.length&&this._materials[0]===t||this.setMaterialInstance(0,t)}}]),i}(ft),Ze=gt((Ye=Xe).prototype,"_materials",[xe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Qe=gt(Ye.prototype,"_visFlags",[At],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return c.Enum.NONE}}),gt(Ye.prototype,"sharedMaterials",[Ge,ze,Ve],Object.getOwnPropertyDescriptor(Ye.prototype,"sharedMaterials"),Ye.prototype),je=Ye))||je));u.RenderableComponent=oi}}}));
