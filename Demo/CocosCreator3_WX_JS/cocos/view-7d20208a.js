System.register(["./coordinates-converts-utils-bf8713a9.js","./event-enum-5a5aa40e.js","./deprecated-3.0.0-f3f53c89.js"],(function(e){"use strict";var t,i,n,r,s,a,o,h,u,c,d,l,_,f,p,g,v,m,E,w,S,y,T,O,b,A,R,F,I,B,P,L,N,D,C,x,M,z,U,H,G,V,W,k,Q,X,Y,j,Z,q,K,J,$,ee,te,ie,ne,re,se,ae,oe,he,ue,ce,de,le,_e,fe,pe,ge,ve,me,Ee,we,Se,ye,Te,Oe,be,Ae,Re,Fe,Ie,Be,Pe,Le,Ne,De,Ce,xe,Me,ze,Ue,He,Ge,Ve,We,ke,Qe,Xe,Ye,je,Ze,qe,Ke,Je,$e,et,tt,it,nt,rt,st,at,ot,ht,ut,ct,dt,lt,_t;return{setters:[function(e){t=e.e2,i=e.e4,n=e.e5,r=e.l,s=e.e7,a=e.ea,o=e.eb,h=e.ec,u=e.e3,c=e.dq,d=e.ed,l=e.co,_=e.c5,f=e.e8,p=e.ah,g=e.ag,v=e.a5,m=e.dz,E=e.dA,w=e.R,S=e.C,y=e.aj,T=e.ai,O=e.a2,b=e.ee,A=e.a3,R=e.ef,F=e.b9,I=e.B,B=e.v,P=e.M,L=e.A,N=e.F,D=e.I,C=e.b2,x=e.P,M=e.eg,z=e.bg,U=e.cM,H=e.cN,G=e.dX,V=e.eh,W=e.ei,k=e.ej,Q=e.ct,X=e.X,Y=e.Y,j=e.ek,Z=e.el,q=e.Q,K=e.b4,J=e.bw,$=e.e0,ee=e.bE,te=e.cO,ie=e.cP,ne=e.cW,re=e.cV,se=e.cX,ae=e.cc,oe=e.cb,he=e.c0,ue=e.e9,ce=e.dY,de=e.an,le=e.am,_e=e.a4,fe=e.dc,pe=e.d0,ge=e.da,ve=e.em,me=e.dG,Ee=e.dH,we=e.dJ,Se=e.dT,ye=e.dl,Te=e.en,Oe=e.bD,be=e.a1,Ae=e.aH,Re=e.aG,Fe=e.f,Ie=e.d4,Be=e.b0,Pe=e.c,Le=e.cl,Ne=e.ck,De=e.bf,Ce=e.d,xe=e.a,Me=e.eo,ze=e.ep,Ue=e.ch,He=e.cj,Ge=e.eq,Ve=e.ci,We=e.dj,ke=e.er,Qe=e.e,Xe=e.w,Ye=e.c3,je=e.bc,Ze=e.es,qe=e.et,Ke=e.eu,Je=e.be},function(e){$e=e.i,et=e.h,tt=e.S,it=e.L,nt=e.I,rt=e.A,st=e.j,at=e.m,ot=e.l,ht=e.E,ut=e.o,ct=e.p},function(e){dt=e.A,lt=e.S,_t=e.i}],execute:function(){var ft,pt,gt,vt,mt,Et,wt,St,yt,Tt,Ot,bt,At,Rt,Ft,It,Bt,Pt,Lt,Nt,Dt,Ct,xt,Mt=e("c",(ft=t("RenderStage"),pt=o(),gt=o(),vt=o(),ft((Tt=function(){function e(){s(this,"_name",wt,this),s(this,"_priority",St,this),s(this,"_tag",yt,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0},t.activate=function(e,t){this._pipeline=e,this._flow=t},i(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}}]),e}(),wt=n((Et=Tt).prototype,"_name",[pt,a],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),St=n(Et.prototype,"_priority",[gt,a],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yt=n(Et.prototype,"_tag",[vt,a],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mt=Et))||mt));r.RenderStage=Mt;var zt,Ut,Ht,Gt,Vt,Wt,kt,Qt,Xt,Yt=e("b",(Ot=t("RenderFlow"),bt=o(),At=o(),Rt=o(),Ft=o(),It=h([Mt]),Ot((xt=function(){function e(){s(this,"_name",Lt,this),s(this,"_priority",Nt,this),s(this,"_tag",Dt,this),s(this,"_stages",Ct,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,this._stages=e.stages,e.tag&&(this._tag=e.tag),!0},t.activate=function(e){this._pipeline=e,this._stages.sort((function(e,t){return e.priority-t.priority}));for(var t=0,i=this._stages.length;t<i;t++)this._stages[t].activate(e,this)},t.render=function(e){for(var t=0,i=this._stages.length;t<i;t++)this._stages[t].render(e)},t.destroy=function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0},i(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}}]),e}(),Lt=n((Pt=xt).prototype,"_name",[bt,a],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Nt=n(Pt.prototype,"_priority",[At,a],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Dt=n(Pt.prototype,"_tag",[Rt,a],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ct=n(Pt.prototype,"_stages",[Ft,It,a],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Bt=Pt))||Bt));r.RenderFlow=Yt;var jt,Zt,qt=e("a",(zt=t("cc.RenderPipeline"),Ut=o(),Ht=o(),Gt=h([Yt]),zt((Xt=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return t=e.call.apply(e,[this].concat(n))||this,s(t,"_tag",kt,f(t)),s(t,"_flows",Qt,f(t)),t._macros={},t._commandBuffers=[],t}u(t,e);var n=t.prototype;return n.initialize=function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0},n.activate=function(){this._device=r.director.root.device;var e=new c(d.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(e),this._descriptorSet=this._device.createDescriptorSet(new l(this._descriptorSetLayout));for(var t=0;t<this._flows.length;t++)this._flows[t].activate(this);return!0},n.render=function(e){for(var t=0;t<this.flows.length;t++)for(var i=0;i<e.length;i++){var n=e[i];this.flows[t].render(n)}},n.destroy=function(){for(var t=0;t<this._flows.length;t++)this._flows[t].destroy();this._flows.length=0,this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null);for(var i=0;i<this._commandBuffers.length;i++)this._commandBuffers[i].destroy();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},i(t,[{key:"macros",get:function(){return this._macros}},{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"device",get:function(){return this._device}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}}]),t}(_),kt=n((Wt=Xt).prototype,"_tag",[Ut,a],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Qt=n(Wt.prototype,"_flows",[Ht,Gt,a],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vt=Wt))||Vt));r.RenderPipeline=qt,function(e){e[e.FORWARD=10]="FORWARD",e[e.UI=20]="UI"}(jt||(jt={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(Zt||(Zt={}));var Kt=e("P",function(){function e(){}return e.getOrCreatePipelineState=function(e,t,i,n,r){var s=t.handle,a=p.get(s,g.HASH)^n.hash^r.attributesHash^i.id,o=this._PSOHashMap.get(a);if(!o){var h=v.get(p.get(s,g.PIPELINE_LAYOUT)),u=new m(r.attributes),c=new E(i,h,n,u,t.rasterizerState,t.depthStencilState,t.blendState,p.get(s,g.PRIMITIVE),p.get(s,g.DYNAMIC_STATES));o=e.createPipelineState(c),this._PSOHashMap.set(a,o)}return o},e}());function Jt(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function $t(e,t){return e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}Kt._PSOHashMap=new Map;var ei=function(){function e(e){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=e,this._passPool=new w((function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new S(64,this._passDesc.sortFunc)}var t=e.prototype;return t.clear=function(){this.queue.clear(),this._passPool.reset()},t.insertRenderPass=function(e,t,i){var n=e.model.subModels[t],r=y.get(n.handle,T.PASS_0+i);if(n.passes[i].blendState.targets[0].blend!==this._passDesc.isTransparent||!(p.get(r,g.PHASE)&this._passDesc.phases))return!1;var s=0|p.get(r,g.PRIORITY)<<16|n.priority<<8|i,a=this._passPool.add();return a.hash=s,a.depth=e.depth||0,a.shaderId=y.get(n.handle,T.SHADER_0+i),a.subModel=n,a.passIdx=i,this.queue.push(a),!0},t.sort=function(){this.queue.sort()},t.recordCommandBuffer=function(e,t,i){for(var n=0;n<this.queue.length;++n){var r=this.queue.array[n],s=r.subModel,a=r.passIdx,o=s.inputAssembler,h=s.handle,u=s.passes[a],c=O.get(y.get(h,T.SHADER_0+a)),d=Kt.getOrCreatePipelineState(e,u,c,t,o);i.bindPipelineState(d),i.bindDescriptorSet(b.MATERIAL,u.descriptorSet),i.bindDescriptorSet(b.LOCAL,s.descriptorSet),i.bindInputAssembler(o),i.draw(o)}},e}(),ti=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),i=t.next();!i.done;){for(var n=0;n<i.value.batches.length;++n){var r=i.value.batches[n];if(r.mergeCount){for(var s=0;s<r.vbs.length;++s)r.vbs[s].update(r.vbDatas[s]);e.updateBuffer(r.vbIdx,r.vbIdxData.buffer),e.updateBuffer(r.ubo,r.uboData)}}i=t.next()}},t.recordCommandBuffer=function(e,t,i){for(var n=this.queue.values(),r=n.next();!r.done;){for(var s=!1,a=0;a<r.value.batches.length;++a){var o=r.value.batches[a];if(o.mergeCount){if(!s){var h=O.get(o.hShader),u=Kt.getOrCreatePipelineState(e,o.pass,h,t,o.ia);i.bindPipelineState(u),i.bindDescriptorSet(b.MATERIAL,o.pass.descriptorSet),s=!0}i.bindDescriptorSet(b.LOCAL,o.descriptorSet,r.value.dynamicOffsets),i.bindInputAssembler(o.ia),i.draw(o.ia)}}r=n.next()}},e}(),ii=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),i=t.next();!i.done;)i.value.hasPendingModels&&i.value.uploadBuffers(e),i=t.next()},t.recordCommandBuffer=function(e,t,i){for(var n=this.queue.values(),r=n.next();!r.done;){var s=r.value,a=s.instances,o=s.pass;if(s.hasPendingModels){i.bindDescriptorSet(b.MATERIAL,o.descriptorSet);for(var h=null,u=0;u<a.length;++u){var c=a[u];if(c.count){var d=O.get(c.hShader),l=Kt.getOrCreatePipelineState(e,o,d,t,c.ia);h!==l&&(i.bindPipelineState(l),h=l),i.bindDescriptorSet(b.LOCAL,A.get(c.hDescriptorSet),r.value.dynamicOffsets),i.bindInputAssembler(c.ia),i.draw(c.ia)}}}r=n.next()}},e}(),ni=function(){function e(e){this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=e.device}e.get=function(t,i){void 0===i&&(i=0);var n=e._buffers;n.has(t)||n.set(t,{});var r=n.get(t);return r[i]||(r[i]=new e(t))};var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],i=0;i<t.vbs.length;++i)t.vbs[i].destroy();t.vbIdx.destroy(),t.ia.destroy(),t.ubo.destroy()}this.batches.length=0},t.merge=function(e,t,i){var n=e.subMesh.flatBuffers;if(0!==n.length){for(var r=0,s=0,a=n[0].count,o=e.passes[t],h=y.get(e.handle,T.SHADER_0+t),u=e.descriptorSet,c=!1,d=0;d<this.batches.length;++d){var l=this.batches[d];if(l.vbs.length===n.length&&l.mergeCount<R.BATCHING_COUNT){c=!0;for(var _=0;_<l.vbs.length;++_)if(l.vbs[_].stride!==n[_].stride){c=!1;break}if(c){for(var f=0;f<l.vbs.length;++f){var p=n[f],g=l.vbs[f],v=l.vbDatas[f];(r=(a+l.vbCount)*p.stride)>g.size&&(g.resize(r),l.vbDatas[f]=new Uint8Array(r),l.vbDatas[f].set(v)),l.vbDatas[f].set(p.buffer,l.vbCount*p.stride)}var m=l.vbIdxData;(s=4*(a+l.vbCount))>l.vbIdx.size&&(l.vbIdx.resize(s),l.vbIdxData=new Float32Array(s/Float32Array.BYTES_PER_ELEMENT),l.vbIdxData.set(m),m=l.vbIdxData);var E=l.vbCount,w=E+a,S=l.mergeCount;if(m[E]!==S||m[w-1]!==S)for(var O=E;O<w;O++)m[O]=S+.1;return F.toArray(l.uboData,i.transform.worldMatrix,R.MAT_WORLDS_OFFSET+16*l.mergeCount),l.mergeCount||(u.bindBuffer(R.BINDING,l.ubo),u.update(),l.pass=o,l.hShader=h,l.descriptorSet=u),++l.mergeCount,l.vbCount+=a,void(l.ia.vertexCount+=a)}}}for(var b=[],A=[],C=[],x=0;x<n.length;++x){var M=n[x],z=this._device.createBuffer(new I(B.VERTEX|B.TRANSFER_DST,P.HOST|P.DEVICE,M.count*M.stride,M.stride));z.update(M.buffer.buffer),b.push(z),A.push(new Uint8Array(z.size)),C.push(z)}var U=this._device.createBuffer(new I(B.VERTEX|B.TRANSFER_DST,P.HOST|P.DEVICE,4*a,4)),H=new Float32Array(a);H.fill(0),U.update(H),C.push(U);for(var G=e.inputAssembler.attributes,V=new Array(G.length+1),W=0;W<G.length;++W)V[W]=G[W];V[G.length]=new L("a_dyn_batch_id",N.R32F,!1,n.length);var k=new D(V,C),Q=this._device.createInputAssembler(k),X=this._device.createBuffer(new I(B.UNIFORM|B.TRANSFER_DST,P.HOST|P.DEVICE,R.SIZE,R.SIZE));u.bindBuffer(R.BINDING,X),u.update();var Y=new Float32Array(R.COUNT);F.toArray(Y,i.transform.worldMatrix,R.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:b,vbDatas:A,vbIdx:U,vbIdxData:H,vbCount:a,ia:Q,ubo:X,uboData:Y,pass:o,hShader:h,descriptorSet:u})}},t.clear=function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}},e}();ni._buffers=new Map;var ri=new C,si=new C,ai=new C,oi=new F,hi=new dt,ui=!1,ci=[],di=lt.create(0,0,0,1),li=new x((function(){return{model:null,depth:0}}),128),_i=new x((function(){return{model:null,depth:0}}),128);function fi(e,t){var i=0;e.node&&(C.subtract(ri,e.node.worldPosition,t.position),i=C.dot(ri,t.forward));var n=li.alloc();return n.model=e,n.depth=i,n}function pi(e,t){var i=0;e.node&&(C.subtract(ri,e.node.worldPosition,t.position),i=C.dot(ri,t.forward));var n=_i.alloc();return n.model=e,n.depth=i,n}function gi(e,t,i,n){var r=e.shadows;C.negate(si,i);var s=r.sphere.radius*$e.COEFFICIENT_OF_EXPANSION;return C.multiplyScalar(ai,si,s),C.add(ai,ai,r.sphere.center),n.set(ai),F.fromRT(oi,t,ai),oi}function vi(e,t,i){var n=t.direction,r=e.normal,s=e.distance+.001,a=1/C.dot(r,n),o=n.x*a,h=n.y*a,u=n.z*a,c=r.x,d=r.y,l=r.z,_=e.matLight;_.m00=1-c*o,_.m01=-c*h,_.m02=-c*u,_.m03=0,_.m04=-d*o,_.m05=1-d*h,_.m06=-d*u,_.m07=0,_.m08=-l*o,_.m09=-l*h,_.m10=1-l*u,_.m11=0,_.m12=o*s,_.m13=h*s,_.m14=u*s,_.m15=1,F.toArray(i,_,M.MAT_LIGHT_PLANE_PROJ_OFFSET)}var mi=[U.LINEAR,U.LINEAR,U.NONE,H.CLAMP,H.CLAMP,H.CLAMP],Ei=new x((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),wi=new Float32Array(4),Si=lt.create(0,0,0,1),yi=[],Ti=[],Oi=new F,bi=new F;function Ai(e,t){return!(!t.worldBounds||_t.aabbWithAABB(t.worldBounds,e.aabb))}function Ri(e,t){return!(!t.worldBounds||_t.aabbWithAABB(t.worldBounds,e.aabb)&&_t.aabbFrustum(t.worldBounds,e.frustum))}var Fi=G("forward-add"),Ii=[];function Bi(e,t){t.length=0;for(var i=!1,n=0;n<e.length;n++){for(var r=e[n].passes,s=-1,a=0;a<r.length;a++)if(r[a].phase===Fi){s=a,i=!0;break}t.push(s)}return i}var Pi,Li,Ni,Di,Ci,xi,Mi,zi,Ui,Hi,Gi,Vi,Wi,ki,Qi,Xi,Yi,ji,Zi,qi,Ki,Ji,$i,en,tn,nn,rn,sn,an,on,hn,un,cn,dn,ln,_n,fn,pn,gn,vn,mn,En,wn,Sn,yn,Tn,On,bn,An,Rn,Fn,In,Bn,Pn,Ln,Nn,Dn,Cn,xn,Mn,zn,Un,Hn,Gn,Vn,Wn,kn,Qn,Xn,Yn,jn,Zn,qn,Kn,Jn,$n,er,tr,ir,nr,rr=function(){function e(e){this._pipeline=void 0,this._device=void 0,this._validLights=[],this._lightPasses=[],this._descriptorSetMap=new Map,this._globalUBO=new Float32Array(V.COUNT),this._cameraUBO=new Float32Array(W.COUNT),this._shadowUBO=new Float32Array(M.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._isHDR=void 0,this._fpScale=void 0,this._renderObjects=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._sampler=null,this._pipeline=e,this._device=e.device,this._isHDR=e.isHDR,this._fpScale=e.fpScale,this._renderObjects=e.renderObjects,this._instancedQueue=new ii,this._batchedQueue=new ti,this._lightBufferStride=Math.ceil(k.SIZE/this._device.uboOffsetAlignment)*this._device.uboOffsetAlignment,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new I(B.UNIFORM|B.TRANSFER_DST,P.HOST|P.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new Q(this._lightBuffer,0,k.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount);var t=X(mi);this._sampler=Y.getSampler(this._device,t)}var t=e.prototype;return t.clear=function(){this._instancedQueue.clear(),this._batchedQueue.clear(),this._validLights.length=0;for(var e=0;e<this._lightPasses.length;e++){var t=this._lightPasses[e];t.dynamicOffsets.length=0,t.lights.length=0}Ei.freeArray(this._lightPasses),this._lightPasses.length=0},t.destroy=function(){for(var e=Array.from(this._descriptorSetMap.values()),t=0;t<e.length;++t){var i=e[t];i&&(i.getBuffer(V.BINDING).destroy(),i.getBuffer(M.BINDING).destroy(),i.getSampler(j).destroy(),i.getSampler(Z).destroy(),i.getTexture(j).destroy(),i.getTexture(Z).destroy(),i.destroy())}this._descriptorSetMap.clear()},t.gatherLightPasses=function(e,t){var i=this._validLights;if(this.clear(),this._gatherValidLights(e,i),i.length){this._updateUBOs(e,t),this._updateLightDescriptorSet(e,t);for(var n=0;n<this._renderObjects.length;n++){var r=this._renderObjects[n].model,s=r.subModels;if(Bi(s,Ii)&&(Ti.length=0,this._lightCulling(r,i),Ti.length))for(var a=0;a<s.length;a++){var o=Ii[a];if(!(o<0)){var h=s[a],u=h.passes[o];h.descriptorSet.bindBuffer(k.BINDING,this._firstLightBufferView),h.descriptorSet.update(),this._addRenderQueue(u,h,r,o,i)}}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)}},t.recordCommandBuffer=function(e,t,i){this._instancedQueue.recordCommandBuffer(e,t,i),this._batchedQueue.recordCommandBuffer(e,t,i);for(var n=0;n<this._lightPasses.length;n++){var r=this._lightPasses[n],s=r.subModel,a=r.passIdx,o=r.dynamicOffsets,h=r.lights,u=O.get(y.get(s.handle,T.SHADER_0+a)),c=s.passes[a],d=s.inputAssembler,l=Kt.getOrCreatePipelineState(e,c,u,t,d),_=A.get(p.get(c.handle,g.DESCRIPTOR_SET)),f=s.descriptorSet;i.bindPipelineState(l),i.bindDescriptorSet(b.MATERIAL,_),i.bindInputAssembler(d);for(var v=0;v<o.length;++v){var m=h[v],E=this._getOrCreateDescriptorSet(m);yi[0]=o[v],i.bindDescriptorSet(b.GLOBAL,E),i.bindDescriptorSet(b.LOCAL,f,yi),i.draw(d)}}},t._gatherValidLights=function(e,t){for(var i=e.scene.sphereLights,n=0;n<i.length;n++){var r=i[n];r.baked||(lt.set(Si,r.position.x,r.position.y,r.position.z,r.range),_t.sphereFrustum(Si,e.frustum)&&(t.push(r),this._getOrCreateDescriptorSet(r)))}for(var s=e.scene.spotLights,a=0;a<s.length;a++){var o=s[a];o.baked||(lt.set(Si,o.position.x,o.position.y,o.position.z,o.range),_t.sphereFrustum(Si,e.frustum)&&(t.push(o),this._getOrCreateDescriptorSet(o)))}},t._lightCulling=function(e,t){for(var i=0;i<t.length;i++){var n=t[i],r=!1;switch(n.type){case it.SPHERE:r=Ai(n,e);break;case it.SPOT:r=Ri(n,e)}r||Ti.push(i)}},t._addRenderQueue=function(e,t,i,n,r){var s=e.batchingScheme;if(s===q.INSTANCING)for(var a=0;a<Ti.length;a++){var o=Ti[a],h=nt.get(e,o);h.merge(t,i.instancedAttributes,n),h.dynamicOffsets[0]=this._lightBufferStride*o,this._instancedQueue.queue.add(h)}else if(s===q.VB_MERGING)for(var u=0;u<Ti.length;u++){var c=Ti[u],d=ni.get(e,c);d.merge(t,n,i),d.dynamicOffsets[0]=this._lightBufferStride*c,this._batchedQueue.queue.add(d)}else{var l=Ei.alloc();l.subModel=t,l.passIdx=n;for(var _=0;_<Ti.length;_++){var f=Ti[_];l.lights.push(r[f]),l.dynamicOffsets.push(this._lightBufferStride*f)}this._lightPasses.push(l)}},t._updateLightDescriptorSet=function(e,t){for(var i=this._pipeline.shadows,n=e.scene.mainLight,r=0;r<this._validLights.length;r++){var s=this._validLights[r],a=this._getOrCreateDescriptorSet(s);if(a){switch(this._updateGlobalDescriptorSet(e,t),s.type){case it.SPHERE:n&&vi(i,n,this._shadowUBO),z.toArray(this._shadowUBO,i.shadowColor,M.SHADOW_COLOR_OFFSET),this._shadowUBO[M.SHADOW_INFO_OFFSET+0]=i.size.x,this._shadowUBO[M.SHADOW_INFO_OFFSET+1]=i.size.y,this._shadowUBO[M.SHADOW_INFO_OFFSET+2]=i.pcf,this._shadowUBO[M.SHADOW_INFO_OFFSET+3]=i.bias;break;case it.SPOT:if(n&&vi(i,n,this._shadowUBO),F.invert(Oi,s.node.getWorldMatrix()),F.perspective(bi,s.spotAngle,s.aspect,.001,s.range),F.multiply(bi,bi,Oi),F.toArray(this._shadowUBO,bi,M.MAT_LIGHT_VIEW_PROJ_OFFSET),z.toArray(this._shadowUBO,i.shadowColor,M.SHADOW_COLOR_OFFSET),this._shadowUBO[M.SHADOW_INFO_OFFSET+0]=i.size.x,this._shadowUBO[M.SHADOW_INFO_OFFSET+1]=i.size.y,this._shadowUBO[M.SHADOW_INFO_OFFSET+2]=i.pcf,this._shadowUBO[M.SHADOW_INFO_OFFSET+3]=i.bias,this._pipeline.shadowFrameBufferMap.has(s)&&this._pipeline.shadowFrameBufferMap.has(s)){var o,h=null===(o=this._pipeline.shadowFrameBufferMap.get(s))||void 0===o?void 0:o.colorTextures[0];h&&a.bindTexture(Z,h)}}a.update(),t.updateBuffer(a.getBuffer(V.BINDING),this._globalUBO),t.updateBuffer(a.getBuffer(W.BINDING),this._cameraUBO),t.updateBuffer(a.getBuffer(M.BINDING),this._shadowUBO)}}},t._updateGlobalDescriptorSet=function(e){var t=r.director.root,i=this._pipeline.device,n=this._globalUBO,s=Math.floor(i.width),a=Math.floor(i.height);n[V.TIME_OFFSET]=t.cumulativeTime,n[V.TIME_OFFSET+1]=t.frameTime,n[V.TIME_OFFSET+2]=r.director.getTotalFrames(),n[V.SCREEN_SIZE_OFFSET]=i.width,n[V.SCREEN_SIZE_OFFSET+1]=i.height,n[V.SCREEN_SIZE_OFFSET+2]=1/i.width,n[V.SCREEN_SIZE_OFFSET+3]=1/i.height,n[V.NATIVE_SIZE_OFFSET]=s,n[V.NATIVE_SIZE_OFFSET+1]=a,n[V.NATIVE_SIZE_OFFSET+2]=1/n[V.NATIVE_SIZE_OFFSET],n[V.NATIVE_SIZE_OFFSET+3]=1/n[V.NATIVE_SIZE_OFFSET+1],this._updateCameraUBO(e)},t._updateCameraUBO=function(e){var t=this._pipeline,i=e.scene.mainLight,n=t.ambient,r=t.shadingScale,s=this._pipeline.device,a=Math.floor(s.width),o=Math.floor(s.height),h=t.fog,u=this._cameraUBO;u[W.SCREEN_SCALE_OFFSET]=e.width/a*r,u[W.SCREEN_SCALE_OFFSET+1]=e.height/o*r,u[W.SCREEN_SCALE_OFFSET+2]=1/u[W.SCREEN_SCALE_OFFSET],u[W.SCREEN_SCALE_OFFSET+3]=1/u[W.SCREEN_SCALE_OFFSET+1];var c=e.exposure;if(u[W.EXPOSURE_OFFSET]=c,u[W.EXPOSURE_OFFSET+1]=1/c,u[W.EXPOSURE_OFFSET+2]=this._isHDR?1:0,u[W.EXPOSURE_OFFSET+3]=this._fpScale/c,i){if(C.toArray(u,i.direction,W.MAIN_LIT_DIR_OFFSET),C.toArray(u,i.color,W.MAIN_LIT_COLOR_OFFSET),i.useColorTemperature){var d=i.colorTemperatureRGB;u[W.MAIN_LIT_COLOR_OFFSET]*=d.x,u[W.MAIN_LIT_COLOR_OFFSET+1]*=d.y,u[W.MAIN_LIT_COLOR_OFFSET+2]*=d.z}this._isHDR?u[W.MAIN_LIT_COLOR_OFFSET+3]=i.illuminance*this._fpScale:u[W.MAIN_LIT_COLOR_OFFSET+3]=i.illuminance*c}else C.toArray(u,C.UNIT_Z,W.MAIN_LIT_DIR_OFFSET),K.toArray(u,K.ZERO,W.MAIN_LIT_COLOR_OFFSET);F.toArray(u,e.matView,W.MAT_VIEW_OFFSET),F.toArray(u,e.node.worldMatrix,W.MAT_VIEW_INV_OFFSET),F.toArray(u,e.matProj,W.MAT_PROJ_OFFSET),F.toArray(u,e.matProjInv,W.MAT_PROJ_INV_OFFSET),F.toArray(u,e.matViewProj,W.MAT_VIEW_PROJ_OFFSET),F.toArray(u,e.matViewProjInv,W.MAT_VIEW_PROJ_INV_OFFSET),C.toArray(u,e.position,W.CAMERA_POS_OFFSET);var l=s.screenSpaceSignY;e.window.hasOffScreenAttachments&&(l*=s.UVSpaceSignY),u[W.CAMERA_POS_OFFSET+3]=l;var _=n.colorArray;this._isHDR?_[3]=n.skyIllum*this._fpScale:_[3]=n.skyIllum*c,u.set(_,W.AMBIENT_SKY_OFFSET),u.set(n.albedoArray,W.AMBIENT_GROUND_OFFSET),h.enabled&&(u.set(h.colorArray,W.GLOBAL_FOG_COLOR_OFFSET),u[W.GLOBAL_FOG_BASE_OFFSET]=h.fogStart,u[W.GLOBAL_FOG_BASE_OFFSET+1]=h.fogEnd,u[W.GLOBAL_FOG_BASE_OFFSET+2]=h.fogDensity,u[W.GLOBAL_FOG_ADD_OFFSET]=h.fogTop,u[W.GLOBAL_FOG_ADD_OFFSET+1]=h.fogRange,u[W.GLOBAL_FOG_ADD_OFFSET+2]=h.fogAtten)},t._updateUBOs=function(e,t){var i=e.exposure;this._validLights.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=J(this._validLights.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new Q(this._lightBuffer,0,k.SIZE)));for(var n=0,r=0;n<this._validLights.length;n++,r+=this._lightBufferElementCount){var s=this._validLights[n];switch(s.type){case it.SPHERE:if(C.toArray(wi,s.position),wi[3]=0,this._lightBufferData.set(wi,r+k.LIGHT_POS_OFFSET),wi[0]=s.size,wi[1]=s.range,wi[2]=0,this._lightBufferData.set(wi,r+k.LIGHT_SIZE_RANGE_ANGLE_OFFSET),C.toArray(wi,s.color),s.useColorTemperature){var a=s.colorTemperatureRGB;wi[0]*=a.x,wi[1]*=a.y,wi[2]*=a.z}this._isHDR?wi[3]=s.luminance*this._fpScale*this._lightMeterScale:wi[3]=s.luminance*i*this._lightMeterScale,this._lightBufferData.set(wi,r+k.LIGHT_COLOR_OFFSET);break;case it.SPOT:if(C.toArray(wi,s.position),wi[3]=1,this._lightBufferData.set(wi,r+k.LIGHT_POS_OFFSET),wi[0]=s.size,wi[1]=s.range,wi[2]=s.spotAngle,this._lightBufferData.set(wi,r+k.LIGHT_SIZE_RANGE_ANGLE_OFFSET),C.toArray(wi,s.direction),this._lightBufferData.set(wi,r+k.LIGHT_DIR_OFFSET),C.toArray(wi,s.color),s.useColorTemperature){var o=s.colorTemperatureRGB;wi[0]*=o.x,wi[1]*=o.y,wi[2]*=o.z}this._isHDR?wi[3]=s.luminance*this._fpScale*this._lightMeterScale:wi[3]=s.luminance*i*this._lightMeterScale,this._lightBufferData.set(wi,r+k.LIGHT_COLOR_OFFSET)}}t.updateBuffer(this._lightBuffer,this._lightBufferData)},t._getOrCreateDescriptorSet=function(e){if(!this._descriptorSetMap.has(e)){var t=this._device,i=t.createDescriptorSet(new l(this._pipeline.descriptorSetLayout)),n=t.createBuffer(new I(B.UNIFORM|B.TRANSFER_DST,P.HOST|P.DEVICE,V.SIZE,V.SIZE));i.bindBuffer(V.BINDING,n);var r=t.createBuffer(new I(B.UNIFORM|B.TRANSFER_DST,P.HOST|P.DEVICE,W.SIZE,W.SIZE));i.bindBuffer(W.BINDING,r);var s=t.createBuffer(new I(B.UNIFORM|B.TRANSFER_DST,P.HOST|P.DEVICE,M.SIZE,M.SIZE));return i.bindBuffer(M.BINDING,s),i.bindSampler(j,this._sampler),i.bindTexture(j,$.get("default-texture").getGFXTexture()),i.bindSampler(Z,this._sampler),i.bindTexture(Z,$.get("default-texture").getGFXTexture()),i.update(),this._descriptorSetMap.set(e,i),i}return this._descriptorSetMap.get(e)},e}();ee(te),ee(ie),ee(ne),ee(re),ee(se),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(nr||(nr={})),ee(nr),Pi=t("RenderTextureDesc"),Li=h(te),Ni=h(ie),Di=h(N),Pi((xi=n((Ci=function(){s(this,"name",xi,this),s(this,"type",Mi,this),s(this,"usage",zi,this),s(this,"format",Ui,this),s(this,"width",Hi,this),s(this,"height",Gi,this)}).prototype,"name",[a,ue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Mi=n(Ci.prototype,"type",[Li],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return te.TEX2D}}),zi=n(Ci.prototype,"usage",[Ni],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ie.COLOR_ATTACHMENT}}),Ui=n(Ci.prototype,"format",[Di],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return N.UNKNOWN}}),Hi=n(Ci.prototype,"width",[a,ue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Gi=n(Ci.prototype,"height",[a,ue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Ci));var sr,ar=(Vi=t("RenderTextureConfig"),Wi=h(ae),Vi((Xi=n((Qi=function(){s(this,"name",Xi,this),s(this,"texture",Yi,this)}).prototype,"name",[a,ue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Yi=n(Qi.prototype,"texture",[Wi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ki=Qi))||ki),or=(ji=t("MaterialConfig"),Zi=h(oe),ji((Ji=n((Ki=function(){s(this,"name",Ji,this),s(this,"material",$i,this)}).prototype,"name",[a,ue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),$i=n(Ki.prototype,"material",[Zi],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qi=Ki))||qi),hr=(en=t("FrameBufferDesc"),tn=h([he]),nn=h(ae),en((sn=n((rn=function(){s(this,"name",sn,this),s(this,"renderPass",an,this),s(this,"colorTextures",on,this),s(this,"depthStencilTexture",hn,this),s(this,"texture",un,this)}).prototype,"name",[a,ue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),an=n(rn.prototype,"renderPass",[a,ue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),on=n(rn.prototype,"colorTextures",[tn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),hn=n(rn.prototype,"depthStencilTexture",[a,ue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),un=n(rn.prototype,"texture",[nn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rn)),cn=t("ColorDesc"),dn=h(N),ln=h(re),_n=h(ne),fn=h(se),pn=h(se),cn((mn=n((vn=function(){s(this,"format",mn,this),s(this,"loadOp",En,this),s(this,"storeOp",wn,this),s(this,"sampleCount",Sn,this),s(this,"beginLayout",yn,this),s(this,"endLayout",Tn,this)}).prototype,"format",[dn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return N.UNKNOWN}}),En=n(vn.prototype,"loadOp",[ln],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return re.CLEAR}}),wn=n(vn.prototype,"storeOp",[_n],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ne.STORE}}),Sn=n(vn.prototype,"sampleCount",[a,ue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),yn=n(vn.prototype,"beginLayout",[fn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return se.UNDEFINED}}),Tn=n(vn.prototype,"endLayout",[pn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return se.PRESENT_SRC}}),gn=vn))||gn),ur=(On=t("DepthStencilDesc"),bn=h(N),An=h(re),Rn=h(ne),Fn=h(re),In=h(ne),Bn=h(se),Pn=h(se),On((Dn=n((Nn=function(){s(this,"format",Dn,this),s(this,"depthLoadOp",Cn,this),s(this,"depthStoreOp",xn,this),s(this,"stencilLoadOp",Mn,this),s(this,"stencilStoreOp",zn,this),s(this,"sampleCount",Un,this),s(this,"beginLayout",Hn,this),s(this,"endLayout",Gn,this)}).prototype,"format",[bn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return N.UNKNOWN}}),Cn=n(Nn.prototype,"depthLoadOp",[An],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return re.CLEAR}}),xn=n(Nn.prototype,"depthStoreOp",[Rn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ne.STORE}}),Mn=n(Nn.prototype,"stencilLoadOp",[Fn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return re.CLEAR}}),zn=n(Nn.prototype,"stencilStoreOp",[In],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ne.STORE}}),Un=n(Nn.prototype,"sampleCount",[a,ue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Hn=n(Nn.prototype,"beginLayout",[Bn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return se.UNDEFINED}}),Gn=n(Nn.prototype,"endLayout",[Pn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return se.DEPTH_STENCIL_ATTACHMENT_OPTIMAL}}),Ln=Nn))||Ln);Vn=t("RenderPassDesc"),Wn=h([hr]),kn=h(ur),Vn((Xn=n((Qn=function(){s(this,"index",Xn,this),s(this,"colorAttachments",Yn,this),s(this,"depthStencilAttachment",jn,this)}).prototype,"index",[a,ue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Yn=n(Qn.prototype,"colorAttachments",[Wn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jn=n(Qn.prototype,"depthStencilAttachment",[kn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ur}}),Qn)),function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(sr||(sr={})),ee(sr);var cr,dr,lr,_r,fr,pr,gr,vr,mr,Er,wr,Sr=(Zn=t("RenderQueueDesc"),qn=h(sr),Kn=h([he]),Zn((er=n(($n=function(){s(this,"isTransparent",er,this),s(this,"sortMode",tr,this),s(this,"stages",ir,this)}).prototype,"isTransparent",[a,ue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),tr=n($n.prototype,"sortMode",[qn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return sr.FRONT_TO_BACK}}),ir=n($n.prototype,"stages",[Kn],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Jn=$n))||Jn),yr=new dt,Tr=function(){function e(e){this._pendingModels=[],this._instancedQueue=new ii,this._pipeline=void 0,this._pipeline=e}var t=e.prototype;return t.gatherShadowPasses=function(e,t){var i=this._pipeline.shadows;if(this._pendingModels.length=0,i.enabled&&i.type===et.Planar){this._pipeline.updateShadowUBO(e);var n=e.scene,r=e.frustum,s=0!=(e.visibility&ce.BitMask.DEFAULT);if(n.mainLight&&s){var a=this._pipeline.renderObjects,o=nt.get(i.instancingMaterial.passes[0]);this._instancedQueue.clear(),this._instancedQueue.queue.add(o);for(var h=0;h<a.length;h++){var u=a[h].model;if(u.enabled&&u.node&&u.castShadow&&(!u.worldBounds||(dt.transform(yr,u.worldBounds,i.matLight),_t.aabbFrustum(yr,r))))if(u.isInstancingEnabled)for(var c=0;c<u.subModels.length;c++)o.merge(u.subModels[c],u.instancedAttributes,0);else this._pendingModels.push(u)}this._instancedQueue.uploadBuffers(t)}}},t.recordCommandBuffer=function(e,t,i){var n=this._pipeline.shadows;if(n.enabled&&n.type===et.Planar&&this._pendingModels.length){this._instancedQueue.recordCommandBuffer(e,t,i);var r=n.material.passes[0],s=A.get(p.get(r.handle,g.DESCRIPTOR_SET));i.bindDescriptorSet(b.MATERIAL,s);for(var a=this._pendingModels.length,o=0;o<a;o++)for(var h=this._pendingModels[o],u=0;u<h.subModels.length;u++){var c=h.subModels[u],d=O.get(c.planarShaderHandel),l=c.inputAssembler,_=Kt.getOrCreatePipelineState(e,r,d,t,l);i.bindPipelineState(_),i.bindDescriptorSet(b.LOCAL,c.descriptorSet),i.bindInputAssembler(l),i.draw(l)}}},e}(),Or=function(){function e(){this._phaseID=G("default")}var t=e.prototype;return t.activate=function(e){this._pipeline=e},t.render=function(e,t){for(var i=this._pipeline,n=i.device,r=i.commandBuffers[0],s=e.scene.batches,a=0;a<s.length;a++){var o=s[a],h=!1;if(e.visibility&o.visFlags&&(h=!0),h)for(var u=o.handle,c=de.get(u,le.PASS_COUNT),d=0;d<c;d++){var l=o.passes[d];if(l.phase===this._phaseID){var _=de.get(u,le.SHADER_0+d),f=O.get(_),p=_e.get(o.hInputAssembler),g=A.get(o.hDescriptorSet),v=Kt.getOrCreatePipelineState(n,l,f,t,p);r.bindPipelineState(v),r.bindDescriptorSet(b.MATERIAL,l.descriptorSet),r.bindDescriptorSet(b.LOCAL,g),r.bindInputAssembler(p),r.draw(p)}}}},e}(),br=[new fe(0,0,0,1)],Ar=e("e",(cr=t("ForwardStage"),dr=h([Sr]),lr=o(),cr((vr=gr=function(e){function t(){var t;return t=e.call(this)||this,s(t,"renderQueues",pr,f(t)),t._renderQueues=[],t._renderArea=new ge,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=G("default"),t._clearFlag=4294967295,t._batchedQueue=new ti,t._instancedQueue=new ii,t._uiPhase=new Or,t}u(t,e);var i=t.prototype;return i.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},i.activate=function(t,i){e.prototype.activate.call(this,t,i);for(var n=0;n<this.renderQueues.length;n++){for(var r=0,s=0;s<this.renderQueues[n].stages.length;s++)r|=G(this.renderQueues[n].stages[s]);var a=Jt;switch(this.renderQueues[n].sortMode){case sr.BACK_TO_FRONT:a=$t;break;case sr.FRONT_TO_BACK:a=Jt}this._renderQueues[n]=new ei({isTransparent:this.renderQueues[n].isTransparent,phases:r,sortFunc:a})}this._additiveLightQueue=new rr(this._pipeline),this._planarQueue=new Tr(this._pipeline),this._uiPhase.activate(t)},i.destroy=function(){},i.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,i=t.device;this._renderQueues.forEach(this.renderQueueClearFunc);for(var n=t.renderObjects,r=0,s=0,a=0,o=0;o<n.length;++o){var h=n[o],u=h.model.subModels;for(r=0;r<u.length;++r){var c=u[r],d=c.passes;for(s=0;s<d.length;++s){var l=d[s];if(l.phase===this._phaseID){var _=l.batchingScheme;if(_===q.INSTANCING){var f=nt.get(l);f.merge(c,h.model.instancedAttributes,s),this._instancedQueue.queue.add(f)}else if(_===q.VB_MERGING){var p=ni.get(l);p.merge(c,s,h.model),this._batchedQueue.queue.add(p)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(h,r,s)}}}}this._renderQueues.forEach(this.renderQueueSortFunc);var g=t.commandBuffers[0];this._instancedQueue.uploadBuffers(g),this._batchedQueue.uploadBuffers(g),this._additiveLightQueue.gatherLightPasses(e,g),this._planarQueue.gatherShadowPasses(e,g);var v,m,E=e.viewport,w=e.window.hasOnScreenAttachments&&i.surfaceTransform%2?e.height:e.width,S=e.window.hasOnScreenAttachments&&i.surfaceTransform%2?e.width:e.height;if(this._renderArea.x=E.x*w,this._renderArea.y=E.y*S,this._renderArea.width=E.width*w*t.shadingScale,this._renderArea.height=E.height*S*t.shadingScale,e.clearFlag&pe.COLOR)if(t.isHDR){v=br[0],m=e.clearColor,v.x=m.x*m.x,v.y=m.y*m.y,v.z=m.z*m.z;var y=t.fpScale/e.exposure;br[0].x*=y,br[0].y*=y,br[0].z*=y}else br[0].x=e.clearColor.x,br[0].y=e.clearColor.y,br[0].z=e.clearColor.z;br[0].w=e.clearColor.w;var T=e.window.framebuffer,O=T.colorTextures[0]?T.renderPass:t.getRenderPass(e.clearFlag&this._clearFlag);g.beginRenderPass(O,T,this._renderArea,br,e.clearDepth,e.clearStencil),g.bindDescriptorSet(b.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(i,O,g),this._instancedQueue.recordCommandBuffer(i,O,g),this._batchedQueue.recordCommandBuffer(i,O,g),this._additiveLightQueue.recordCommandBuffer(i,O,g),this._planarQueue.recordCommandBuffer(i,O,g),this._renderQueues[1].recordCommandBuffer(i,O,g),this._uiPhase.render(e,O),g.endRenderPass()},i.renderQueueClearFunc=function(e){e.clear()},i.renderQueueSortFunc=function(e){e.sort()},t}(Mt),gr.initInfo={name:"ForwardStage",priority:jt.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:sr.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:sr.BACK_TO_FRONT,stages:["default","planarShadow"]}]},pr=n((fr=vr).prototype,"renderQueues",[dr,a,lr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_r=fr))||_r)),Rr=e("d",t("ForwardFlow")((wr=Er=function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new Ar;i.initialize(Ar.initInfo),this._stages.push(i)}return!0},i.activate=function(t){e.prototype.activate.call(this,t)},i.render=function(t){(function(e,t){var i=t.scene,n=i.mainLight,r=e.shadows,s=e.renderObjects;li.freeArray(s),s.length=0,r.enabled&&z.toArray(e.shadowUBO,r.shadowColor,M.SHADOW_COLOR_OFFSET),n&&r.type===et.Planar&&function(e,t){var i=e.shadows,n=t.direction,r=i.normal,s=i.distance+.001,a=1/C.dot(r,n),o=n.x*a,h=n.y*a,u=n.z*a,c=r.x,d=r.y,l=r.z,_=i.matLight;_.m00=1-c*o,_.m01=-c*h,_.m02=-c*u,_.m03=0,_.m04=-d*o,_.m05=1-d*h,_.m06=-d*u,_.m07=0,_.m08=-l*o,_.m09=-l*h,_.m10=1-l*u,_.m11=0,_.m12=o*s,_.m13=h*s,_.m14=u*s,_.m15=1,F.toArray(e.shadowUBO,i.matLight,M.MAT_LIGHT_PLANE_PROJ_OFFSET)}(e,n),e.skybox.enabled&&e.skybox.model&&t.clearFlag&tt&&s.push(fi(e.skybox.model,t));for(var a=i.models,o=0;o<a.length;o++){var h=a[o];if(h.enabled&&(h.node&&(t.visibility&h.node.layer)===h.node.layer||t.visibility&h.visFlags)){if(h.worldBounds&&!_t.aabbFrustum(h.worldBounds,t.frustum))continue;s.push(fi(h,t))}}})(this._pipeline,t),e.prototype.render.call(this,t)},i.destroy=function(){e.prototype.destroy.call(this)},t}(Yt),Er.initInfo={name:ve,priority:Zt.FORWARD,stages:[]},mr=wr))||mr),Fr=new F,Ir=new F,Br=new K,Pr=new C,Lr=new F,Nr=G("shadow-caster"),Dr=[];function Cr(e,t){t.length=0;for(var i=!1,n=0;n<e.length;n++){for(var r=e[n].passes,s=-1,a=0;a<r.length;a++)if(r[a].phase===Nr){s=a,i=!0;break}t.push(s)}return i}var xr,Mr,zr,Ur,Hr,Gr,Vr,Wr,kr,Qr,Xr,Yr,jr,Zr,qr,Kr,Jr=function(){function e(e){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._shadowMapBuffer=void 0,this._device=void 0,this._shadowInfo=void 0,this._descriptorSet=void 0,this._shadowObjects=void 0,this._shadowUBO=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=e,this._device=e.device,this._shadowInfo=e.shadows,this._descriptorSet=e.descriptorSet,this._shadowObjects=e.shadowObjects,this._shadowUBO=e.shadowUBO,this._shadowMapBuffer=e.descriptorSet.getBuffer(M.BINDING),this._instancedQueue=new ii,this._batchedQueue=new ti}var t=e.prototype;return t.gatherLightPasses=function(e,t){if(this.clear(),e&&this._shadowInfo.enabled&&this._shadowInfo.type===et.ShadowMap){this._updateUBOs(e);for(var i=0;i<this._shadowObjects.length;i++){var n=this._shadowObjects[i].model;if(Cr(n.subModels,Dr))switch(e.type){case it.DIRECTIONAL:this.add(n,t,Dr);break;case it.SPOT:if(n.worldBounds&&(!_t.aabbWithAABB(n.worldBounds,e.aabb)||!_t.aabbFrustum(n.worldBounds,e.frustum)))continue;this.add(n,t,Dr)}}}},t.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()},t.add=function(e,t,i){for(var n=e.subModels,r=0;r<n.length;r++){var s=n[r],a=i[r],o=s.passes[a],h=o.batchingScheme;if(s.descriptorSet.bindBuffer(M.BINDING,this._shadowMapBuffer),s.descriptorSet.update(),h===q.INSTANCING){var u=nt.get(o);u.merge(s,e.instancedAttributes,a),this._instancedQueue.queue.add(u)}else if(o.batchingScheme===q.VB_MERGING){var c=ni.get(o);c.merge(s,a,e),this._batchedQueue.queue.add(c)}else{var d=O.get(y.get(s.handle,T.SHADER_0+a));this._subModelsArray.push(s),this._shaderArray.push(d),this._passArray.push(o)}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)},t.recordCommandBuffer=function(e,t,i){this._instancedQueue.recordCommandBuffer(e,t,i),this._batchedQueue.recordCommandBuffer(e,t,i);for(var n=0;n<this._subModelsArray.length;++n){var r=this._subModelsArray[n],s=this._shaderArray[n],a=this._passArray[n],o=r.inputAssembler,h=Kt.getOrCreatePipelineState(e,a,s,t,o),u=a.descriptorSet;i.bindPipelineState(h),i.bindDescriptorSet(b.MATERIAL,u),i.bindDescriptorSet(b.LOCAL,r.descriptorSet),i.bindInputAssembler(o),i.draw(o)}},t._updateUBOs=function(e){var t=0,i=0,n=0;switch(e.type){case it.DIRECTIONAL:if(e.update(),this._shadowInfo.autoAdapt){var r=e.node;r&&(Lr=gi(this._pipeline,r.getWorldRotation(),e.direction,Pr));var s=this._shadowInfo.sphere.radius;t=s*this._shadowInfo.aspect,i=s;var a=C.distance(this._shadowInfo.sphere.center,Pr);n=Math.min(a*$e.COEFFICIENT_OF_EXPANSION,$e.MAX_FAR)}else Lr=e.node.getWorldMatrix(),t=this._shadowInfo.orthoSize*this._shadowInfo.aspect,i=this._shadowInfo.orthoSize,n=this._shadowInfo.far;F.invert(Fr,Lr),F.ortho(Ir,-t,t,-i,i,this._shadowInfo.near,n,this._device.clipSpaceMinZ,this._device.screenSpaceSignY*this._device.UVSpaceSignY);break;case it.SPOT:F.invert(Fr,e.node.getWorldMatrix()),F.perspective(Ir,e.spotAngle,e.aspect,.001,e.range)}F.multiply(Ir,Ir,Fr),F.toArray(this._shadowUBO,Ir,M.MAT_LIGHT_VIEW_PROJ_OFFSET),z.toArray(this._shadowUBO,this._shadowInfo.shadowColor,M.SHADOW_COLOR_OFFSET),Br.set(this._shadowInfo.size.x,this._shadowInfo.size.y,this._shadowInfo.pcf,this._shadowInfo.bias),K.toArray(this._shadowUBO,Br,M.SHADOW_INFO_OFFSET),this._descriptorSet.getBuffer(M.BINDING).update(this._shadowUBO)},e}(),$r=[new fe(1,1,1,1)],es=e("f",t("ShadowStage")((zr=Mr=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this)._shadowFrameBuffer=null,t._renderArea=new ge,t._light=null,t}u(t,e);var i=t.prototype;return i.setUsage=function(e,t){this._light=e,this._shadowFrameBuffer=t},i.destroy=function(){this._additiveShadowQueue.clear()},i.clearFramebuffer=function(e){if(this._light&&this._shadowFrameBuffer){$r[0].w=e.clearColor.w;var t=this._pipeline.commandBuffers[0],i=this._shadowFrameBuffer.renderPass;t.beginRenderPass(i,this._shadowFrameBuffer,this._renderArea,$r,e.clearDepth,e.clearStencil),t.endRenderPass()}},i.render=function(e){var t=this._pipeline,i=t.shadows,n=t.commandBuffers[0];if(this._light&&this._shadowFrameBuffer){this._additiveShadowQueue.gatherLightPasses(this._light,n);var r=e.viewport,s=i.size;this._renderArea.x=r.x*s.x,this._renderArea.y=r.y*s.y,this._renderArea.width=r.width*s.x*t.shadingScale,this._renderArea.height=r.height*s.y*t.shadingScale;var a=t.device,o=this._shadowFrameBuffer.renderPass;n.beginRenderPass(o,this._shadowFrameBuffer,this._renderArea,$r,e.clearDepth,e.clearStencil),n.bindDescriptorSet(b.GLOBAL,t.descriptorSet),this._additiveShadowQueue.recordCommandBuffer(a,o,n),n.endRenderPass()}},i.activate=function(t,i){e.prototype.activate.call(this,t,i),this._additiveShadowQueue=new Jr(t)},t}(Mt),Mr.initInfo={name:"ShadowStage",priority:jt.FORWARD,tag:0},xr=zr))||xr),ts=e("S",t("ShadowFlow")((Gr=Hr=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this)._shadowRenderPass=null,t}u(t,e);var i=t.prototype;return i.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var i=new es;i.initialize(es.initInfo),this._stages.push(i)}return!0},i.render=function(e){var t=this._pipeline,i=t.shadows;if(i.enabled&&i.type===et.ShadowMap){var n=function(e,t){ci.length=0;var i=e.scene;ci.push(i.mainLight);for(var n=i.spotLights,r=0;r<n.length;r++){var s=n[r];lt.set(di,s.position.x,s.position.y,s.position.z,s.range),_t.sphereFrustum(di,e.frustum)&&t>ci.length&&ci.push(s)}return ci}(e,i.maxReceived);if(function(e,t){var i=t.scene,n=e.shadows,r=e.shadowObjects;_i.freeArray(r),r.length=0,ui=!1;for(var s=i.models,a=0;a<s.length;a++){var o=s[a];(o.node&&(t.visibility&o.node.layer)===o.node.layer||t.visibility&o.visFlags)&&o.castShadow&&o.worldBounds&&(ui||(hi.copy(o.worldBounds),ui=!0),dt.merge(hi,hi,o.worldBounds),r.push(pi(o,t)))}hi&&dt.toBoundingSphere(n.sphere,hi)}(t,e),0!==t.shadowObjects.length){for(var r=0;r<n.length;r++){var s=n[r];t.shadowFrameBufferMap.has(s)||this._initShadowFrameBuffer(t,s);var a=t.shadowFrameBufferMap.get(s);i.shadowMapDirty&&this.resizeShadowMap(s,i.size);for(var o=0;o<this._stages.length;o++){var h=this._stages[o];h.setUsage(s,a),h.render(e)}}t.updateShadowUBO(e)}else this.clearShadowMap(n,e)}},i.destroy=function(){e.prototype.destroy.call(this);for(var t=Array.from(this._pipeline.shadowFrameBufferMap.values()),i=0;i<t.length;i++){var n=t[i];if(n){for(var r=n.colorTextures,s=0;s<r.length;s++){var a=r[i];a&&a.destroy()}r.length=0;var o=n.depthStencilTexture;o&&o.destroy(),n.destroy()}}this._pipeline.shadowFrameBufferMap.clear(),this._shadowRenderPass&&this._shadowRenderPass.destroy()},i._initShadowFrameBuffer=function(e,t){var i=e.device,n=e.shadows.size;if(!this._shadowRenderPass){var r=new me;r.format=N.RGBA8,r.loadOp=re.CLEAR,r.storeOp=ne.STORE,r.sampleCount=1,r.beginLayout=se.UNDEFINED,r.endLayout=se.PRESENT_SRC;var s=new Ee;s.format=i.depthStencilFormat,s.depthLoadOp=re.CLEAR,s.depthStoreOp=ne.DISCARD,s.stencilLoadOp=re.CLEAR,s.stencilStoreOp=ne.DISCARD,s.sampleCount=1,s.beginLayout=se.UNDEFINED,s.endLayout=se.DEPTH_STENCIL_ATTACHMENT_OPTIMAL;var a=new we([r],s);this._shadowRenderPass=i.createRenderPass(a)}var o=[];o.push(i.createTexture(new Se(te.TEX2D,ie.COLOR_ATTACHMENT|ie.SAMPLED,N.RGBA8,n.x,n.y)));var h=i.createTexture(new Se(te.TEX2D,ie.DEPTH_STENCIL_ATTACHMENT,i.depthStencilFormat,n.x,n.y)),u=i.createFramebuffer(new ye(this._shadowRenderPass,o,h));e.shadowFrameBufferMap.set(t,u)},i.clearShadowMap=function(e,t){for(var i=this._pipeline,n=0;n<e.length;n++){var r=e[n],s=i.shadowFrameBufferMap.get(r);if(i.shadowFrameBufferMap.has(r))for(var a=0;a<this._stages.length;a++){var o=this._stages[a];o.setUsage(r,s),o.clearFramebuffer(t)}}},i.resizeShadowMap=function(e,t){var i=t.x,n=t.y,r=this._pipeline;if(r.shadowFrameBufferMap.has(e)){var s=r.shadowFrameBufferMap.get(e);if(!s)return;var a=s.colorTextures;if(a&&a.length>0)for(var o=0;o<a.length;o++){var h=a[o];h&&h.resize(i,n)}var u=s.depthStencilTexture;u&&u.resize(i,n);var c=s.renderPass;s.destroy(),s.initialize(new ye(c,a,u))}},t}(Yt),Hr.initInfo={name:Te,priority:Zt.SHADOW,tag:nr.SCENE,stages:[]},Ur=Gr))||Ur),is=e("h",Oe({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3})).LAYERED+1,ns=function(){function e(){this._fogColor=new z("#C8C8C8"),this._colorArray=new Float32Array([.2,.2,.2,1]),this._handle=be,this._handle=Ae.alloc()}i(e,[{key:"enabled",set:function(e){Ae.set(this._handle,Re.ENABLE,e?1:0),e||Ae.set(this._handle,Re.TYPE,is),e?this.activate():this._updatePipeline()},get:function(){return Ae.get(this._handle,Re.ENABLE)}},{key:"fogColor",set:function(e){this._fogColor.set(e),z.toArray(this._colorArray,this._fogColor),Ae.setVec4(this._handle,Re.COLOR,this._fogColor)},get:function(){return this._fogColor}},{key:"type",get:function(){return Ae.get(this._handle,Re.TYPE)},set:function(e){Ae.set(this._handle,Re.TYPE,this.enabled?e:is),this.enabled&&this._updatePipeline()}},{key:"fogDensity",get:function(){return Ae.get(this._handle,Re.DENSITY)},set:function(e){Ae.set(this._handle,Re.DENSITY,e)}},{key:"fogStart",get:function(){return Ae.get(this._handle,Re.START)},set:function(e){Ae.set(this._handle,Re.START,e)}},{key:"fogEnd",get:function(){return Ae.get(this._handle,Re.END)},set:function(e){Ae.set(this._handle,Re.END,e)}},{key:"fogAtten",get:function(){return Ae.get(this._handle,Re.ATTEN)},set:function(e){Ae.set(this._handle,Re.ATTEN,e)}},{key:"fogTop",get:function(){return Ae.get(this._handle,Re.TOP)},set:function(e){Ae.set(this._handle,Re.TOP,e)}},{key:"fogRange",get:function(){return Ae.get(this._handle,Re.RANGE)},set:function(e){Ae.set(this._handle,Re.RANGE,e)}},{key:"colorArray",get:function(){return this._colorArray}},{key:"handle",get:function(){return this._handle}}]);var t=e.prototype;return t.initialize=function(e){Ae.set(this._handle,Re.ENABLE,e.enabled?1:0),Ae.set(this._handle,Re.TYPE,e.enabled?e.type:is),this._fogColor.set(e.fogColor),z.toArray(this._colorArray,this._fogColor),Ae.setVec4(this._handle,Re.COLOR,this._fogColor),Ae.set(this._handle,Re.DENSITY,e.fogDensity),Ae.set(this._handle,Re.START,e.fogStart),Ae.set(this._handle,Re.END,e.fogEnd),Ae.set(this._handle,Re.ATTEN,e.fogAtten),Ae.set(this._handle,Re.TOP,e.fogTop),Ae.set(this._handle,Re.RANGE,e.fogRange)},t.activate=function(){this._updatePipeline()},t._updatePipeline=function(){var e=r.director.root,t=this.enabled?this.type:is,i=e.pipeline;i.macros.CC_USE_FOG!==t&&(i.macros.CC_USE_FOG=t,e.onGlobalPipelineStateChanged())},t.destroy=function(){this._handle&&(Ae.free(this._handle),this._handle=be)},e}();r.Fog=ns;var rs=new F,ss=new F,as=new C,os=[U.LINEAR,U.LINEAR,U.NONE,H.CLAMP,H.CLAMP,H.CLAMP],hs=(e("F",(Vr=t("ForwardPipeline"),Wr=h([ar]),kr=o(),Qr=h([or]),Xr=o(),Vr((Kr=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return t=e.call.apply(e,[this].concat(n))||this,s(t,"renderTextures",Zr,f(t)),s(t,"materials",qr,f(t)),t.fog=new ns,t.ambient=new rt,t.skybox=new st,t.shadows=new $e,t.renderObjects=[],t.shadowObjects=[],t.shadowFrameBufferMap=new Map,t._isHDR=!1,t._shadingScale=1,t._fpScale=1/1024,t._renderPasses=new Map,t._globalUBO=new Float32Array(V.COUNT),t._cameraUBO=new Float32Array(W.COUNT),t._shadowUBO=new Float32Array(M.COUNT),t}u(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var i=new ts;i.initialize(ts.initInfo),this._flows.push(i);var n=new Rr;n.initialize(Rr.initInfo),this._flows.push(n)}return!0},n.activate=function(){return this._macros={},!(!e.prototype.activate.call(this)||!this._activeRenderer()&&(Fe(2402),1))},n.render=function(e){this._commandBuffers[0].begin(),this.updateGlobalUBO();for(var t=0;t<e.length;t++){var i=e[t];if(i.scene){this.updateCameraUBO(i);for(var n=0;n<this._flows.length;n++)this._flows[n].render(i)}}this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)},n.getRenderPass=function(e){var t=this._renderPasses.get(e);if(t)return t;var i=this.device,n=new me,r=new Ee;n.format=i.colorFormat,r.format=i.depthStencilFormat,r.stencilStoreOp=ne.DISCARD,r.depthStoreOp=ne.DISCARD,e&pe.COLOR||(e&tt?n.loadOp=re.DISCARD:(n.loadOp=re.LOAD,n.beginLayout=se.PRESENT_SRC)),(e&pe.DEPTH_STENCIL)!==pe.DEPTH_STENCIL&&(e&pe.DEPTH||(r.depthLoadOp=re.LOAD),e&pe.STENCIL||(r.stencilLoadOp=re.LOAD),r.beginLayout=se.DEPTH_STENCIL_ATTACHMENT_OPTIMAL);var s=new we([n],r);return t=i.createRenderPass(s),this._renderPasses.set(e,t),t},n.updateGlobalUBO=function(){this._descriptorSet.update();var e=r.director.root,t=this._globalUBO,i=this.device,n=Math.floor(i.width),s=Math.floor(i.height);t[V.TIME_OFFSET]=e.cumulativeTime,t[V.TIME_OFFSET+1]=e.frameTime,t[V.TIME_OFFSET+2]=r.director.getTotalFrames(),t[V.SCREEN_SIZE_OFFSET]=i.width,t[V.SCREEN_SIZE_OFFSET+1]=i.height,t[V.SCREEN_SIZE_OFFSET+2]=1/i.width,t[V.SCREEN_SIZE_OFFSET+3]=1/i.height,t[V.NATIVE_SIZE_OFFSET]=n,t[V.NATIVE_SIZE_OFFSET+1]=s,t[V.NATIVE_SIZE_OFFSET+2]=1/t[V.NATIVE_SIZE_OFFSET],t[V.NATIVE_SIZE_OFFSET+3]=1/t[V.NATIVE_SIZE_OFFSET+1],this._commandBuffers[0].updateBuffer(this._descriptorSet.getBuffer(V.BINDING),this._globalUBO)},n._activeRenderer=function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=e.createBuffer(new I(B.UNIFORM|B.TRANSFER_DST,P.HOST|P.DEVICE,V.SIZE,V.SIZE));this._descriptorSet.bindBuffer(V.BINDING,t);var i=e.createBuffer(new I(B.UNIFORM|B.TRANSFER_DST,P.HOST|P.DEVICE,W.SIZE,W.SIZE));this._descriptorSet.bindBuffer(W.BINDING,i);var n=e.createBuffer(new I(B.UNIFORM|B.TRANSFER_DST,P.HOST|P.DEVICE,M.SIZE,M.SIZE));this._descriptorSet.bindBuffer(M.BINDING,n);var r=X(os),s=Y.getSampler(e,r);return this._descriptorSet.bindSampler(j,s),this._descriptorSet.bindTexture(j,$.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(Z,s),this._descriptorSet.bindTexture(Z,$.get("default-texture").getGFXTexture()),this._descriptorSet.update(),this.macros.CC_USE_HDR=this._isHDR,this.macros.CC_SUPPORT_FLOAT_TEXTURE=this.device.hasFeature(Ie.TEXTURE_FLOAT),!0},n.updateShadowUBO=function(e){this._descriptorSet.update();var t=e.scene.mainLight,i=this.device,n=this.shadows;if(n.enabled){if(t&&n.type===et.ShadowMap){var r;this.shadowFrameBufferMap.has(t)&&this._descriptorSet.bindTexture(j,this.shadowFrameBufferMap.get(t).colorTextures[0]);var s=0,a=0,o=0;if(n.autoAdapt){r=gi(this,t.node.getWorldRotation(),t.direction,as);var h=n.sphere.radius;s=h*n.aspect,a=h;var u=C.distance(n.sphere.center,as);o=Math.min(u*$e.COEFFICIENT_OF_EXPANSION,$e.MAX_FAR)}else r=t.node.getWorldMatrix(),s=n.orthoSize*n.aspect,a=n.orthoSize,o=n.far;F.invert(rs,r);var c=i.screenSpaceSignY*i.UVSpaceSignY;F.ortho(ss,-s,s,-a,a,n.near,o,i.clipSpaceMinZ,c),F.multiply(ss,ss,rs),F.toArray(this._shadowUBO,ss,M.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[M.SHADOW_INFO_OFFSET]=n.size.x,this._shadowUBO[M.SHADOW_INFO_OFFSET+1]=n.size.y,this._shadowUBO[M.SHADOW_INFO_OFFSET+2]=n.pcf,this._shadowUBO[M.SHADOW_INFO_OFFSET+3]=n.bias}else t&&n.type===et.Planar&&vi(n,t,this._shadowUBO);z.toArray(this._shadowUBO,n.shadowColor,M.SHADOW_COLOR_OFFSET),this._commandBuffers[0].updateBuffer(this._descriptorSet.getBuffer(M.BINDING),this._shadowUBO)}},n.updateCameraUBO=function(e){var t=this.device,i=(e.scene?e.scene:r.director.getScene().renderScene).mainLight,n=this.ambient,s=this.fog,a=Math.floor(t.width),o=Math.floor(t.height),h=this._cameraUBO,u=e.exposure;if(h[W.SCREEN_SCALE_OFFSET]=e.width/a*this.shadingScale,h[W.SCREEN_SCALE_OFFSET+1]=e.height/o*this.shadingScale,h[W.SCREEN_SCALE_OFFSET+2]=1/h[W.SCREEN_SCALE_OFFSET],h[W.SCREEN_SCALE_OFFSET+3]=1/h[W.SCREEN_SCALE_OFFSET+1],h[W.EXPOSURE_OFFSET]=u,h[W.EXPOSURE_OFFSET+1]=1/u,h[W.EXPOSURE_OFFSET+2]=this._isHDR?1:0,h[W.EXPOSURE_OFFSET+3]=this._fpScale/u,i){if(C.toArray(h,i.direction,W.MAIN_LIT_DIR_OFFSET),C.toArray(h,i.color,W.MAIN_LIT_COLOR_OFFSET),i.useColorTemperature){var c=i.colorTemperatureRGB;h[W.MAIN_LIT_COLOR_OFFSET]*=c.x,h[W.MAIN_LIT_COLOR_OFFSET+1]*=c.y,h[W.MAIN_LIT_COLOR_OFFSET+2]*=c.z}this._isHDR?h[W.MAIN_LIT_COLOR_OFFSET+3]=i.illuminance*this._fpScale:h[W.MAIN_LIT_COLOR_OFFSET+3]=i.illuminance*u}else C.toArray(h,C.UNIT_Z,W.MAIN_LIT_DIR_OFFSET),K.toArray(h,K.ZERO,W.MAIN_LIT_COLOR_OFFSET);var d=n.colorArray;this._isHDR?d[3]=n.skyIllum*this._fpScale:d[3]=n.skyIllum*u,h.set(d,W.AMBIENT_SKY_OFFSET),h.set(n.albedoArray,W.AMBIENT_GROUND_OFFSET),F.toArray(h,e.matView,W.MAT_VIEW_OFFSET),F.toArray(h,e.node.worldMatrix,W.MAT_VIEW_INV_OFFSET),F.toArray(h,e.matProj,W.MAT_PROJ_OFFSET),F.toArray(h,e.matProjInv,W.MAT_PROJ_INV_OFFSET),F.toArray(h,e.matViewProj,W.MAT_VIEW_PROJ_OFFSET),F.toArray(h,e.matViewProjInv,W.MAT_VIEW_PROJ_INV_OFFSET),C.toArray(h,e.position,W.CAMERA_POS_OFFSET);var l=t.screenSpaceSignY;e.window.hasOffScreenAttachments&&(l*=t.UVSpaceSignY),h[W.CAMERA_POS_OFFSET+3]=l,s.enabled&&(h.set(s.colorArray,W.GLOBAL_FOG_COLOR_OFFSET),h[W.GLOBAL_FOG_BASE_OFFSET]=s.fogStart,h[W.GLOBAL_FOG_BASE_OFFSET+1]=s.fogEnd,h[W.GLOBAL_FOG_BASE_OFFSET+2]=s.fogDensity,h[W.GLOBAL_FOG_ADD_OFFSET]=s.fogTop,h[W.GLOBAL_FOG_ADD_OFFSET+1]=s.fogRange,h[W.GLOBAL_FOG_ADD_OFFSET+2]=s.fogAtten),this._commandBuffers[0].updateBuffer(this._descriptorSet.getBuffer(W.BINDING),this._cameraUBO)},n.destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer(V.BINDING).destroy(),this._descriptorSet.getBuffer(M.BINDING).destroy(),this._descriptorSet.getBuffer(W.BINDING).destroy(),this._descriptorSet.getSampler(j).destroy(),this._descriptorSet.getSampler(Z).destroy(),this._descriptorSet.getTexture(j).destroy(),this._descriptorSet.getTexture(Z).destroy())},n.destroy=function(){this.destroyUBOs();for(var t=this._renderPasses.values(),i=t.next();!i.done;)i.value.destroy(),i=t.next();return this._commandBuffers.length=0,this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),e.prototype.destroy.call(this)},i(t,[{key:"isHDR",get:function(){return this._isHDR},set:function(e){this._isHDR!==e&&(this._isHDR=e,this._cameraUBO[W.EXPOSURE_OFFSET+2]=this._isHDR?1:0)}},{key:"shadingScale",get:function(){return this._shadingScale}},{key:"fpScale",get:function(){return this._fpScale}},{key:"shadowUBO",get:function(){return this._shadowUBO}}]),t}(qt),Zr=n((jr=Kr).prototype,"renderTextures",[Wr,a,kr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),qr=n(jr.prototype,"materials",[Qr,a,Xr],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Yr=jr))||Yr)),new Be),us=e("T",function(){function e(e,t,i){void 0===i&&(i=0),this._point=new Be,this._prevPoint=new Be,this._lastModified=0,this._id=0,this._startPoint=new Be,this._startPointCaptured=!1,this.setTouchInfo(i,e,t)}i(e,[{key:"lastModified",get:function(){return this._lastModified}}]);var t=e.prototype;return t.getLocation=function(e){return e||(e=new Be),e.set(this._point.x,this._point.y),e},t.getLocationX=function(){return this._point.x},t.getLocationY=function(){return this._point.y},t.getUILocation=function(e){return e||(e=new Be),e.set(this._point.x,this._point.y),r.view._convertPointWithScale(e),e},t.getUILocationX=function(){var e=r.view.getViewportRect();return(this._point.x-e.x)/r.view.getScaleX()},t.getUILocationY=function(){var e=r.view.getViewportRect();return(this._point.y-e.y)/r.view.getScaleY()},t.getPreviousLocation=function(e){return e||(e=new Be),e.set(this._prevPoint.x,this._prevPoint.y),e},t.getUIPreviousLocation=function(e){return e||(e=new Be),e.set(this._prevPoint.x,this._prevPoint.y),r.view._convertPointWithScale(e),e},t.getStartLocation=function(e){return e||(e=new Be),e.set(this._startPoint.x,this._startPoint.y),e},t.getUIStartLocation=function(e){return e||(e=new Be),e.set(this._startPoint.x,this._startPoint.y),r.view._convertPointWithScale(e),e},t.getDelta=function(e){return e||(e=new Be),e.set(this._point),e.subtract(this._prevPoint),e},t.getUIDelta=function(e){return e||(e=new Be),hs.set(this._point),hs.subtract(this._prevPoint),e.set(r.view.getScaleX(),r.view.getScaleY()),Be.divide(e,hs,e),e},t.getLocationInView=function(e){return e||(e=new Be),e.set(this._point.x,r.view._designResolutionSize.height-this._point.y),e},t.getPreviousLocationInView=function(e){return e||(e=new Be),e.set(this._prevPoint.x,r.view._designResolutionSize.height-this._prevPoint.y),e},t.getStartLocationInView=function(e){return e||(e=new Be),e.set(this._startPoint.x,r.view._designResolutionSize.height-this._startPoint.y),e},t.getID=function(){return this._id},t.setTouchInfo=function(e,t,i){void 0===e&&(e=0),this._prevPoint=this._point,this._point=new Be(t||0,i||0),this._id=e,this._startPointCaptured||(this._startPoint=new Be(this._point),this._startPointCaptured=!0)},t.setPoint=function(e,t){"object"==typeof e?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0),this._lastModified=r.director.getCurrentTime()},t.setPrevPoint=function(e,t){this._prevPoint="object"==typeof e?new Be(e.x,e.y):new Be(e||0,t||0),this._lastModified=r.director.getCurrentTime()},e}());r.Touch=us;var cs,ds=Le.TOUCH_TIMEOUT,ls=new Be,_s=new Be,fs=e("A",(function(e,t,i,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===i&&(i=0),void 0===n&&(n=0),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=e,this.y=t,this.z=i,this.timestamp=n}));r.internal.Acceleration=fs;var ps=function(){function e(){this._mousePressed=!1,this._isRegisterEvent=!1,this._preTouchPoint=new Be,this._prevMousePoint=new Be,this._preTouchPool=[],this._preTouchPoolPointer=0,this._touches=[],this._touchesIntegerDict={},this._indexBitsUsed=0,this._maxTouches=8,this._accelEnabled=!1,this._accelInterval=.2,this._accelMinus=1,this._accelCurTime=0,this._acceleration=null,this._accelDeviceEvent=null,this._glView=null,this._pointLocked=!1}var t=e.prototype;return t.handleTouchesBegin=function(e){for(var t=[],i=this._touchesIntegerDict,n=0;n<e.length;++n){var r=e[n],s=r.getID();if(null!==s&&void 0===i[s]){var a=this._getUnUsedIndex();if(-1===a){Pe(2300,a);continue}r.getLocation(ls);var o=new us(ls.x,ls.y,s);this._touches[a]=o,r.getPreviousLocation(ls),o.setPrevPoint(ls),i[s]=a,t.push(o)}}if(t.length>0){var h=new at(t,!1,at.BEGAN,Le.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);ot.dispatchEvent(h)}},t.handleTouchesMove=function(e){for(var t=[],i=this._touches,n=0;n<e.length;++n){var r=e[n],s=r.getID();if(null!==s){var a=this._touchesIntegerDict[s];void 0!==a&&i[a]&&(r.getLocation(ls),i[a].setPoint(ls),r.getPreviousLocation(ls),i[a].setPrevPoint(ls),t.push(i[a]))}}if(t.length>0){var o=new at(t,!1,at.MOVED,Le.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);ot.dispatchEvent(o)}},t.handleTouchesEnd=function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(t.length>0){var i=new at(t,!1,at.ENDED,Le.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);ot.dispatchEvent(i)}this._preTouchPool.length=0},t.handleTouchesCancel=function(e){var t=this.getSetOfTouchesEndOrCancel(e);if(t.length>0){var i=new at(t,!1,at.CANCELLED,Le.ENABLE_MULTI_TOUCH?this._getUsefulTouches():t);ot.dispatchEvent(i)}this._preTouchPool.length=0},t.getSetOfTouchesEndOrCancel=function(e){for(var t=[],i=this._touches,n=this._touchesIntegerDict,r=0;r<e.length;++r){var s=e[r],a=s.getID();if(null!==a){var o=n[a];void 0!==o&&i[o]&&(s.getLocation(ls),i[o].setPoint(ls),s.getPreviousLocation(ls),i[o].setPrevPoint(ls),t.push(i[o]),this._removeUsedIndexBit(o),delete n[a])}}return t},t.getHTMLElementPosition=function(e){var t=document.documentElement,i=Ne.os===Ne.OS_IOS&&Ne.isBrowser?window.screenLeft:window.pageXOffset;i-=t.clientLeft;var n=Ne.os===Ne.OS_IOS&&Ne.isBrowser?window.screenTop:window.pageYOffset;if(n-=t.clientTop,e.getBoundingClientRect){var r=e.getBoundingClientRect();return{left:r.left+i,top:r.top+n,width:r.width,height:r.height}}return e instanceof HTMLCanvasElement?{left:i,top:n,width:e.width,height:e.height}:{left:i,top:n,width:parseInt(e.style.width||"0",void 0),height:parseInt(e.style.height||"0",void 0)}},t.getPreTouch=function(e){for(var t=null,i=this._preTouchPool,n=e.getID(),r=i.length-1;r>=0;r--)if(i[r].getID()===n){t=i[r];break}return t||(t=e),t},t.setPreTouch=function(e){for(var t=!1,i=this._preTouchPool,n=e.getID(),r=i.length-1;r>=0;r--)if(i[r].getID()===n){i[r]=e,t=!0;break}t||(i.length<=50?i.push(e):(i[this._preTouchPoolPointer]=e,this._preTouchPoolPointer=(this._preTouchPoolPointer+1)%50))},t.getTouchByXY=function(e,t,i,n){var r=this._preTouchPoint,s=this._glView.convertToLocationInView(t,i,n);this._pointLocked&&(s.x=r.x+e.movementX,s.y=r.y-e.movementY);var a=new us(s.x,s.y,0);return a.setPrevPoint(r.x,r.y),r.x=s.x,r.y=s.y,a},t.getMouseEvent=function(e,t,i){var n=this._prevMousePoint,r=new ht(i,!1,n);return n.x=e.x,n.y=e.y,this._glView._convertMouseToLocation(n,t),r.setLocation(n.x,n.y),r},t.getPointByEvent=function(e,t){return null!=e.pageX?{x:e.pageX,y:e.pageY}:(t.left-=document.body.scrollLeft,t.top-=document.body.scrollTop,{x:e.clientX,y:e.clientY})},t.getTouchesByEvent=function(e,t){for(var i=[],n=this._glView,r=this._preTouchPoint,s=e.changedTouches.length,a=0;a<s;a++){var o=e.changedTouches[a];if(o){var h;h=Ne.BROWSER_TYPE_FIREFOX===Ne.browserType?n.convertToLocationInView(o.pageX,o.pageY,t,ls):n.convertToLocationInView(o.clientX,o.clientY,t,ls);var u=void 0;if(null!=o.identifier?(u=new us(h.x,h.y,o.identifier),this.getPreTouch(u).getLocation(_s),u.setPrevPoint(_s.x,_s.y),this.setPreTouch(u)):(u=new us(h.x,h.y)).setPrevPoint(r.x,r.y),r.x=h.x,r.y=h.y,i.push(u),!Le.ENABLE_MULTI_TOUCH)break}}return i},t.registerSystemEvent=function(e){if(!this._isRegisterEvent&&e){this._glView=r.view;var t=Ne.isMobile,i=Ne.capabilities.mouse,n=Ne.capabilities.touches;i&&this._registerMouseEvents(e,t),window.navigator.msPointerEnabled&&this._registerMousePointerEvents(e),n&&this._registerTouchEvents(e),this._registerKeyboardEvent(),this._isRegisterEvent=!0}},t.setAccelerometerEnabled=function(e){if(this._accelEnabled!==e){this._accelEnabled=e;var t=r.director.getScheduler();t.enableForTarget(this),this._accelEnabled?(this._registerAccelerometerEvent(),this._accelCurTime=0,t.scheduleUpdate(this)):(this._unregisterAccelerometerEvent(),this._accelCurTime=0,t.unscheduleUpdate(this))}},t.didAccelerate=function(e){if(this._accelEnabled){var t=this._acceleration,i=0,n=0,s=0;if(this._accelDeviceEvent===window.DeviceMotionEvent){var a=e.accelerationIncludingGravity;a&&(i=this._accelMinus*(a.x||0)*.1,n=this._accelMinus*(a.y||0)*.1,s=.1*(a.z||0))}else{var o=e;i=(o.gamma||0)/90*.981,n=-(o.beta||0)/90*.981,s=(o.alpha||0)/90*.981}if(r.view._isRotated){var h=i;i=-n,n=h}t.x=i,t.y=n,t.z=s,t.timestamp=e.timeStamp||Date.now();var u=t.x;90===window.orientation?(t.x=-t.y,t.y=u):-90===window.orientation?(t.x=t.y,t.y=-u):180===window.orientation&&(t.x=-t.x,t.y=-t.y),r.sys.os===r.sys.OS_ANDROID&&r.sys.browserType!==r.sys.BROWSER_TYPE_MOBILE_QQ&&(t.x=-t.x,t.y=-t.y)}},t.update=function(e){this._accelCurTime>this._accelInterval&&(this._accelCurTime-=this._accelInterval,ot.dispatchEvent(new ut(this._acceleration))),this._accelCurTime+=e},t.setAccelerometerInterval=function(e){this._accelInterval!==e&&(this._accelInterval=e)},t._getUnUsedIndex=function(){for(var e=this._indexBitsUsed,t=r.director.getCurrentTime(),i=0;i<this._maxTouches;i++){if(!(1&e))return this._indexBitsUsed|=1<<i,i;var n=this._touches[i];if(t-n.lastModified>ds){this._removeUsedIndexBit(i);var s=n.getID();return null!==s&&delete this._touchesIntegerDict[s],i}e>>=1}return-1},t._removeUsedIndexBit=function(e){if(!(e<0||e>=this._maxTouches)){var t=1<<e;t=~t,this._indexBitsUsed&=t}},t._registerMouseEvents=function(e,t){this._registerPointerLockEvent(),t||this._registerWindowMouseEvents(e),this._registerElementMouseEvents(e,t)},t._registerPointerLockEvent=function(){var e=this,t=function(){var t=r.game.canvas;document.pointerLockElement===t||document.mozPointerLockElement===t?e._pointLocked=!0:e._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",t,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",t,!1)},t._registerWindowMouseEvents=function(e){var t=this;window.addEventListener("mousedown",(function(){t._mousePressed=!0}),!1),window.addEventListener("mouseup",(function(i){if(t._mousePressed){t._mousePressed=!1;var n=t.getHTMLElementPosition(e),r=t.getPointByEvent(i,n);if(!De(n.left,n.top,n.width,n.height).contains(new Be(r.x,r.y))){t.handleTouchesEnd([t.getTouchByXY(i,r.x,r.y,n)]);var s=t.getMouseEvent(r,n,ht.UP);s.setButton(i.button),ot.dispatchEvent(s)}}}),!1)},t._registerElementMouseEvents=function(e,t){var i=this,n=function(t,n,r){e.addEventListener(t,(function(t){var s=i.getHTMLElementPosition(e),a=i.getPointByEvent(t,s),o=i.getMouseEvent(a,s,n);o.setButton(t.button),r(t,o,a,s),ot.dispatchEvent(o),t.stopPropagation(),t.preventDefault()}))};t||(n("mousedown",ht.DOWN,(function(t,n,r,s){i._mousePressed=!0,i.handleTouchesBegin([i.getTouchByXY(t,r.x,r.y,s)]),e.focus()})),n("mouseup",ht.UP,(function(e,t,n,r){i._mousePressed=!1,i.handleTouchesEnd([i.getTouchByXY(e,n.x,n.y,r)])})),n("mousemove",ht.MOVE,(function(e,t,n,r){i.handleTouchesMove([i.getTouchByXY(e,n.x,n.y,r)]),i._mousePressed||t.setButton(ht.BUTTON_MISSING),void 0!==e.movementX&&void 0!==e.movementY&&(t.movementX=e.movementX,t.movementY=e.movementY)}))),n("mousewheel",ht.SCROLL,(function(e,t){t.setScrollData(0,e.wheelDelta)})),n("DOMMouseScroll",ht.SCROLL,(function(e,t){t.setScrollData(0,-120*e.detail)}))},t._registerMousePointerEvents=function(e){var t=this,i={MSPointerDown:this.handleTouchesBegin,MSPointerMove:this.handleTouchesMove,MSPointerUp:this.handleTouchesEnd,MSPointerCancel:this.handleTouchesCancel},n=function(n){var r=i[n];e.addEventListener(n,(function(i){var n=t.getHTMLElementPosition(e);n.left-=document.documentElement.scrollLeft,n.top-=document.documentElement.scrollTop,r.call(t,[t.getTouchByXY(i,i.clientX,i.clientY,n)]),i.stopPropagation()}),!1)};for(var r in i)n(r)},t._registerTouchEvents=function(e){var t=this,i=function(i){return function(n){if(n.changedTouches){var r=t.getHTMLElementPosition(e),s=document.body;r.left-=s.scrollLeft||0,r.top-=s.scrollTop||0,i(t.getTouchesByEvent(n,r)),n.stopPropagation(),n.preventDefault()}}};e.addEventListener("touchstart",i((function(i){t.handleTouchesBegin(i),e.focus()})),!1),e.addEventListener("touchmove",i((function(e){t.handleTouchesMove(e)})),!1),e.addEventListener("touchend",i((function(e){t.handleTouchesEnd(e)})),!1),e.addEventListener("touchcancel",i((function(e){t.handleTouchesCancel(e)})),!1)},t._registerKeyboardEvent=function(){var e=r.game.canvas;e.addEventListener("keydown",(function(e){ot.dispatchEvent(new ct(e,!0)),e.stopPropagation(),e.preventDefault()}),!1),e.addEventListener("keyup",(function(e){ot.dispatchEvent(new ct(e,!1)),e.stopPropagation(),e.preventDefault()}),!1)},t._registerAccelerometerEvent=function(){var e=this;this._acceleration=new fs,this._accelDeviceEvent=window.DeviceMotionEvent||window.DeviceOrientationEvent,r.sys.browserType===r.sys.BROWSER_TYPE_MOBILE_QQ&&(this._accelDeviceEvent=window.DeviceOrientationEvent);var t=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation";cs=function(){return e.didAccelerate.apply(e,arguments)},window.addEventListener(t,cs,!1)},t._unregisterAccelerometerEvent=function(){var e=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation";cs&&window.removeEventListener(e,cs,!1)},t._getUsefulTouches=function(){var e=[],t=this._touchesIntegerDict;for(var i in t){var n=t[parseInt(i)];if(null!=n){var r=this._touches[n];e.push(r)}}return e},e}(),gs=e("i",new ps);r.internal.inputManager=gs;var vs=e("G",function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).frame=null,t.container=null,t.canvas=null,t.renderType=-1,t.eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t.config={},t.onStart=null,t.collisionMatrix=[],t.groupList=[],t._persistRootNodes={},t._paused=!0,t._configLoaded=!1,t._isCloning=!1,t._inited=!1,t._engineInited=!1,t._rendererInitialized=!1,t._gfxDevice=null,t._intervalId=null,t}u(t,e);var n=t.prototype;return n.setFrameRate=function(e){var t=this.config;"number"!=typeof e&&(e=parseInt(e,10),Number.isNaN(e)&&(e=60)),t.frameRate=e,this._paused=!0,this._setAnimFrame(),this._runMainLoop()},n.getFrameRate=function(){return this.config.frameRate||0},n.step=function(){r.director.mainLoop()},n.pause=function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))},n.resume=function(){this._paused&&this._runMainLoop()},n.isPaused=function(){return this._paused},n.restart=function(){var e=this;return new Promise((function(e){return r.director.once(r.Director.EVENT_AFTER_DRAW,(function(){return e()}))})).then((function(){for(var i in e._persistRootNodes)e.removePersistRootNode(e._persistRootNodes[i]);return r.director.getScene().destroy(),r.Object._deferredDestroy(),r.director.reset(),e.pause(),e._setRenderPipelineNShowSplash().then((function(){e.resume(),e._safeEmit(t.EVENT_RESTART)}))}))},n.end=function(){this._gfxDevice&&(this._gfxDevice.destroy(),this._gfxDevice=null),window.close()},n.on=function(e,i,n,r){return this._engineInited&&e===t.EVENT_ENGINE_INITED?i.call(n):this.eventTargetOn(e,i,n,r)},n.once=function(e,i,n){return this._engineInited&&e===t.EVENT_ENGINE_INITED?i.call(n):this.eventTargetOnce(e,i,n)},n.init=function(e){var t=this;return this._initConfig(e),this.config.assetOptions&&r.assetManager.init(this.config.assetOptions),this._initEngine().then((function(){return t._initEvents(),r.director.root.dataPoolManager&&r.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(e.customJointTextureLayouts),t._engineInited}))},n.run=function(e,t){var i,n=this;return"function"!=typeof e&&e?(i=this.init(e),this.onStart=null!=t?t:null):this.onStart=null!=e?e:null,Promise.resolve(i).then((function(){return ms.config.registerSystemEvent&&gs.registerSystemEvent(ms.canvas),n._setRenderPipelineNShowSplash()}))},n.addPersistRootNode=function(e){if(r.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var i=r.director._scene;if(r.isValid(i))if(e.parent){if(!(e.parent instanceof r.Scene))return void Ce(3801);if(e.parent!==i)return void Ce(3802)}else e.parent=i;this._persistRootNodes[t]=e,e._persistNode=!0,r.assetManager._releaseManager._addPersistNodeRef(e)}}else Ce(3800)},n.removePersistRootNode=function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1,r.assetManager._releaseManager._removePersistNodeRef(e))},n.isPersistRootNode=function(e){return!!e._persistNode},n._initEngine=function(){var e=this;return this._initDevice(),Promise.resolve(r.director._init()).then((function(){xe("Cocos Creator v"+Me),e.emit(t.EVENT_ENGINE_INITED),e._engineInited=!0,r.internal.dynamicAtlasManager.enabled=!Le.CLEANUP_IMAGE_CACHE}))},n._setAnimFrame=function(){this._lastTime=performance.now();var e=this.config.frameRate;this._frameTime=1e3/e,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0);var t=window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;60!==e&&30!==e?(window.rAF=t?this._stTimeWithRAF:this._stTime,window.cAF=this._ctTime):(window.rAF=t||this._stTime,window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime)},n._stTimeWithRAF=function(e){var t=performance.now(),i=Math.max(0,t-ms._lastTime),n=Math.max(0,ms._frameTime-i),r=window.setTimeout((function(){window.requestAnimationFrame(e)}),n);return ms._lastTime=t+n,r},n._stTime=function(e){var t=performance.now(),i=Math.max(0,t-ms._lastTime),n=Math.max(0,ms._frameTime-i),r=window.setTimeout(e,n);return ms._lastTime=t+n,r},n._ctTime=function(e){window.clearTimeout(e)},n._runMainLoop=function(){var e=this;if(this._inited&&!ze){var t,i=this.config,n=r.director,s=i.frameRate;if(Ue(!!i.showFPS),n.startAnimation(),30===s){var a=!0;t=function(i){e._intervalId=window.rAF(t),(a=!a)||n.mainLoop(i)}}else t=function(i){e._intervalId=window.rAF(t),n.mainLoop(i)};this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._intervalId=window.rAF(t),this._paused=!1}},n._initConfig=function(e){"number"!=typeof e.debugMode&&(e.debugMode=He.NONE),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||t>2||t<0)&&(e.renderMode=0),"boolean"!=typeof e.registerSystemEvent&&(e.registerSystemEvent=!0),e.showFPS=!!e.showFPS,this.collisionMatrix=e.collisionMatrix||[],this.groupList=e.groupList||[],Ge(e.debugMode),this.config=e,this._configLoaded=!0,this._setAnimFrame()},n._determineRenderType=function(){var e=this.config,i=parseInt(e.renderMode,10);this.renderType=t.RENDER_TYPE_CANVAS;var n=!1;if(0===i?r.sys.capabilities.opengl?(this.renderType=t.RENDER_TYPE_WEBGL,n=!0):r.sys.capabilities.canvas&&(this.renderType=t.RENDER_TYPE_CANVAS,n=!0):1===i&&r.sys.capabilities.canvas?(this.renderType=t.RENDER_TYPE_CANVAS,n=!0):2===i&&r.sys.capabilities.opengl&&(this.renderType=t.RENDER_TYPE_WEBGL,n=!0),!n)throw new Error(Ve(3820,i))},n._initDevice=function(){if(!this._rendererInitialized){if(this.canvas=this.config.adapter.canvas,this.frame=this.config.adapter.frame,this.container=this.config.adapter.container,this._determineRenderType(),this.renderType===t.RENDER_TYPE_WEBGL){var e=[],i=!!window.WebGL2RenderingContext,n=window.navigator.userAgent.toLowerCase();(-1!==n.indexOf("safari")&&-1===n.indexOf("chrome")||Ne.browserType===Ne.BROWSER_TYPE_UC)&&(i=!1),i&&r.WebGL2Device&&e.push(r.WebGL2Device),r.WebGLDevice&&e.push(r.WebGLDevice);for(var s=new We(this.canvas,Le.ENABLE_WEBGL_ANTIALIAS,!1,window.devicePixelRatio,Ne.windowPixelResolution.width,Ne.windowPixelResolution.height,ke),a=0;a<e.length&&(this._gfxDevice=new e[a],!this._gfxDevice.initialize(s));a++);}if(!this._gfxDevice)return Qe("can not support canvas rendering in 3D"),void(this.renderType=t.RENDER_TYPE_CANVAS);this.canvas.oncontextmenu=function(){return!1}}},n._initEvents=function(){var e,i=this,n=window;void 0!==document.hidden?e="hidden":void 0!==document.mozHidden?e="mozHidden":void 0!==document.msHidden?e="msHidden":void 0!==document.webkitHidden&&(e="webkitHidden");var r=!1,s=this;function a(){r||(r=!0,s.emit(t.EVENT_HIDE))}function o(e,i,n,a,o){r&&(r=!1,s.emit(t.EVENT_SHOW,e,i,n,a,o))}if(e)for(var h=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],u=0;u<h.length;u++)document.addEventListener(h[u],(function(t){var i=document[e];(i=i||t.hidden)?a():o()}));else n.addEventListener("blur",a),n.addEventListener("focus",o);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(n.onfocus=o),"onpageshow"in window&&"onpagehide"in window&&(n.addEventListener("pagehide",a),n.addEventListener("pageshow",o),document.addEventListener("pagehide",a),document.addEventListener("pageshow",o)),this.on(t.EVENT_HIDE,(function(){i.pause()})),this.on(t.EVENT_SHOW,(function(){i.resume()}))},n._setRenderPipelineNShowSplash=function(){var e=this;return Promise.resolve(this._setupRenderPipeline()).then((function(){return Promise.resolve(e._showSplashScreen()).then((function(){e._inited=!0,e._setAnimFrame(),e._runMainLoop(),e._safeEmit(t.EVENT_GAME_INITED),e.onStart&&e.onStart()}))}))},n._setupRenderPipeline=function(){var e=this,t=this.config.renderPipeline;return t?new Promise((function(e,i){r.assetManager.loadAny(t,(function(t,n){return!t&&n instanceof qt?e(n):i(t)}))})).then((function(t){e._setRenderPipeline(t)})).catch((function(i){Xe(i),Xe("Failed load render pipeline: "+t+", engine failed to initialize, will fallback to default pipeline"),e._setRenderPipeline()})):this._setRenderPipeline()},n._showSplashScreen=function(){if(r.internal.SplashScreen){var e=r.internal.SplashScreen.instance;return e.main(r.director.root),new Promise((function(t){e.setOnFinish((function(){return t()})),e.loadFinish=!0}))}return null},n._setRenderPipeline=function(e){r.director.root.setRenderPipeline(e)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(t.EVENT_RENDERER_INITED)},n._safeEmit=function(e){this.emit(e)},i(t,[{key:"inited",get:function(){return this._inited}},{key:"frameTime",get:function(){return this._frameTime}}]),t}(Ye));vs.EVENT_HIDE="game_on_hide",vs.EVENT_SHOW="game_on_show",vs.EVENT_LOW_MEMORY="game_on_low_memory",vs.EVENT_GAME_INITED="game_inited",vs.EVENT_ENGINE_INITED="engine_inited",vs.EVENT_RENDERER_INITED="renderer_inited",vs.EVENT_RESTART="game_on_restart",vs.RENDER_TYPE_CANVAS=0,vs.RENDER_TYPE_WEBGL=1,vs.RENDER_TYPE_OPENGL=2,r.Game=vs;var ms=e("g",r.game=new vs),Es=e("j",{topLeft:r.v2(0,0),topRight:r.v2(0,0),top:r.v2(0,0),bottomLeft:r.v2(0,0),bottomRight:r.v2(0,0),bottom:r.v2(0,0),center:r.v2(0,0),left:r.v2(0,0),right:r.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,i=this.height=e.height,n=e.x,r=e.y,s=r+i,a=n+t;this.topLeft.x=n,this.topLeft.y=s,this.topRight.x=a,this.topRight.y=s,this.top.x=n+t/2,this.top.y=s,this.bottomLeft.x=n,this.bottomLeft.y=r,this.bottomRight.x=a,this.bottomRight.y=r,this.bottom.x=n+t/2,this.bottom.y=r,this.center.x=n+t/2,this.center.y=r+i/2,this.left.x=n,this.left.y=r+i/2,this.right.x=a,this.right.y=r+i/2}});r.visibleRect=Es;var ws=new(function(){function e(){this.html=void 0,this.meta={width:"device-width"},this.adaptationType=r.sys.browserType}var t=e.prototype;return t.init=function(){},t.availWidth=function(e){return r.sys.isMobile||!e||e===this.html?window.innerWidth:e.clientWidth},t.availHeight=function(e){return r.sys.isMobile||!e||e===this.html?window.innerHeight:e.clientHeight},e}());switch(r.sys.os===r.sys.OS_IOS&&(ws.adaptationType=r.sys.BROWSER_TYPE_SAFARI),ws.adaptationType){case r.sys.BROWSER_TYPE_SAFARI:ws.meta["minimal-ui"]="true",ws.availWidth=function(e){return e.clientWidth},ws.availHeight=function(e){return e.clientHeight};break;case r.sys.BROWSER_TYPE_SOUGOU:case r.sys.BROWSER_TYPE_UC:ws.availWidth=function(e){return e.clientWidth},ws.availHeight=function(e){return e.clientHeight}}var Ss=e("V",function(e){function t(){var t;(t=e.call(this)||this)._resizeWithBrowserSize=void 0,t._designResolutionSize=void 0,t._originalDesignResolutionSize=void 0,t._frameSize=void 0,t._scaleX=void 0,t._scaleY=void 0,t._viewportRect=void 0,t._visibleRect=void 0,t._autoFullScreen=void 0,t._devicePixelRatio=void 0,t._maxPixelRatio=void 0,t._retinaEnabled=void 0,t._resizeCallback=void 0,t._resizing=void 0,t._orientationChanging=void 0,t._isRotated=void 0,t._orientation=void 0,t._isAdjustViewport=void 0,t._resolutionPolicy=void 0,t._rpExactFit=void 0,t._rpShowAll=void 0,t._rpNoBorder=void 0,t._rpFixedHeight=void 0,t._rpFixedWidth=void 0;var i=ys,n=Ts;return t._frameSize=new je(0,0),t._designResolutionSize=new je(0,0),t._originalDesignResolutionSize=new je(0,0),t._scaleX=1,t._scaleY=1,t._viewportRect=new Je(0,0,0,0),t._visibleRect=new Je(0,0,0,0),t._autoFullScreen=!1,t._devicePixelRatio=1,t._maxPixelRatio=2,t._retinaEnabled=!1,t._resizeCallback=null,t._resizing=!1,t._resizeWithBrowserSize=!1,t._orientationChanging=!0,t._isRotated=!1,t._orientation=r.macro.ORIENTATION_AUTO,t._isAdjustViewport=!0,t._rpExactFit=new Os(i.EQUAL_TO_FRAME,n.EXACT_FIT),t._rpShowAll=new Os(i.EQUAL_TO_FRAME,n.SHOW_ALL),t._rpNoBorder=new Os(i.EQUAL_TO_FRAME,n.NO_BORDER),t._rpFixedHeight=new Os(i.EQUAL_TO_FRAME,n.FIXED_HEIGHT),t._rpFixedWidth=new Os(i.EQUAL_TO_FRAME,n.FIXED_WIDTH),t._resolutionPolicy=t._rpShowAll,r.game.once(r.Game.EVENT_ENGINE_INITED,t.init,f(t)),t}u(t,e);var i=t.prototype;return i.init=function(){ws.init(),this._initFrameSize();var e=r.game.canvas.width,t=r.game.canvas.height;this._designResolutionSize.width=e,this._designResolutionSize.height=t,this._originalDesignResolutionSize.width=e,this._originalDesignResolutionSize.height=t,this._viewportRect.width=e,this._viewportRect.height=t,this._visibleRect.width=e,this._visibleRect.height=t,r.winSize.width=this._visibleRect.width,r.winSize.height=this._visibleRect.height,r.visibleRect&&r.visibleRect.init(this._visibleRect)},i.resizeWithBrowserSize=function(e){e?this._resizeWithBrowserSize||(this._resizeWithBrowserSize=!0,window.addEventListener("resize",this._resizeEvent),window.addEventListener("orientationchange",this._orientationChange)):this._resizeWithBrowserSize&&(this._resizeWithBrowserSize=!1,window.removeEventListener("resize",this._resizeEvent),window.removeEventListener("orientationchange",this._orientationChange))},i.setResizeCallback=function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)},i.setOrientation=function(e){(e&=r.macro.ORIENTATION_AUTO)&&this._orientation!==e&&(this._orientation=e)},i.adjustViewportMeta=function(e){this._isAdjustViewport=e},i.enableRetina=function(e){this._retinaEnabled=!!e},i.isRetinaEnabled=function(){return this._retinaEnabled},i.enableAutoFullScreen=function(e){e&&e!==this._autoFullScreen&&r.sys.isMobile&&r.sys.browserType!==r.sys.BROWSER_TYPE_WECHAT?(this._autoFullScreen=!0,r.screen.autoFullScreen(r.game.frame)):this._autoFullScreen=!1},i.isAutoFullScreenEnabled=function(){return this._autoFullScreen},i.setCanvasSize=function(e,t){var i=r.game.canvas,n=r.game.container;this._devicePixelRatio=window.devicePixelRatio,i.width=Ne.windowPixelResolution.width,i.height=Ne.windowPixelResolution.height,i.style.width=e+"px",i.style.height=t+"px",n.style.width=e+"px",n.style.height=t+"px",this._resizeEvent()},i.getCanvasSize=function(){return new je(r.game.canvas.width,r.game.canvas.height)},i.getFrameSize=function(){return new je(this._frameSize.width,this._frameSize.height)},i.setFrameSize=function(e,t){this._frameSize.width=e,this._frameSize.height=t,r.game.frame.style.width=e+"px",r.game.frame.style.height=t+"px",this._resizeEvent()},i.getVisibleSize=function(){return new je(this._visibleRect.width,this._visibleRect.height)},i.getVisibleSizeInPixel=function(){return new je(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)},i.getVisibleOrigin=function(){return new Be(this._visibleRect.x,this._visibleRect.y)},i.getVisibleOriginInPixel=function(){return new Be(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)},i.getResolutionPolicy=function(){return this._resolutionPolicy},i.setResolutionPolicy=function(e){if(e instanceof Os)this._resolutionPolicy=e;else{var t=Os;e===t.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),e===t.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),e===t.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),e===t.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),e===t.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}},i.setDesignResolutionSize=function(e,t,i){if(e>0&&t>0){this.setResolutionPolicy(i);var n=this._resolutionPolicy;if(n&&n.preApply(this),r.sys.isMobile&&this._adjustViewportMeta(),this._orientationChanging=!0,this._resizing||this._initFrameSize(),n){this._originalDesignResolutionSize.width=this._designResolutionSize.width=e,this._originalDesignResolutionSize.height=this._designResolutionSize.height=t;var s=n.apply(this,this._designResolutionSize);if(s.scale&&2===s.scale.length&&(this._scaleX=s.scale[0],this._scaleY=s.scale[1]),s.viewport){var a=this._viewportRect,o=this._visibleRect,h=s.viewport;a.x=h.x,a.y=h.y,a.width=h.width,a.height=h.height,o.x=0,o.y=0,o.width=h.width/this._scaleX,o.height=h.height/this._scaleY}n.postApply(this),r.winSize.width=this._visibleRect.width,r.winSize.height=this._visibleRect.height,Es&&Es.init(this._visibleRect),this.emit("design-resolution-changed")}else Pe(2201)}else Fe(2200)},i.getDesignResolutionSize=function(){return new je(this._designResolutionSize.width,this._designResolutionSize.height)},i.setRealPixelResolution=function(e,t,i){this.setDesignResolutionSize(e,t,i)},i.getViewportRect=function(){return this._viewportRect},i.getScaleX=function(){return this._scaleX},i.getScaleY=function(){return this._scaleY},i.getDevicePixelRatio=function(){return this._devicePixelRatio},i.convertToLocationInView=function(e,t,i,n){var s=n||new Be,a=this._devicePixelRatio*(e-i.left),o=this._devicePixelRatio*(i.top+i.height-t);return this._isRotated?(s.x=r.game.canvas.width-o,s.y=a):(s.x=a,s.y=o),r.GAME_VIEW&&(s.x/=r.gameView.canvas.width/r.game.canvas.width,s.y/=r.gameView.canvas.height/r.game.canvas.height),s},i._convertPointWithScale=function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY},i._resizeEvent=function(){var e=r.view,t=e._frameSize.width,i=e._frameSize.height,n=e._isRotated;if(r.sys.isMobile){var s=r.game.container.style,a=s.margin;s.margin="0",s.display="none",e._initFrameSize(),s.margin=a,s.display="block"}else e._initFrameSize();if(e._orientationChanging||e._isRotated!==n||e._frameSize.width!==t||e._frameSize.height!==i){var o=e._originalDesignResolutionSize.width,h=e._originalDesignResolutionSize.height;e._resizing=!0,o>0&&e.setDesignResolutionSize(o,h,e._resolutionPolicy),e._resizing=!1,e.emit("canvas-resize"),e._resizeCallback&&e._resizeCallback.call()}},i._orientationChange=function(){r.view._orientationChanging=!0,r.view._resizeEvent()},i._initFrameSize=function(){var e=this._frameSize,t=ws.availWidth(r.game.frame),i=ws.availHeight(r.game.frame),n=t>=i;!r.sys.isMobile||n&&this._orientation&r.macro.ORIENTATION_LANDSCAPE||!n&&this._orientation&r.macro.ORIENTATION_PORTRAIT?(e.width=t,e.height=i,r.game.container.style["-webkit-transform"]="rotate(0deg)",r.game.container.style.transform="rotate(0deg)",this._isRotated=!1):(e.width=i,e.height=t,r.game.container.style["-webkit-transform"]="rotate(90deg)",r.game.container.style.transform="rotate(90deg)",r.game.container.style["-webkit-transform-origin"]="0px 0px 0px",r.game.container.style.transformOrigin="0px 0px 0px",this._isRotated=!0,r.game.canvas.style["-webkit-transform"]="translateZ(0px)",r.game.canvas.style.transform="translateZ(0px)"),this._orientationChanging&&setTimeout((function(){r.view._orientationChanging=!1}),1e3)},i._adjustSizeKeepCanvasSize=function(){var e=this._originalDesignResolutionSize.width,t=this._originalDesignResolutionSize.height;e>0&&this.setDesignResolutionSize(e,t,this._resolutionPolicy)},i._setViewportMeta=function(e,t){var i=document.getElementById("cocosMetaElement");i&&t&&document.head.removeChild(i);var n,r,s,a=document.getElementsByName("viewport"),o=a?a[0]:null;for(r in n=o?o.content:"",(i=i||document.createElement("meta")).id="cocosMetaElement",i.name="viewport",i.content="",e)-1===n.indexOf(r)?n+=","+r+"="+e[r]:t&&(s=new RegExp(r+"s*=s*[^,]+"),n=n.replace(s,r+"="+e[r]));/^,/.test(n)&&(n=n.substr(1)),i.content=n,o&&(o.content=n),document.head.appendChild(i)},i._adjustViewportMeta=function(){!this._isAdjustViewport||Ze||qe||Ke||(this._setViewportMeta(ws.meta,!1),this._isAdjustViewport=!1)},i._convertMouseToLocation=function(e,t){e.x=this._devicePixelRatio*(e.x-t.left),e.y=this._devicePixelRatio*(t.top+t.height-e.y),r.GAME_VIEW&&(e.x/=r.gameView.canvas.width/r.game.canvas.width,e.y/=r.gameView.canvas.height/r.game.canvas.height)},i._convertTouchWidthScale=function(e){var t=this._viewportRect,i=this._scaleX,n=this._scaleY;e._point.x=(e._point.x-t.x)/i,e._point.y=(e._point.y-t.y)/n,e._prevPoint.x=(e._prevPoint.x-t.x)/i,e._prevPoint.y=(e._prevPoint.y-t.y)/n},i._convertTouchesWithScale=function(e){for(var t,i,n=this._viewportRect,r=this._scaleX,s=this._scaleY,a=0;a<e.length;a++){var o=e[a];t=o._point,i=o._prevPoint,t.x=(t.x-n.x)/r,t.y=(t.y-n.y)/s,i.x=(i.x-n.x)/r,i.y=(i.y-n.y)/s}},t}(Ye));Ss.instance=void 0;var ys=function(){function e(){this.name="ContainerStrategy"}var t=e.prototype;return t.preApply=function(){},t.apply=function(){},t.postApply=function(){},t._setupContainer=function(e,t,i){var n=r.game.canvas,s=r.game.container;r.sys.os===r.sys.OS_ANDROID&&(document.body.style.width=(e._isRotated?i:t)+"px",document.body.style.height=(e._isRotated?t:i)+"px"),s.style.width=n.style.width=t+"px",s.style.height=n.style.height=i+"px",e._devicePixelRatio=1,e.isRetinaEnabled()&&(e._devicePixelRatio=Math.min(e._maxPixelRatio,window.devicePixelRatio||1)),n.width=t*e._devicePixelRatio,n.height=i*e._devicePixelRatio},t._fixContainer=function(){document.body.insertBefore(r.game.container,document.body.firstChild);var e=document.body.style;e.width=window.innerWidth+"px",e.height=window.innerHeight+"px",e.overflow="hidden";var t=r.game.container.style;t.position="fixed",t.left=t.top="0px",document.body.scrollTop=0},e}();ys.EQUAL_TO_FRAME=void 0,ys.PROPORTION_TO_FRAME=void 0;var Ts=function(){function e(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}var t=e.prototype;return t.preApply=function(){},t.apply=function(){return{scale:[1,1]}},t.postApply=function(){},t._buildResult=function(e,t,i,n,r,s){Math.abs(e-i)<2&&(i=e),Math.abs(t-n)<2&&(n=t);var a=new Je(Math.round((e-i)/2),Math.round((t-n)/2),i,n);return this._result.scale=[r,s],this._result.viewport=a,this._result},e}();Ts.EXACT_FIT=void 0,Ts.SHOW_ALL=void 0,Ts.NO_BORDER=void 0,Ts.FIXED_HEIGHT=void 0,Ts.FIXED_WIDTH=void 0,function(){var e=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="EqualToFrame",t}return u(t,e),t.prototype.apply=function(e){var t=e._frameSize.height,i=r.game.container.style;this._setupContainer(e,e._frameSize.width,e._frameSize.height),e._isRotated?i.margin="0 0 0 "+t+"px":i.margin="0px",i.padding="0px"},t}(ys),t=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="ProportionalToFrame",t}return u(t,e),t.prototype.apply=function(e,t){var i,n,s=e._frameSize.width,a=e._frameSize.height,o=r.game.container.style,h=t.width,u=t.height,c=s/h,d=a/u;c<d?(i=s,n=u*c):(i=h*d,n=a);var l=Math.round((s-i)/2),_=Math.round((a-n)/2);i=s-2*l,n=a-2*_,this._setupContainer(e,i,n),e._isRotated?o.margin="0 0 0 "+a+"px":o.margin="0px",o.paddingLeft=l+"px",o.paddingRight=l+"px",o.paddingTop=_+"px",o.paddingBottom=_+"px"},t}(ys),i=("undefined"==typeof window?global:window).__globalAdapter;i&&(i.adaptContainerStrategy&&i.adaptContainerStrategy(ys.prototype),i.adaptView&&i.adaptView(Ss.prototype)),ys.EQUAL_TO_FRAME=new e,ys.PROPORTION_TO_FRAME=new t;var n=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="ExactFit",t}return u(t,e),t.prototype.apply=function(e,t){var i=r.game.canvas.width,n=r.game.canvas.height,s=i/t.width,a=n/t.height;return this._buildResult(i,n,i,n,s,a)},t}(Ts),s=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="ShowAll",t}return u(t,e),t.prototype.apply=function(e,t){var i,n,s=r.game.canvas.width,a=r.game.canvas.height,o=t.width,h=t.height,u=s/o,c=a/h,d=0;return u<c?(i=s,n=h*(d=u)):(i=o*(d=c),n=a),this._buildResult(s,a,i,n,d,d)},t}(Ts),a=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="NoBorder",t}return u(t,e),t.prototype.apply=function(e,t){var i,n,s,a=r.game.canvas.width,o=r.game.canvas.height,h=t.width,u=t.height,c=a/h,d=o/u;return c<d?(n=h*(i=d),s=o):(n=a,s=u*(i=c)),this._buildResult(a,o,n,s,i,i)},t}(Ts),o=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="FixedHeight",t}return u(t,e),t.prototype.apply=function(e,t){var i=r.game.canvas.width,n=r.game.canvas.height,s=n/t.height,a=i,o=n;return this._buildResult(i,n,a,o,s,s)},t}(Ts),h=function(e){function t(){for(var t,i=arguments.length,n=new Array(i),r=0;r<i;r++)n[r]=arguments[r];return(t=e.call.apply(e,[this].concat(n))||this).name="FixedWidth",t}return u(t,e),t.prototype.apply=function(e,t){var i=r.game.canvas.width,n=r.game.canvas.height,s=i/t.width,a=i,o=n;return this._buildResult(i,n,a,o,s,s)},t}(Ts);Ts.EXACT_FIT=new n,Ts.SHOW_ALL=new s,Ts.NO_BORDER=new a,Ts.FIXED_HEIGHT=new o,Ts.FIXED_WIDTH=new h}();var Os=e("R",function(){function e(e,t){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(e),this.setContentStrategy(t)}var t=e.prototype;return t.preApply=function(e){this._containerStrategy.preApply(e),this._contentStrategy.preApply(e)},t.apply=function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)},t.postApply=function(e){this._containerStrategy.postApply(e),this._contentStrategy.postApply(e)},t.setContainerStrategy=function(e){e instanceof ys&&(this._containerStrategy=e)},t.setContentStrategy=function(e){e instanceof Ts&&(this._contentStrategy=e)},i(e,[{key:"canvasSize",get:function(){return new Be(r.game.canvas.width,r.game.canvas.height)}}]),e}());Os.EXACT_FIT=0,Os.NO_BORDER=1,Os.SHOW_ALL=2,Os.FIXED_HEIGHT=3,Os.FIXED_WIDTH=4,Os.UNKNOWN=5,Os.ContainerStrategy=ys,Os.ContentStrategy=Ts,r.ResolutionPolicy=Os,e("v",Ss.instance=r.view=new Ss),r.winSize=new je}}}));
