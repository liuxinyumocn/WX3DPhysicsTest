System.register(["./coordinates-converts-utils-bf8713a9.js","./event-enum-5a5aa40e.js","./deprecated-3.0.0-f3f53c89.js","./renderable-component-658e90bd.js","./texture-buffer-pool-d3259f64.js","./view-7d20208a.js","./json-asset-0797cbb7.js","./camera-component-f1234106.js","./find-5191dd26.js","./create-mesh-c76737d1.js","./mesh-3d4ecfd0.js","./mesh-renderer-2e509a4a.js"],(function(t){"use strict";var e,s,i,a,r,h,o,n,c,_,u,f,d,l,v,m,g;return{setters:[function(t){e=t.e4,s=t.e2,i=t.e3,a=t.l,r=t.dT,h=t.cO,o=t.cP,n=t.F,c=t.dY,_=t.d0,u=t.cb,f=t.ew,d=t.dh},function(){},function(){},function(t){l=t.N},function(){},function(){},function(){},function(t){v=t.C},function(){},function(t){m=t.c},function(){},function(t){g=t.M}],execute:function(){var p,E=function(){function t(t,e,s){this._id=void 0,this._opts=void 0,this._accumStart=void 0,this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=t,this._opts=e,this._accumStart=s}e(t,[{key:"value",get:function(){return this._value},set:function(t){this._value=t}}]);var s=t.prototype;return s.sample=function(t){this._average(this._value,t)},s.human=function(){var t=this._opts,e=t.average,s=t.isInteger,i=e?this._averageValue:this._value;return s?Math.round(i):Math.round(100*i)/100},s.alarm=function(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over},s._average=function(t,e){if(void 0===e&&(e=0),this._opts.average){this._accumValue+=t,++this._accumSamples;var s=e;s-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=s,this._accumSamples=0)}},t}(),w=s("cc.PerfCounter")(p=function(t){function e(e,s,i){var a;return(a=t.call(this,e,s,i)||this)._time=void 0,a._time=i,a}i(e,t);var s=e.prototype;return s.start=function(t){void 0===t&&(t=0),this._time=t},s.end=function(t){void 0===t&&(t=0),this._value=t-this._time,this._average(this._value)},s.tick=function(){this.end(),this.start()},s.frame=function(t){var e=t,s=e-this._time;this._total++,s>(this._opts.average||1e3)&&(this._value=1e3*this._total/s,this._total=0,this._time=e,this._average(this._value))},e}(E))||p,T={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10},D={fps:{desc:"Framerate (FPS)",below:30,average:500,isInteger:!0},draws:{desc:"Draw call",isInteger:!0},frame:{desc:"Frame time (ms)",min:0,max:50,average:500},instances:{desc:"Instance Count",isInteger:!0},tricount:{desc:"Triangle",isInteger:!0},logic:{desc:"Game Logic (ms)",min:0,max:50,average:500,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:500},render:{desc:"Renderer (ms)",min:0,max:50,average:500,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}},N=t("Profiler",function(){function t(){this._stats=null,this.id="__Profiler__",this._showFPS=!1,this._rootNode=null,this._device=null,this._canvas=null,this._ctx=null,this._texture=null,this._region=new d,this._canvasArr=[],this._regionArr=[this._region],this.digitsData=null,this.offsetData=null,this.pass=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=256/(Object.keys(D).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0,this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._canvasArr.push(this._canvas)}var e=t.prototype;return e.isShowingStats=function(){return this._showFPS},e.hideStats=function(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),a.game.off(a.Game.EVENT_RESTART,this.generateNode,this),a.director.off(a.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),a.director.off(a.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),a.director.off(a.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),a.director.off(a.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),a.director.off(a.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),a.director.off(a.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!1)},e.showStats=function(){this._showFPS||(this._device||(this._device=a.director.root.device),this.generateCanvas(),this.generateStats(),a.game.once(a.Game.EVENT_ENGINE_INITED,this.generateNode,this),a.game.on(a.Game.EVENT_RESTART,this.generateNode,this),this._rootNode&&(this._rootNode.active=!0),a.director.on(a.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),a.director.on(a.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),a.director.on(a.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),a.director.on(a.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),a.director.on(a.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),a.director.on(a.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0)},e.generateCanvas=function(){if(!this._canvasDone){this._ctx&&this._canvas&&(this._canvas.width=256,this._canvas.height=256,this._canvas.style.width=""+this._canvas.width,this._canvas.style.height=""+this._canvas.height,this._ctx.font="23px Arial",this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture(new r(h.TEX2D,o.SAMPLED|o.TRANSFER_DST,n.RGBA8,256,256)),this._region.texExtent.width=256,this._region.texExtent.height=256)}},e.generateStats=function(){if(!this._statsDone&&this._ctx&&this._canvas){this._stats=null;var t=performance.now();this._ctx.textAlign="left";var e=0;for(var s in D){var i=D[s];this._ctx.fillText(i.desc,0,e*this._lineHeight),i.counter=new w(s,i,t),e++}this._totalLines=e,this._wordHeight=this._totalLines*this._lineHeight/this._canvas.height;for(var a=0;a<"0123456789. ".length;++a){var r=this._ctx.measureText("0123456789. "[a]).width;this._eachNumWidth=Math.max(this._eachNumWidth,r)}for(var h=0;h<"0123456789. ".length;++h)this._ctx.fillText("0123456789. "[h],h*this._eachNumWidth,this._totalLines*this._lineHeight);this._eachNumWidth/=this._canvas.width,this._stats=D,this._canvasArr[0]=this._canvas,this._device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}},e.generateNode=function(){if(!this._rootNode||!this._rootNode.isValid){this._rootNode=new l("PROFILER_NODE"),a.game.addPersistRootNode(this._rootNode);var t=new l("Profiler_Camera");t.setPosition(0,0,1.5),t.parent=this._rootNode;var e=t.addComponent("cc.Camera");e.projection=v.ProjectionType.ORTHO,e.orthoHeight=1,e.near=1,e.far=2,e.visibility=c.BitMask.PROFILER,e.clearFlags=_.NONE,e.priority=4294967295;var s=new l("Profiler_Root");s.parent=this._rootNode;for(var i=.4/this._totalLines,r=.4/this._wordHeight,h=i/23,o=this._eachNumWidth*this._canvas.width*h,n=[0,.4,0,r,.4,0,r,0,0,0,0,0],f=[0,2,1,0,3,2],d=[0,0,-1,0,1,0,-1,0,1,this._wordHeight,-1,0,0,this._wordHeight,-1,0],p=0,E=0;E<this._totalLines;E++)for(var w=0;w<8;w++){n.push(r+w*o,.4-E*i,0),n.push(r+(w+1)*o,.4-E*i,0),n.push(r+(w+1)*o,.4-(E+1)*i,0),n.push(r+w*o,.4-(E+1)*i,0),p=4*(8*E+w+1),f.push(0+p,2+p,1+p,0+p,3+p,2+p);var T=8*E+w,D=Math.floor(T/4),N=T-4*D;d.push(0,this._wordHeight,D,N),d.push(this._eachNumWidth,this._wordHeight,D,N),d.push(this._eachNumWidth,1,D,N),d.push(0,1,D,N)}var S=s.addComponent(g);S.mesh=m({positions:n,indices:f,colors:d});var x=new u;x.initialize({effectName:"profiler"});var P=this.pass=x.passes[0],R=P.getBinding("mainTexture"),y=P.getBinding("digits"),F=P.getBinding("offset");P.bindTexture(R,this._texture),this.digitsData=P.blocks[y],this.offsetData=P.blocks[F],this.offsetData[3]=-1,S.material=x,S.node.layer=c.Enum.PROFILER,this._inited=!0}},e.beforeUpdate=function(){if(this._stats){var t=performance.now();this._stats.frame.counter.end(t),this._stats.frame.counter.start(t),this._stats.logic.counter.start(t)}},e.afterUpdate=function(){if(this._stats){var t=performance.now();a.director.isPaused()?this._stats.frame.counter.start(t):this._stats.logic.counter.end(t)}},e.beforePhysics=function(){if(this._stats){var t=performance.now();this._stats.physics.counter.start(t)}},e.afterPhysics=function(){if(this._stats){var t=performance.now();this._stats.physics.counter.end(t)}},e.beforeDraw=function(){if(this._stats){var t=this._device,e=t.screenSpaceSignY,s=t.surfaceTransform;if(s!==this.offsetData[3]){var i=f[s],a=-.9*e;this.offsetData[0]=-.9*i[0]+a*i[2],this.offsetData[1]=-.9*i[1]+a*i[3],this.offsetData[2]=this._eachNumWidth,this.offsetData[3]=s}this.pass._rootBufferDirty=!0;var r=performance.now();this._stats.render.counter.start(r)}},e.afterDraw=function(){if(this._stats&&this._inited){var t=performance.now();if(this._stats.fps.counter.frame(t),this._stats.render.counter.end(t),!(t-this.lastTime<500)){this.lastTime=t;var e=this._device;this._stats.draws.counter.value=e.numDrawCalls,this._stats.instances.counter.value=e.numInstances,this._stats.bufferMemory.counter.value=e.memoryStatus.bufferSize/1048576,this._stats.textureMemory.counter.value=e.memoryStatus.textureSize/1048576,this._stats.tricount.counter.value=e.numTris;var s=0,i=this.digitsData;for(var a in this._stats){var r=this._stats[a];r.counter.sample(t);for(var h=r.counter.human().toString(),o=7;o>=0;o--){var n=8*s+o,c=h[h.length-(8-o)],_=T[c];void 0===_&&(_=11),i[n]=_}s++}}}},t}()),S=t("profiler",new N);a.profiler=S}}}));
