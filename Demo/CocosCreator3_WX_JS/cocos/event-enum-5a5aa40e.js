System.register(["./coordinates-converts-utils-bf8713a9.js","./deprecated-3.0.0-f3f53c89.js"],(function(e){"use strict";var t,i,n,s,r,o,h,a,_,u,c,l,d,f,p,v,g,E,y,T,L,m,S,A,O,w,C,I,P,D,R,N,M,b,H,k,U,F,V,x,B,G,j,Y,W,z,K,X,Z,J,q,Q,$,ee,te,ie,ne;return{setters:[function(e){t=e.e4,i=e.bg,n=e.a1,s=e.aD,r=e.b2,o=e.aC,h=e.l,a=e.b9,_=e.d0,u=e.at,c=e.as,l=e.ev,d=e.aB,f=e.d3,p=e.ew,v=e.bn,g=e.bo,E=e.dc,y=e.be,T=e.aL,L=e.aK,m=e.ex,S=e.aj,A=e.ai,O=e.B,w=e.v,C=e.M,I=e.A,P=e.I,D=e.bD,R=e.b0,N=e.aJ,M=e.cb,b=e.aI,H=e.e3,k=e.e8,U=e.S,F=e.O,V=e.ah,x=e.ag,B=e.t,G=e.aF,j=e.aE,Y=e.e0,W=e.Y,z=e.ey,K=e.c2,X=e.c,Z=e.g,J=e.d,q=e.f,Q=e.cl,$=e.bE},function(e){ee=e.r,te=e.R,ie=e.F,ne=e.S}],execute:function(){e({C:void 0,L:void 0,N:void 0,T:void 0,a:void 0,b:void 0,c:void 0,d:void 0,f:Te,q:void 0});var se,re,oe,he,ae,_e=e("A",function(){function e(){this._skyColor=new i(51,128,204,1),this._groundAlbedo=new i(51,51,51,255),this._albedoArray=Float32Array.from([.2,.2,.2,1]),this._colorArray=Float32Array.from([.2,.5,.8,1]),this._handle=n,this._handle=s.alloc()}t(e,[{key:"colorArray",get:function(){return this._colorArray}},{key:"albedoArray",get:function(){return this._albedoArray}},{key:"enabled",set:function(e){s.set(this._handle,o.ENABLE,e?1:0)},get:function(){return s.get(this._handle,o.ENABLE)}},{key:"skyColor",get:function(){return this._skyColor},set:function(e){this._skyColor.set(e),i.toArray(this._colorArray,this._skyColor),s.setVec4(this._handle,o.SKY_COLOR,this._skyColor)}},{key:"skyIllum",get:function(){return s.get(this._handle,o.ILLUM)},set:function(e){s.set(this._handle,o.ILLUM,e)}},{key:"groundAlbedo",get:function(){return this._groundAlbedo},set:function(e){this._groundAlbedo.set(e),r.toArray(this._albedoArray,this._groundAlbedo),s.setVec4(this._handle,o.GROUND_ALBEDO,this._groundAlbedo)}},{key:"handle",get:function(){return this._handle}}]);var h=e.prototype;return h.initialize=function(e){this._skyColor.set(e.skyColor),this._groundAlbedo.set(e.groundAlbedo),i.toArray(this._colorArray,this._skyColor),r.toArray(this._albedoArray,this._groundAlbedo),s.setVec4(this._handle,o.SKY_COLOR,this._skyColor),s.setVec4(this._handle,o.GROUND_ALBEDO,this._groundAlbedo),s.set(this._handle,o.ILLUM,e.skyIllum)},h.destroy=function(){this._handle&&(s.free(this._handle),this._handle=n)},e}());_e.SUN_ILLUM=65e3,_e.SKY_ILLUM=2e4,h.Ambient=_e,function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(se||(se=e("C",{}))),function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(re||(re=e("a",{}))),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}(oe||(oe=e("b",{}))),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(he||(he=e("c",{}))),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(ae||(ae=e("d",{})));var ue,ce,le,de=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],fe=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],pe=[100,200,400,800],ve=new r,ge=new r,Ee=new a,ye=(e("S",_.STENCIL<<1),[]);function Te(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);var i=t*t,n=(.860117757+.000154118254*t+1.28641212e-7*i)/(1+.000842420235*t+7.08145163e-7*i),s=(.317398726+422806245e-13*t+4.20481691e-8*i)/(1-289741816e-13*t+1.61456053e-7*i),r=2*n-8*s+4,o=3*n/r,h=2*s/r,a=1/h*o,_=1/h*(1-o-h);e.x=3.2404542*a-1.5371385+-.4985314*_,e.y=-.969266*a+1.8760108+.041556*_,e.z=.0556434*a-.2040259+1.0572252*_}e("e",function(){function e(e){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=se.VERTICAL,this._fov=g(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new E(.2,.2,.2,1),this._viewport=new y(0,0,1,1),this._curTransform=f.IDENTITY,this._isProjDirty=!0,this._matView=new a,this._matViewInv=null,this._matProj=new a,this._matProjInv=new a,this._matViewProj=new a,this._matViewProjInv=new a,this._frustum=new ie,this._forward=new r,this._position=new r,this._priority=0,this._aperture=oe.F16_0,this._apertureValue=void 0,this._shutter=ae.D125,this._shutterValue=0,this._iso=he.ISO100,this._isoValue=0,this._ec=0,this._poolHandle=n,this._frustumHandle=n,this._window=null,this._device=e,this._apertureValue=de[this._aperture],this._shutterValue=fe[this._shutter],this._isoValue=pe[this._iso],this._aspect=this.screenScale=1,!ye.length){var t=e.screenSpaceSignY;ye[f.IDENTITY]=new a(1,0,0,0,0,t),ye[f.ROTATE_90]=new a(0,1,0,0,-t,0),ye[f.ROTATE_180]=new a(-1,0,0,0,0,-t),ye[f.ROTATE_270]=new a(0,-1,0,0,t,0)}}var i=e.prototype;return i.initialize=function(e){this._name=e.name,this._node=e.node,this._proj=e.projection,this._priority=e.priority||0,this._aspect=this.screenScale=1;var t=this._poolHandle=u.alloc();u.set(t,c.WIDTH,1),u.set(t,c.HEIGHT,1),u.set(t,c.CLEAR_FLAG,_.NONE),u.set(t,c.CLEAR_DEPTH,1),u.set(t,c.NODE,this._node.handle),u.set(t,c.VISIBILITY,l),this._scene&&u.set(t,c.SCENE,this._scene.handle),this.updateExposure(),this.changeTargetWindow(e.window),console.log("Created Camera: "+this._name+" "+u.get(t,c.WIDTH)+"x"+u.get(t,c.HEIGHT))},i.destroy=function(){this._window&&this._window.detachCamera(this),this._name=null,this._poolHandle&&(u.free(this._poolHandle),this._poolHandle=n,this._frustumHandle&&(d.free(this._frustumHandle),this._frustumHandle=n))},i.attachToScene=function(e){this._scene=e,this._enabled=!0,u.set(this._poolHandle,c.SCENE,e.handle)},i.detachFromScene=function(){this._scene=null,this._enabled=!1,u.set(this._poolHandle,c.SCENE,0)},i.resize=function(e,t){var i=this._poolHandle;u.set(i,c.WIDTH,e),u.set(i,c.HEIGHT,t),this._aspect=e*this._viewport.width/(t*this._viewport.height),this._isProjDirty=!0},i.setFixedSize=function(e,t){var i=this._poolHandle;u.set(i,c.WIDTH,e),u.set(i,c.HEIGHT,t),this._aspect=e*this._viewport.width/(t*this._viewport.height),this.isWindowSize=!1},i.update=function(e){if(void 0===e&&(e=!1),this._node){var t=!1;(this._node.hasChangedFlags||e)&&(a.invert(this._matView,this._node.worldMatrix),u.setMat4(this._poolHandle,c.MAT_VIEW,this._matView),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),u.setVec3(this._poolHandle,c.POSITION,this._position),u.setVec3(this._poolHandle,c.FORWARD,this._forward),t=!0);var i=this._device.surfaceTransform;if(this._isProjDirty||this._curTransform!==i){this._curTransform=i;var n=this._device.screenSpaceSignY;if(this._window&&this._window.hasOffScreenAttachments&&(n*=this._device.UVSpaceSignY,i=f.IDENTITY),this._proj===re.PERSPECTIVE)a.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===se.VERTICAL,this._device.clipSpaceMinZ,n,i);else{var s=this._orthoHeight*this._aspect,r=this._orthoHeight;a.ortho(this._matProj,-s,s,-r,r,this._nearClip,this._farClip,this._device.clipSpaceMinZ,n,i)}a.invert(this._matProjInv,this._matProj),u.setMat4(this._poolHandle,c.MAT_PROJ,this._matProj),u.setMat4(this._poolHandle,c.MAT_PROJ_INV,this._matProjInv),t=!0,this._isProjDirty=!1}t&&(a.multiply(this._matViewProj,this._matProj,this._matView),a.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv),u.setMat4(this._poolHandle,c.MAT_VIEW_PROJ,this._matViewProj),u.setMat4(this._poolHandle,c.MAT_VIEW_PROJ_INV,this._matViewProjInv),ee(this._frustumHandle,this._frustum))}},i.changeTargetWindow=function(e){void 0===e&&(e=null),this._window&&this._window.detachCamera(this);var t=e||h.director.root.mainWindow;t&&(t.attachCamera(this),this.resize(t.width,t.height),this._window=t,u.set(this._poolHandle,c.WINDOW,t.handle))},i.detachCamera=function(){this._window&&this._window.detachCamera(this)},i.screenPointToRay=function(e,t,i){if(!this._node)return null;var n=this._poolHandle,s=u.get(n,c.WIDTH),o=u.get(n,c.HEIGHT),h=this._viewport.x*s,a=this._viewport.y*o,_=this._viewport.width*s,l=this._viewport.height*o,d=this._proj===re.PERSPECTIVE,f=this._device.screenSpaceSignY,v=p[this._curTransform];r.set(ve,(t-h)/_*2-1,(i-a)/l*2-1,d?1:-1);var g=ve.x,E=ve.y;return ve.x=g*v[0]+E*v[2]*f,ve.y=g*v[1]+E*v[3]*f,r.transformMat4(d?ve:e.o,ve,this._matViewProjInv),d?(this._node.getWorldPosition(ge),te.fromPoints(e,ge,ve)):r.transformQuat(e.d,r.FORWARD,this._node.worldRotation),e},i.screenToWorld=function(e,t){var i=this._poolHandle,n=u.get(i,c.WIDTH),s=u.get(i,c.HEIGHT),o=this._viewport.x*n,h=this._viewport.y*s,a=this._viewport.width*n,_=this._viewport.height*s,l=this._device.screenSpaceSignY,d=p[this._curTransform];if(this._proj===re.PERSPECTIVE){r.set(e,(t.x-o)/a*2-1,(t.y-h)/_*2-1,1);var f=e.x,g=e.y;e.x=f*d[0]+g*d[2]*l,e.y=f*d[1]+g*d[3]*l,r.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(ve),r.lerp(e,ve,e,v(this._nearClip/this._farClip,1,t.z))}else{r.set(e,(t.x-o)/a*2-1,(t.y-h)/_*2-1,2*t.z-1);var E=e.x,y=e.y;e.x=E*d[0]+y*d[2]*l,e.y=E*d[1]+y*d[3]*l,r.transformMat4(e,e,this._matViewProjInv)}return e},i.worldToScreen=function(e,t){var i=this._poolHandle,n=u.get(i,c.WIDTH),s=u.get(i,c.HEIGHT),o=this._viewport.x*n,h=this._viewport.y*s,a=this._viewport.width*n,_=this._viewport.height*s,l=this._device.screenSpaceSignY,d=p[this._curTransform];r.transformMat4(e,t,this._matViewProj);var f=e.x,v=e.y;return e.x=f*d[0]+v*d[2]*l,e.y=f*d[1]+v*d[3]*l,e.x=o+.5*(e.x+1)*a,e.y=h+.5*(e.y+1)*_,e.z=.5*e.z+.5,e},i.worldMatrixToScreen=function(e,t,i,n){a.multiply(e,this._matViewProj,t),a.multiply(e,ye[this._curTransform],e);var s=i/2,o=n/2;return a.identity(Ee),a.transform(Ee,Ee,r.set(ve,s,o,0)),a.scale(Ee,Ee,r.set(ve,s,o,1)),a.multiply(e,Ee,e),e},i.updateExposure=function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);u.set(this._poolHandle,c.EXPOSURE,.833333/Math.pow(2,e))},t(e,[{key:"node",set:function(e){this._node=e},get:function(){return this._node}},{key:"enabled",set:function(e){this._enabled=e},get:function(){return this._enabled}},{key:"orthoHeight",set:function(e){this._orthoHeight=e,this._isProjDirty=!0},get:function(){return this._orthoHeight}},{key:"projectionType",set:function(e){this._proj=e,this._isProjDirty=!0},get:function(){return this._proj}},{key:"fovAxis",set:function(e){this._fovAxis=e,this._isProjDirty=!0},get:function(){return this._fovAxis}},{key:"fov",set:function(e){this._fov=e,this._isProjDirty=!0},get:function(){return this._fov}},{key:"nearClip",set:function(e){this._nearClip=e,this._isProjDirty=!0},get:function(){return this._nearClip}},{key:"farClip",set:function(e){this._farClip=e,this._isProjDirty=!0},get:function(){return this._farClip}},{key:"clearColor",set:function(e){this._clearColor.x=e.x,this._clearColor.y=e.y,this._clearColor.z=e.z,this._clearColor.w=e.w,u.setVec4(this._poolHandle,c.CLEAR_COLOR,e)},get:function(){return this._clearColor}},{key:"viewport",get:function(){return this._viewport},set:function(e){var t=e.x,i=e.width,n=e.height,s=this._device.screenSpaceSignY<0?1-e.y-n:e.y;switch(this._device.surfaceTransform){case f.ROTATE_90:this._viewport.x=1-s-n,this._viewport.y=t,this._viewport.width=n,this._viewport.height=i;break;case f.ROTATE_180:this._viewport.x=1-t-i,this._viewport.y=1-s-n,this._viewport.width=i,this._viewport.height=n;break;case f.ROTATE_270:this._viewport.x=s,this._viewport.y=1-t-i,this._viewport.width=n,this._viewport.height=i;break;case f.IDENTITY:this._viewport.x=t,this._viewport.y=s,this._viewport.width=i,this._viewport.height=n}u.setVec4(this._poolHandle,c.VIEW_PORT,this._viewport),this.resize(this.width,this.height)}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return u.get(this._poolHandle,c.WIDTH)}},{key:"height",get:function(){return u.get(this._poolHandle,c.HEIGHT)}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",set:function(e){this._matView=e,u.setMat4(this._poolHandle,c.MAT_VIEW,this._matView)},get:function(){return this._matView}},{key:"matViewInv",set:function(e){this._matViewInv=e},get:function(){return this._matViewInv||this._node.worldMatrix}},{key:"matProj",set:function(e){this._matProj=e,u.setMat4(this._poolHandle,c.MAT_PROJ,this._matProj)},get:function(){return this._matProj}},{key:"matProjInv",set:function(e){this._matProjInv=e,u.setMat4(this._poolHandle,c.MAT_PROJ_INV,this._matProjInv)},get:function(){return this._matProjInv}},{key:"matViewProj",set:function(e){this._matViewProj=e,u.setMat4(this._poolHandle,c.MAT_VIEW_PROJ,this._matViewProj)},get:function(){return this._matViewProj}},{key:"matViewProjInv",set:function(e){this._matViewProjInv=e,u.setMat4(this._poolHandle,c.MAT_VIEW_PROJ_INV,this._matViewProjInv)},get:function(){return this._matViewProjInv}},{key:"frustum",set:function(e){this._frustum=e,ee(this._frustumHandle,e)},get:function(){return this._frustum}},{key:"window",set:function(e){this._window=e,e&&u.set(this._poolHandle,c.WINDOW,e.handle)},get:function(){return this._window}},{key:"forward",set:function(e){this._forward=e,u.setVec3(this._poolHandle,c.FORWARD,this._forward)},get:function(){return this._forward}},{key:"position",set:function(e){this._position=e,u.setVec3(this._poolHandle,c.POSITION,this._position)},get:function(){return this._position}},{key:"visibility",set:function(e){u.set(this._poolHandle,c.VISIBILITY,e)},get:function(){return u.get(this._poolHandle,c.VISIBILITY)}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"aperture",set:function(e){this._aperture=e,this._apertureValue=de[this._aperture],this.updateExposure()},get:function(){return this._aperture}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",set:function(e){this._shutter=e,this._shutterValue=fe[this._shutter],this.updateExposure()},get:function(){return this._shutter}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",set:function(e){this._iso=e,this._isoValue=pe[this._iso],this.updateExposure()},get:function(){return this._iso}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",set:function(e){this._ec=e},get:function(){return this._ec}},{key:"exposure",get:function(){return u.get(this._poolHandle,c.EXPOSURE)}},{key:"clearFlag",get:function(){return u.get(this._poolHandle,c.CLEAR_FLAG)},set:function(e){u.set(this._poolHandle,c.CLEAR_FLAG,e)}},{key:"clearDepth",get:function(){return u.get(this._poolHandle,c.CLEAR_DEPTH)},set:function(e){u.set(this._poolHandle,c.CLEAR_DEPTH,e)}},{key:"clearStencil",get:function(){return u.get(this._poolHandle,c.CLEAR_STENCIL)},set:function(e){u.set(this._poolHandle,c.CLEAR_STENCIL,e)}},{key:"handle",get:function(){return this._poolHandle}}]),e}()),function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD"}(ue||(ue=e("N",{}))),function(e){e[e.NONE=0]="NONE",e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.RS=e.ROTATION|e.SCALE]="RS",e[e.TRS=e.POSITION|e.ROTATION|e.SCALE]="TRS",e[e.TRS_MASK=~e.TRS]="TRS_MASK"}(ce||(ce=e("T",{}))),h.internal.TransformBit=ce,function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.UNKNOWN=3]="UNKNOWN"}(le||(le=e("L",{}))),e("n",(function(e){return 4*Math.PI*Math.PI*e*e})),e("g",function(){function e(){this._baked=!1,this._color=new r(1,1,1),this._colorTemp=6550,this._colorTempRGB=new r(1,1,1),this._scene=null,this._node=null,this._name=null,this._handle=n}var i=e.prototype;return i.initialize=function(){this._handle=T.alloc(),T.setVec3(this._handle,L.COLOR,this._color),T.setVec3(this._handle,L.COLOR_TEMPERATURE_RGB,this._colorTempRGB),T.set(this._handle,L.TYPE,le.UNKNOWN)},i.attachToScene=function(e){this._scene=e},i.detachFromScene=function(){this._scene=null},i.destroy=function(){this._name=null,this._node=null,this._handle&&(T.free(this._handle),this._handle=n)},i.update=function(){},t(e,[{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"color",set:function(e){this._color.set(e),T.setVec3(this._handle,L.COLOR,e)},get:function(){return this._color}},{key:"useColorTemperature",set:function(e){T.set(this._handle,L.USE_COLOR_TEMPERATURE,e?1:0)},get:function(){return 1===T.get(this._handle,L.USE_COLOR_TEMPERATURE)}},{key:"colorTemperature",set:function(e){this._colorTemp=e,Te(this._colorTempRGB,this._colorTemp),T.setVec3(this._handle,L.COLOR_TEMPERATURE_RGB,this._colorTempRGB)},get:function(){return this._colorTemp}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",set:function(e){this._node=e,this._node&&(this._node.hasChangedFlags|=ce.ROTATION,T.set(this._handle,L.NODE,this._node.handle))},get:function(){return this._node}},{key:"type",get:function(){return T.get(this._handle,L.TYPE)}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"scene",get:function(){return this._scene}},{key:"handle",get:function(){return this._handle}}]),e}()),e("I",function(){function e(e){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=e.device,this.pass=e}e.get=function(t,i){void 0===i&&(i=0);var n=e._buffers;n.has(t)||n.set(t,{});var s=n.get(t);return s[i]||(s[i]=new e(t))};var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.vb.destroy(),t.ia.destroy()}this.instances.length=0},t.merge=function(e,t,i){var n=t.buffer.length;if(n){for(var s=e.inputAssembler,r=e.descriptorSet.getTexture(m),o=S.get(e.handle,A.SHADER_0+i),h=S.get(e.handle,A.DESCRIPTOR_SET),a=0;a<this.instances.length;++a){var _=this.instances[a];if(!(_.ia.indexBuffer!==s.indexBuffer||_.count>=1024)&&_.lightingMap===r){if(_.stride!==n)return;if(_.count>=_.capacity){_.capacity<<=1;var u=_.stride*_.capacity,c=_.data;_.data=new Uint8Array(u),_.data.set(c),_.vb.resize(u)}return _.hShader!==o&&(_.hShader=o),_.hDescriptorSet!==h&&(_.hDescriptorSet=h),_.data.set(t.buffer,_.stride*_.count++),void(this.hasPendingModels=!0)}}for(var l=this._device.createBuffer(new O(w.VERTEX|w.TRANSFER_DST,C.HOST|C.DEVICE,32*n,n)),d=new Uint8Array(32*n),f=s.vertexBuffers.slice(),p=s.attributes.slice(),v=s.indexBuffer,g=0;g<t.attributes.length;g++){var E=t.attributes[g],y=new I(E.name,E.format,E.isNormalized,f.length,!0);p.push(y)}d.set(t.buffer),f.push(l);var T=new P(p,f,v),L=this._device.createInputAssembler(T);this.instances.push({count:1,capacity:32,vb:l,data:d,ia:L,stride:n,hShader:o,hDescriptorSet:h,lightingMap:r}),this.hasPendingModels=!0}},t.uploadBuffers=function(e){for(var t=0;t<this.instances.length;++t){var i=this.instances[t];i.count&&(i.ia.instanceCount=i.count,e.updateBuffer(i.vb,i.data))}},t.clear=function(){for(var e=0;e<this.instances.length;++e)this.instances[e].count=0;this.hasPendingModels=!1},e}())._buffers=new Map;var Le=e("h",D({Planar:0,ShadowMap:1})),me=(e("P",D({HARD:0,FILTER_X5:1,FILTER_X9:2,FILTER_X25:3})),Le.ShadowMap+1),Se=e("i",function(){function e(){this.sphere=new ne(0,0,0,.01),this.maxReceived=4,this._normal=new r(0,1,0),this._shadowColor=new i(0,0,0,76),this._matLight=new a,this._material=null,this._instancingMaterial=null,this._size=new R(512,512),this._handle=n,this._handle=N.alloc()}t(e,[{key:"enabled",get:function(){return!!N.get(this._handle,b.ENABLE)},set:function(e){N.set(this._handle,b.ENABLE,e?1:0),e||N.set(this._handle,b.TYPE,me),this.activate()}},{key:"normal",get:function(){return this._normal},set:function(e){r.copy(this._normal,e),N.setVec3(this._handle,b.NORMAL,this._normal)}},{key:"distance",get:function(){return N.get(this._handle,b.DISTANCE)},set:function(e){N.set(this._handle,b.DISTANCE,e)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor=e,N.setVec4(this._handle,b.COLOR,e)}},{key:"type",get:function(){return N.get(this._handle,b.TYPE)},set:function(e){N.set(this._handle,b.TYPE,this.enabled?e:me),this.activate()}},{key:"near",get:function(){return N.get(this._handle,b.NEAR)},set:function(e){N.set(this._handle,b.NEAR,e)}},{key:"far",get:function(){return N.get(this._handle,b.FAR)},set:function(e){N.set(this._handle,b.FAR,e)}},{key:"aspect",get:function(){return N.get(this._handle,b.ASPECT)},set:function(e){N.set(this._handle,b.ASPECT,e)}},{key:"orthoSize",get:function(){return N.get(this._handle,b.ORTHO_SIZE)},set:function(e){N.set(this._handle,b.ORTHO_SIZE,e)}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,N.setVec2(this._handle,b.SIZE,this._size)}},{key:"pcf",get:function(){return N.get(this._handle,b.PCF_TYPE)},set:function(e){N.set(this._handle,b.PCF_TYPE,e)}},{key:"shadowMapDirty",get:function(){return!!N.get(this._handle,b.SHADOW_MAP_DIRTY)},set:function(e){N.set(this._handle,b.SHADOW_MAP_DIRTY,e?1:0)}},{key:"bias",get:function(){return N.get(this._handle,b.BIAS)},set:function(e){N.set(this._handle,b.BIAS,e)}},{key:"autoAdapt",get:function(){return!!N.get(this._handle,b.AUTO_ADAPT)},set:function(e){N.set(this._handle,b.AUTO_ADAPT,e?1:0)}},{key:"matLight",get:function(){return this._matLight}},{key:"material",get:function(){return this._material}},{key:"instancingMaterial",get:function(){return this._instancingMaterial}},{key:"handle",get:function(){return this._handle}}]);var s=e.prototype;return s.getPlanarShader=function(e){return this._material||(this._material=new M,this._material.initialize({effectName:"planar-shadow"}),N.set(this._handle,b.PLANAR_PASS,this._material.passes[0].handle)),this._material.passes[0].getShaderVariant(e)},s.initialize=function(e){N.set(this._handle,b.TYPE,e.enabled?e.type:me),N.set(this._handle,b.NEAR,e.near),N.set(this._handle,b.FAR,e.far),N.set(this._handle,b.ASPECT,e.aspect),N.set(this._handle,b.ORTHO_SIZE,e.orthoSize),this._size=e.shadowMapSize,N.setVec2(this._handle,b.SIZE,this._size),N.set(this._handle,b.PCF_TYPE,e.pcf),r.copy(this._normal,e.normal),N.setVec3(this._handle,b.NORMAL,this._normal),N.set(this._handle,b.DISTANCE,e.distance),this._shadowColor.set(e.shadowColor),N.setVec4(this._handle,b.COLOR,this._shadowColor),N.set(this._handle,b.BIAS,e.bias),N.set(this._handle,b.ENABLE,e.enabled?1:0),this.maxReceived=e.maxReceived,N.set(this._handle,b.AUTO_ADAPT,e.autoAdapt?1:0)},s.activate=function(){if(this.enabled)this.type===Le.ShadowMap?this._updatePipeline():this._updatePlanarInfo();else{var e=h.director.root;e.pipeline.macros.CC_RECEIVE_SHADOW=0,e.onGlobalPipelineStateChanged()}},s._updatePlanarInfo=function(){this._material||(this._material=new M,this._material.initialize({effectName:"planar-shadow"}),N.set(this._handle,b.PLANAR_PASS,this._material.passes[0].handle)),this._instancingMaterial||(this._instancingMaterial=new M,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}),N.set(this._handle,b.INSTANCE_PASS,this._instancingMaterial.passes[0].handle));var e=h.director.root;e.pipeline.macros.CC_RECEIVE_SHADOW=0,e.onGlobalPipelineStateChanged()},s._updatePipeline=function(){var e=h.director.root;e.pipeline.macros.CC_RECEIVE_SHADOW=1,e.onGlobalPipelineStateChanged()},s.destroy=function(){this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this._handle&&(N.free(this._handle),this._handle=n),this.sphere.destroy()},e}());Se.MAX_FAR=2e3,Se.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),h.Shadows=Se;var Ae=e("k",function(e){function i(t,i){var n;(n=e.call(this,t.root)||this)._parent=void 0,n._owner=void 0,n._dontNotify=!1,n._parent=t,n._owner=i,n._doInit(n._parent,!0);for(var s=0;s<n._shaderInfo.blocks.length;s++){var r=n._shaderInfo.blocks[s],o=n._blocks[r.binding],h=n._parent.blocks[r.binding];o.set(h)}n._rootBufferDirty=!0;for(var a=n._parent,_=0;_<n._shaderInfo.samplers.length;_++)for(var u=n._shaderInfo.samplers[_],c=0;c<u.count;c++){var l=a._descriptorSet.getSampler(u.binding,c),d=a._descriptorSet.getTexture(u.binding,c);n._descriptorSet.bindSampler(u.binding,l,c),n._descriptorSet.bindTexture(u.binding,d,c)}return e.prototype.tryCompile.call(k(n)),n}H(i,e),t(i,[{key:"parent",get:function(){return this._parent}}]);var n=i.prototype;return n.overridePipelineStates=function(e,t){this._bs.reset(),this._rs.reset(),this._dss.reset(),U.fillPipelineInfo(this,e),U.fillPipelineInfo(this,t),this._onStateChange()},n.tryCompile=function(t){if(t&&!F(this._defines,t))return!1;var i=e.prototype.tryCompile.call(this);return this._onStateChange(),i},n.beginChangeStatesSilently=function(){this._dontNotify=!0},n.endChangeStatesSilently=function(){this._dontNotify=!1},n._syncBatchingScheme=function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,V.set(this._handle,x.BATCHING_SCHEME,0)},n._onStateChange=function(){V.set(this._handle,x.HASH,U.getPassHash(this,this._hShaderDefault)),this._owner.onPassStateChange(this._dontNotify)},i}(U)),Oe=e("M",function(e){function i(t){var i;return(i=e.call(this)||this)._passes=[],i._parent=void 0,i._owner=void 0,i._subModelIdx=0,i._parent=t.parent,i._owner=t.owner||null,i._subModelIdx=t.subModelIdx||0,i.copy(i._parent),i}H(i,e),t(i,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]);var n=i.prototype;return n.recompileShaders=function(e,t){if(this._passes&&this.effectAsset)if(void 0===t)for(var i,n=B(this._passes);!(i=n()).done;)i.value.tryCompile(e);else this._passes[t].tryCompile(e)},n.overridePipelineStates=function(e,t){if(this._passes&&this.effectAsset){var i=this.effectAsset.techniques[this.technique].passes;if(void 0===t)for(var n=0;n<this._passes.length;n++){var s=this._passes[n],r=this._states[n]||(this._states[n]={});for(var o in e)r[o]=e[o];s.overridePipelineStates(i[s.passIndex],r)}else{var h=this._states[t]||(this._states[t]={});for(var a in e)h[a]=e[a];this._passes[t].overridePipelineStates(i[t],h)}}},n.destroy=function(){return this._doDestroy(),!0},n.onPassStateChange=function(e){this._hash=M.getHash(this),!e&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)},n._createPasses=function(){var e=[],t=this._parent.passes;if(!t)return e;for(var i=0;i<t.length;++i)e.push(new Ae(t[i],this));return e},i}(M)),we=null,Ce=null,Ie=e("j",function(){function e(){this._envmap=null,this._globalDescriptorSet=null,this._model=null,this._default=null,this._handle=n,this._handle=G.alloc()}t(e,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return G.get(this._handle,j.ENABLE)},set:function(e){e?this.activate():this._updatePipeline(),G.set(this._handle,j.ENABLE,e?1:0)}},{key:"useIBL",get:function(){return G.get(this._handle,j.USE_IBL)},set:function(e){G.set(this._handle,j.USE_IBL,e?1:0),this._updatePipeline()}},{key:"isRGBE",get:function(){return G.get(this._handle,j.IS_RGBE)},set:function(e){e&&(Ce&&Ce.recompileShaders({USE_RGBE_CUBEMAP:e}),this._model&&this._model.setSubModelMaterial(0,Ce)),G.set(this._handle,j.IS_RGBE,e?1:0),this._updatePipeline()}},{key:"envmap",get:function(){return this._envmap},set:function(e){this._envmap=e||this._default,this._envmap&&(h.director.root.pipeline.ambient.albedoArray[3]=this._envmap.mipmapLevel,this._updateGlobalBinding())}},{key:"handle",get:function(){return this._handle}}]);var i=e.prototype;return i.initialize=function(e){G.set(this._handle,j.ENABLE,e.enabled?1:0),G.set(this._handle,j.USE_IBL,e.useIBL?1:0),G.set(this._handle,j.IS_RGBE,e.isRGBE?1:0),this._envmap=e.envmap},i.activate=function(){var e=h.director.root.pipeline;if(this._globalDescriptorSet=e.descriptorSet,this._default=Y.get("default-cube-texture"),this._model||(this._model=h.director.root.createModel(h.renderer.scene.Model),this._model._initLocalDescriptors=function(){}),G.set(this._handle,j.MODEL,this._model.handle),this._envmap||(this._envmap=this._default),e.ambient.groundAlbedo[3]=this._envmap.mipmapLevel,Ce)Ce.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE});else{var t=new M;t.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:this.isRGBE}}),Ce=new Oe({parent:t})}this.enabled&&(we||(we=h.utils.createMesh(h.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,we.renderingSubMeshes[0],Ce)),this._updateGlobalBinding(),this._updatePipeline()},i._updatePipeline=function(){var e=this.useIBL?this.isRGBE?2:1:0,t=h.director.root,i=t.pipeline;i.macros.CC_USE_IBL!==e&&(i.macros.CC_USE_IBL=e,t.onGlobalPipelineStateChanged())},i._updateGlobalBinding=function(){var e=this.envmap.getGFXTexture(),t=W.getSampler(h.director._device,this.envmap.getSamplerHash());this._globalDescriptorSet.bindSampler(z,t),this._globalDescriptorSet.bindTexture(z,e)},i.destroy=function(){this._handle&&(G.free(this._handle),this._handle=n)},e}());h.Skybox=Ie;var Pe=new R,De=e("E",function(e){function t(i,n,s){var r;return(r=e.call(this,K.MOUSE,n)||this).movementX=0,r.movementY=0,r.eventType=void 0,r._button=t.BUTTON_MISSING,r._x=0,r._y=0,r._prevX=0,r._prevY=0,r._scrollX=0,r._scrollY=0,r.eventType=i,s&&(r._prevX=s.x,r._prevY=s.y),r}H(t,e);var i=t.prototype;return i.setScrollData=function(e,t){this._scrollX=e,this._scrollY=t},i.getScrollX=function(){return this._scrollX},i.getScrollY=function(){return this._scrollY},i.setLocation=function(e,t){this._x=e,this._y=t},i.getLocation=function(e){return e||(e=new R),R.set(e,this._x,this._y),e},i.getLocationInView=function(e){return e||(e=new R),R.set(e,this._x,h.view._designResolutionSize.height-this._y),e},i.getUILocation=function(e){return e||(e=new R),R.set(e,this._x,this._y),h.view._convertPointWithScale(e),e},i.getPreviousLocation=function(e){return e||(e=new R),R.set(e,this._prevX,this._prevY),e},i.getUIPreviousLocation=function(e){return e||(e=new R),R.set(e,this._prevX,this._prevY),h.view._convertPointWithScale(e),e},i.getDelta=function(e){return e||(e=new R),R.set(e,this._x-this._prevX,this._y-this._prevY),e},i.getDeltaX=function(){return this._x-this._prevX},i.getDeltaY=function(){return this._y-this._prevY},i.getUIDelta=function(e){return e||(e=new R),R.set(e,(this._x-this._prevX)/h.view.getScaleX(),(this._y-this._prevY)/h.view.getScaleY()),e},i.getUIDeltaX=function(){return(this._x-this._prevX)/h.view.getScaleX()},i.getUIDeltaY=function(){return(this._y-this._prevY)/h.view.getScaleY()},i.setButton=function(e){this._button=e},i.getButton=function(){return this._button},i.getLocationX=function(){return this._x},i.getLocationY=function(){return this._y},i.getUILocationX=function(){var e=h.view.getViewportRect();return(this._x-e.x)/h.view.getScaleX()},i.getUILocationY=function(){var e=h.view.getViewportRect();return(this._y-e.y)/h.view.getScaleY()},t}(K));De.NONE=0,De.DOWN=1,De.UP=2,De.MOVE=3,De.SCROLL=4,De.BUTTON_MISSING=-1,De.BUTTON_LEFT=0,De.BUTTON_RIGHT=2,De.BUTTON_MIDDLE=1,De.BUTTON_4=3,De.BUTTON_5=4,De.BUTTON_6=5,De.BUTTON_7=6,De.BUTTON_8=7;var Re=e("m",function(e){function t(t,i,n,s){var r;return(r=e.call(this,K.TOUCH,i)||this).touch=null,r.simulate=!1,r._eventCode=void 0,r._touches=void 0,r._allTouches=void 0,r._eventCode=n||0,r._touches=t||[],r._allTouches=s||[],r}H(t,e);var i=t.prototype;return i.getEventCode=function(){return this._eventCode},i.getTouches=function(){return this._touches},i.getAllTouches=function(){return this._allTouches},i.setLocation=function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)},i.getLocation=function(e){return this.touch?this.touch.getLocation(e):new R},i.getUILocation=function(e){return this.touch?this.touch.getUILocation(e):new R},i.getLocationInView=function(e){return this.touch?this.touch.getLocationInView(e):new R},i.getPreviousLocation=function(e){return this.touch?this.touch.getPreviousLocation(e):new R},i.getStartLocation=function(e){return this.touch?this.touch.getStartLocation(e):new R},i.getUIStartLocation=function(e){return this.touch?this.touch.getUIStartLocation(e):new R},i.getID=function(){return this.touch?this.touch.getID():null},i.getDelta=function(e){return this.touch?this.touch.getDelta(e):new R},i.getUIDelta=function(e){return this.touch?this.touch.getUIDelta(e):new R},i.getDeltaX=function(){return this.touch?this.touch.getDelta(Pe).x:0},i.getDeltaY=function(){return this.touch?this.touch.getDelta(Pe).y:0},i.getLocationX=function(){return this.touch?this.touch.getLocationX():0},i.getLocationY=function(){return this.touch?this.touch.getLocationY():0},t}(K));Re.MAX_TOUCHES=5,Re.BEGAN=0,Re.MOVED=1,Re.ENDED=2,Re.CANCELLED=3;var Ne=e("o",function(e){function t(t,i){var n;return(n=e.call(this,K.ACCELERATION,i)||this).acc=void 0,n.acc=t,n}return H(t,e),t}(K)),Me=e("p",function(e){function t(t,i,n){var s;return(s=e.call(this,K.KEYBOARD,n)||this).keyCode=void 0,s.rawEvent=void 0,s.isPressed=void 0,"number"==typeof t?s.keyCode=t:(s.keyCode=t.keyCode,s.rawEvent=t),s.isPressed=i,s}return H(t,e),t}(K));K.EventMouse=De,K.EventTouch=Re,K.EventAcceleration=Ne,K.EventKeyboard=Me;var be=e("r",function(){function e(e,t,i){this._cameraPriority=0,this.owner=null,this.mask=null,this._previousIn=!1,this._target=null,this._onEvent=void 0,this._type=void 0,this._listenerID=void 0,this._registered=!1,this._fixedPriority=0,this._node=null,this._paused=!0,this._isEnabled=!0,this._onEvent=i,this._type=e||0,this._listenerID=t||""}e.create=function(e){Z(e&&e.event,1900);var t=e.event;delete e.event;var i=null;if(t===h.EventListener.TOUCH_ONE_BY_ONE?i=new Ue:t===h.EventListener.TOUCH_ALL_AT_ONCE?i=new Fe:t===h.EventListener.MOUSE?i=new ke:t===h.EventListener.KEYBOARD?i=new xe:t===h.EventListener.ACCELERATION&&(i=new Ve(e.callback),delete e.callback),i)for(var n=0,s=Object.keys(e);n<s.length;n++){var r=s[n];i[r]=e[r]}return i},t(e,[{key:"onEvent",get:function(){return this._onEvent}}]);var i=e.prototype;return i._setPaused=function(e){this._paused=e},i._isPaused=function(){return this._paused},i._setRegistered=function(e){this._registered=e},i._isRegistered=function(){return this._registered},i._getType=function(){return this._type},i._getListenerID=function(){return this._listenerID},i._setFixedPriority=function(e){this._fixedPriority=e},i._getFixedPriority=function(){return this._fixedPriority},i._setSceneGraphPriority=function(e){this._target=e,this._node=e},i._getSceneGraphPriority=function(){return this._node},i.checkAvailable=function(){return null!==this._onEvent},i.clone=function(){return null},i.setEnabled=function(e){this._isEnabled=e},i.isEnabled=function(){return this._isEnabled},e}());be.UNKNOWN=0,be.TOUCH_ONE_BY_ONE=1,be.TOUCH_ALL_AT_ONCE=2,be.KEYBOARD=3,be.MOUSE=4,be.ACCELERATION=6,be.CUSTOM=8,be.ListenerID={MOUSE:"__cc_mouse",TOUCH_ONE_BY_ONE:"__cc_touch_one_by_one",TOUCH_ALL_AT_ONCE:"__cc_touch_all_at_once",KEYBOARD:"__cc_keyboard",ACCELERATION:"__cc_acceleration"};var He=be.ListenerID,ke=function(e){function t(){var t;return(t=e.call(this,be.MOUSE,He.MOUSE,null)||this).onMouseDown=null,t.onMouseUp=null,t.onMouseMove=null,t.onMouseScroll=null,t._onEvent=function(e){return t._callback(e)},t}H(t,e);var i=t.prototype;return i._callback=function(e){var t=h.Event.EventMouse;switch(e.eventType){case t.DOWN:this.onMouseDown&&this.onMouseDown(e);break;case t.UP:this.onMouseUp&&this.onMouseUp(e);break;case t.MOVE:this.onMouseMove&&this.onMouseMove(e);break;case t.SCROLL:this.onMouseScroll&&this.onMouseScroll(e)}},i.clone=function(){var e=new t;return e.onMouseDown=this.onMouseDown,e.onMouseUp=this.onMouseUp,e.onMouseMove=this.onMouseMove,e.onMouseScroll=this.onMouseScroll,e},i.checkAvailable=function(){return!0},t}(be),Ue=function(e){function t(){var t;return(t=e.call(this,be.TOUCH_ONE_BY_ONE,He.TOUCH_ONE_BY_ONE,null)||this).swallowTouches=!1,t.onTouchBegan=null,t.onTouchMoved=null,t.onTouchEnded=null,t.onTouchCancelled=null,t._claimedTouches=[],t}H(t,e);var i=t.prototype;return i.setSwallowTouches=function(e){this.swallowTouches=e},i.isSwallowTouches=function(){return this.swallowTouches},i.clone=function(){var e=new t;return e.onTouchBegan=this.onTouchBegan,e.onTouchMoved=this.onTouchMoved,e.onTouchEnded=this.onTouchEnded,e.onTouchCancelled=this.onTouchCancelled,e.swallowTouches=this.swallowTouches,e},i.checkAvailable=function(){return!!this.onTouchBegan||(X(1801),!1)},t}(be),Fe=function(e){function t(){var t;return(t=e.call(this,be.TOUCH_ALL_AT_ONCE,He.TOUCH_ALL_AT_ONCE,null)||this).onTouchesBegan=null,t.onTouchesMoved=null,t.onTouchesEnded=null,t.onTouchesCancelled=null,t}H(t,e);var i=t.prototype;return i.clone=function(){var e=new t;return e.onTouchesBegan=this.onTouchesBegan,e.onTouchesMoved=this.onTouchesMoved,e.onTouchesEnded=this.onTouchesEnded,e.onTouchesCancelled=this.onTouchesCancelled,e},i.checkAvailable=function(){return null!==this.onTouchesBegan||null!==this.onTouchesMoved||null!==this.onTouchesEnded||null!==this.onTouchesCancelled||(X(1802),!1)},t}(be),Ve=function(e){function t(t){var i;return(i=e.call(this,be.ACCELERATION,He.ACCELERATION,null)||this)._onAccelerationEvent=null,i._onEvent=function(e){return i._callback(e)},i._onAccelerationEvent=t,i}H(t,e);var i=t.prototype;return i._callback=function(e){this._onAccelerationEvent&&this._onAccelerationEvent(e.acc,e)},i.checkAvailable=function(){return Z(this._onAccelerationEvent,1803),!0},i.clone=function(){return new t(this._onAccelerationEvent)},t}(be),xe=function(e){function t(){var t;return(t=e.call(this,be.KEYBOARD,He.KEYBOARD,null)||this).onKeyPressed=null,t.onKeyReleased=null,t._onEvent=function(e){return t._callback(e)},t}H(t,e);var i=t.prototype;return i._callback=function(e){e.isPressed?this.onKeyPressed&&this.onKeyPressed(e.keyCode,e):this.onKeyReleased&&this.onKeyReleased(e.keyCode,e)},i.clone=function(){var e=new t;return e.onKeyPressed=this.onKeyPressed,e.onKeyReleased=this.onKeyReleased,e},i.checkAvailable=function(){return null!==this.onKeyPressed||null!==this.onKeyReleased||(X(1800),!1)},t}(be);h.EventListener=be;var Be,Ge=be.ListenerID,je=function(){function e(){this.gt0Index=0,this._fixedListeners=[],this._sceneGraphListeners=[]}var t=e.prototype;return t.size=function(){return this._fixedListeners.length+this._sceneGraphListeners.length},t.empty=function(){return 0===this._fixedListeners.length&&0===this._sceneGraphListeners.length},t.push=function(e){0===e._getFixedPriority()?this._sceneGraphListeners.push(e):this._fixedListeners.push(e)},t.clearSceneGraphListeners=function(){this._sceneGraphListeners.length=0},t.clearFixedListeners=function(){this._fixedListeners.length=0},t.clear=function(){this._sceneGraphListeners.length=0,this._fixedListeners.length=0},t.getFixedPriorityListeners=function(){return this._fixedListeners},t.getSceneGraphPriorityListeners=function(){return this._sceneGraphListeners},e}(),Ye=function(){function e(){this._listenersMap={},this._priorityDirtyFlagMap={},this._nodeListenersMap={},this._toAddedListeners=[],this._toRemovedListeners=[],this._dirtyListeners={},this._inDispatch=0,this._isEnabled=!1,this._internalCustomListenerIDs=[],this._currentTouch=null,this._currentTouchListener=null}var t=e.prototype;return t.pauseTarget=function(e,t){if(void 0===t&&(t=!1),e instanceof h._BaseNode){var i=this._nodeListenersMap[e.uuid];if(i)for(var n=0;n<i.length;++n)i[n]._setPaused(!0);if(!0===t){var s=e.children;if(s)for(var r=0;r<s.length;++r){var o=s[r];this.pauseTarget(o,!0)}}}else J(3506)},t.resumeTarget=function(e,t){if(void 0===t&&(t=!1),e instanceof h._BaseNode){var i=this._nodeListenersMap[e.uuid];if(i)for(var n=0;n<i.length;++n)i[n]._setPaused(!1);if(this._setDirtyForNode(e),!0===t&&e.children.length>0){var s=e.children;if(s)for(var r=0;r<s.length;++r){var o=s[r];this.resumeTarget(o,!0)}}}else J(3506)},t.frameUpdateListeners=function(){var e=this._listenersMap,t=this._priorityDirtyFlagMap;for(var i in e)e[i].empty()&&(delete t[i],delete e[i]);var n=this._toAddedListeners;if(0!==n.length){for(var s=0,r=n.length;s<r;s++)this._forceAddEventListener(n[s]);n.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()},t.hasEventListener=function(e){return!!this._getListeners(e)},t.addListener=function(e,t){if(Z(e&&t,3503),!(h.js.isNumber(t)||t instanceof h._BaseNode))return J(3506),null;if(e instanceof h.EventListener){if(e._isRegistered())return X(3505),null}else Z(!h.js.isNumber(t),3504),e=h.EventListener.create(e);if(!e.checkAvailable())return null;if(h.js.isNumber(t)){if(0===t)return X(3500),null;e._setSceneGraphPriority(null),e._setFixedPriority(t),e._setRegistered(!0),e._setPaused(!1),this._addListener(e)}else{if(!(i=t)||!i.getComponent("cc.UITransform"))return X(3512),null;e._setSceneGraphPriority(t),e._setFixedPriority(0),e._setRegistered(!0),this._addListener(e)}var i;return e},t.addCustomListener=function(e,t){var i=be.create({event:h.EventListener.CUSTOM,eventName:e,callback:t});return this.addListener(i,1),i},t.removeListener=function(e){if(null!=e){var t=!1,i=this._listenersMap;for(var n in i){var s=i[n],r=s.getFixedPriorityListeners(),o=s.getSceneGraphPriorityListeners();if((t=this._removeListenerInVector(o,e))?this._setDirty(e._getListenerID(),2):(t=this._removeListenerInVector(r,e))&&this._setDirty(e._getListenerID(),1),s.empty()&&(delete this._priorityDirtyFlagMap[e._getListenerID()],delete i[n]),t)break}if(!t)for(var a=this._toAddedListeners,_=a.length-1;_>=0;_--){var u=a[_];if(u===e){h.js.array.removeAt(a,_),u._setRegistered(!1);break}}}},t.removeListeners=function(e,t){if(void 0===t&&(t=!1),h.js.isNumber(e)||e instanceof h._BaseNode)if(void 0!==e._id){var i=this._nodeListenersMap[e._id];if(i){for(var n=h.js.array.copy(i),s=0;s<n.length;++s){var r=n[s];this.removeListener(r)}delete this._nodeListenersMap[e._id]}for(var o=this._toAddedListeners,a=0;a<o.length;){var _=o[a];_._getSceneGraphPriority()===e?(_._setSceneGraphPriority(null),_._setRegistered(!1),o.splice(a,1)):++a}if(!0===t)for(var u=e.getChildren(),c=0;c<u.length;++c){var l=u[c];this.removeListeners(l,!0)}}else e===h.EventListener.TOUCH_ONE_BY_ONE?this._removeListenersForListenerID(Ge.TOUCH_ONE_BY_ONE):e===h.EventListener.TOUCH_ALL_AT_ONCE?this._removeListenersForListenerID(Ge.TOUCH_ALL_AT_ONCE):e===h.EventListener.MOUSE?this._removeListenersForListenerID(Ge.MOUSE):e===h.EventListener.ACCELERATION?this._removeListenersForListenerID(Ge.ACCELERATION):e===h.EventListener.KEYBOARD?this._removeListenersForListenerID(Ge.KEYBOARD):X(3501);else J(3506)},t.removeCustomListeners=function(e){this._removeListenersForListenerID(e)},t.removeAllListeners=function(){var e=this._listenersMap,t=this._internalCustomListenerIDs;for(var i in e)-1===t.indexOf(i)&&this._removeListenersForListenerID(i)},t.setPriority=function(e,t){if(null!=e){var i=this._listenersMap;for(var n in i){var s=i[n].getFixedPriorityListeners();if(s&&-1!==s.indexOf(e))return null!=e._getSceneGraphPriority()&&X(3502),void(e._getFixedPriority()!==t&&(e._setFixedPriority(t),this._setDirty(e._getListenerID(),1)))}}},t.setEnabled=function(e){this._isEnabled=e},t.isEnabled=function(){return this._isEnabled},t.dispatchEvent=function(e){if(this._isEnabled)if(this._updateDirtyFlagForSceneGraph(),this._inDispatch++,e&&e.getType){if(e.getType().startsWith(h.Event.TOUCH))return this._dispatchTouchEvent(e),void this._inDispatch--;var t=function(e){var t=K,i=e.type;return i===t.ACCELERATION?Ge.ACCELERATION:i===t.KEYBOARD?Ge.KEYBOARD:i.startsWith(t.MOUSE)?Ge.MOUSE:(i.startsWith(t.TOUCH)&&X(2e3),"")}(e);this._sortEventListeners(t);var i=this._listenersMap[t];null!=i&&(this._dispatchEventToListeners(i,this._onListenerCallback,e),this._onUpdateListeners(i)),this._inDispatch--}else q(3511)},t._onListenerCallback=function(e,t){t.currentTarget=e._target;var i=e.onEvent;return i&&i(t),t.isStopped()},t.dispatchCustomEvent=function(e,t){var i=new h.Event.EventCustom(e);i.setUserData(t),this.dispatchEvent(i)},t._setDirtyForNode=function(e){var t=this._nodeListenersMap[e._id];if(void 0!==t)for(var i=0,n=t.length;i<n;i++){var s=t[i]._getListenerID();this._dirtyListeners[s]||(this._dirtyListeners[s]=!0)}if(e.children.length>0)for(var r=e.children,o=0,h=r?r.length:0;o<h;o++)this._setDirtyForNode(r[o])},t._addListener=function(e){0===this._inDispatch?this._forceAddEventListener(e):this._toAddedListeners.push(e)},t._forceAddEventListener=function(e){var t=e._getListenerID(),i=this._listenersMap[t];if(i||(i=new je,this._listenersMap[t]=i),i.push(e),0===e._getFixedPriority()){this._setDirty(t,2);var n=e._getSceneGraphPriority();null===n&&X(3507),this._associateNodeAndEventListener(n,e),n.activeInHierarchy&&this.resumeTarget(n)}else this._setDirty(t,1)},t._getListeners=function(e){return this._listenersMap[e]},t._updateDirtyFlagForSceneGraph=function(){var e=this._dirtyListeners;for(var t in e)this._setDirty(t,2),e[t]=!1},t._removeAllListenersInVector=function(e){if(e)for(var t,i=e.length-1;i>=0;i--)(t=e[i])._setRegistered(!1),null!=t._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(t._getSceneGraphPriority(),t),t._setSceneGraphPriority(null)),0===this._inDispatch&&h.js.array.removeAt(e,i)},t._removeListenersForListenerID=function(e){var t=this._listenersMap[e];if(t){var i=t.getFixedPriorityListeners(),n=t.getSceneGraphPriorityListeners();this._removeAllListenersInVector(n),this._removeAllListenersInVector(i),delete this._priorityDirtyFlagMap[e],this._inDispatch||(t.clear(),delete this._listenersMap[e])}for(var s=this._toAddedListeners,r=s.length-1;r>=0;r--){var o=s[r];o&&o._getListenerID()===e&&h.js.array.removeAt(s,r)}},t._sortEventListeners=function(e){var t=0,i=this._priorityDirtyFlagMap;i[e]&&(t=i[e]),0!==t&&(i[e]=0,1&t&&this._sortListenersOfFixedPriority(e),2&t&&h.director.getScene()&&this._sortListenersOfSceneGraphPriority(e))},t._sortListenersOfSceneGraphPriority=function(e){var t=this._getListeners(e);if(t){var i=t.getSceneGraphPriorityListeners();if(i&&0!==i.length){var n=t.getSceneGraphPriorityListeners();n.forEach((function(e){var t=e._getSceneGraphPriority()._uiProps.uiTransformComp;e._cameraPriority=t.cameraPriority})),n.sort(this._sortEventListenersOfSceneGraphPriorityDes)}}},t._sortEventListenersOfSceneGraphPriorityDes=function(e,t){var i=e._getSceneGraphPriority(),n=t._getSceneGraphPriority();if(!(t&&n&&n._activeInHierarchy&&n._uiProps.uiTransformComp))return-1;if(!(e&&i&&i._activeInHierarchy&&i._uiProps.uiTransformComp))return 1;var s=i,r=n,o=!1;if(e._cameraPriority!==t._cameraPriority)return t._cameraPriority-e._cameraPriority;for(;s.parent._id!==r.parent._id;)s=null===s.parent.parent?(o=!0)&&n:s.parent,r=null===r.parent.parent?(o=!0)&&i:r.parent;if(s._id===r._id){if(s._id===n._id)return-1;if(s._id===i._id)return 1}var h=s.getSiblingIndex(),a=r.getSiblingIndex();return o?h-a:a-h},t._sortListenersOfFixedPriority=function(e){var t=this._listenersMap[e];if(t){var i=t.getFixedPriorityListeners();if(i&&0!==i.length){i.sort(this._sortListenersOfFixedPriorityAsc);for(var n=0,s=i.length;n<s&&!(i[n]._getFixedPriority()>=0);)++n;t.gt0Index=n}}},t._sortListenersOfFixedPriorityAsc=function(e,t){return e._getFixedPriority()-t._getFixedPriority()},t._onUpdateListeners=function(e){var t=e.getFixedPriorityListeners(),i=e.getSceneGraphPriorityListeners(),n=this._toRemovedListeners;if(i)for(var s=i.length-1;s>=0;s--){var r=i[s];if(!r._isRegistered()){h.js.array.removeAt(i,s);var o=n.indexOf(r);-1!==o&&n.splice(o,1)}}if(t)for(var a=t.length-1;a>=0;a--){var _=t[a];if(!_._isRegistered()){h.js.array.removeAt(t,a);var u=n.indexOf(_);-1!==u&&n.splice(u,1)}}i&&0===i.length&&e.clearSceneGraphListeners(),t&&0===t.length&&e.clearFixedListeners()},t._updateTouchListeners=function(){var e=this._inDispatch;if(Z(e>0,3508),!(e>1)){var t;(t=this._listenersMap[Ge.TOUCH_ONE_BY_ONE])&&this._onUpdateListeners(t),(t=this._listenersMap[Ge.TOUCH_ALL_AT_ONCE])&&this._onUpdateListeners(t),Z(1===e,3509);var i=this._toAddedListeners;if(0!==i.length){for(var n=0,s=i.length;n<s;n++)this._forceAddEventListener(i[n]);this._toAddedListeners.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}},t._cleanToRemovedListeners=function(){for(var e=this._toRemovedListeners,t=0;t<e.length;++t){var i=e[t],n=this._listenersMap[i._getListenerID()];if(n){var s=n.getFixedPriorityListeners(),r=n.getSceneGraphPriorityListeners();if(r){var o=r.indexOf(i);-1!==o&&r.splice(o,1)}if(s){var h=s.indexOf(i);-1!==h&&s.splice(h,1)}}}e.length=0},t._onTouchEventCallback=function(e,t){if(!e._isRegistered())return!1;var i=t.event,n=i.touch;i.currentTarget=e._getSceneGraphPriority();var s=!1,r=-1,o=i.getEventCode();if(o===Re.BEGAN){if(!Q.ENABLE_MULTI_TOUCH&&We._currentTouch){var h=We._currentTouchListener._node;if(!h||h.activeInHierarchy)return!1}e.onTouchBegan&&(s=e.onTouchBegan(n,i))&&e._isRegistered()&&(e._claimedTouches.push(n),!Q.ENABLE_MULTI_TOUCH&&We._currentTouch||(We._currentTouch=n),We._currentTouchListener=e)}else if(e._claimedTouches.length>0&&-1!==(r=e._claimedTouches.indexOf(n))){if(s=!0,!Q.ENABLE_MULTI_TOUCH&&We._currentTouch&&We._currentTouch!==n)return!1;o===Re.MOVED&&e.onTouchMoved?e.onTouchMoved(n,i):o===Re.ENDED?(e.onTouchEnded&&e.onTouchEnded(n,i),e._isRegistered()&&e._claimedTouches.splice(r,1),(Q.ENABLE_MULTI_TOUCH||We._currentTouch===n)&&(We._currentTouch=null),We._currentTouchListener=null):o===Re.CANCELLED&&(e.onTouchCancelled&&e.onTouchCancelled(n,i),e._isRegistered()&&e._claimedTouches.splice(r,1),(Q.ENABLE_MULTI_TOUCH||We._currentTouch===n)&&(We._currentTouch=null),We._currentTouchListener=null)}return i.isStopped()?(We._updateTouchListeners(i),!0):!!(s&&e._isRegistered()&&e.swallowTouches)&&(t.needsMutableSet&&t.touches.splice(n,1),!0)},t._dispatchTouchEvent=function(e){this._sortEventListeners(Ge.TOUCH_ONE_BY_ONE),this._sortEventListeners(Ge.TOUCH_ALL_AT_ONCE);var t=this._getListeners(Ge.TOUCH_ONE_BY_ONE),i=this._getListeners(Ge.TOUCH_ALL_AT_ONCE);if(null!==t||null!==i){var n=e.getTouches(),s=h.js.array.copy(n),r={event:e,needsMutableSet:t&&i,touches:s,selTouch:null};if(t)for(var o=0;o<n.length;++o){var a=n[o];e.touch=a,e.propagationStopped=e.propagationImmediateStopped=!1,this._dispatchEventToListeners(t,this._onTouchEventCallback,r)}i&&s.length>0&&(this._dispatchEventToListeners(i,this._onTouchesEventCallback,{event:e,touches:s}),e.isStopped())||this._updateTouchListeners(e)}},t._onTouchesEventCallback=function(e,t){if(!e._isRegistered())return!1;var i=t.event,n=t.touches,s=i.getEventCode();return i.currentTarget=e._getSceneGraphPriority(),s===Re.BEGAN&&e.onTouchesBegan?e.onTouchesBegan(n,i):s===Re.MOVED&&e.onTouchesMoved?e.onTouchesMoved(n,i):s===Re.ENDED&&e.onTouchesEnded?e.onTouchesEnded(n,i):s===Re.CANCELLED&&e.onTouchesCancelled&&e.onTouchesCancelled(n,i),!!i.isStopped()&&(We._updateTouchListeners(i),!0)},t._associateNodeAndEventListener=function(e,t){var i=this._nodeListenersMap[e.uuid];i||(i=[],this._nodeListenersMap[e.uuid]=i),i.push(t)},t._dissociateNodeAndEventListener=function(e,t){var i=this._nodeListenersMap[e.uuid];i&&(h.js.array.remove(i,t),0===i.length&&delete this._nodeListenersMap[e.uuid])},t._dispatchEventToListeners=function(e,t,i){var n=!1,s=e.getFixedPriorityListeners(),r=e.getSceneGraphPriorityListeners(),o=0;if(s&&0!==s.length)for(;o<e.gt0Index;++o){var h=s[o];if(h.isEnabled()&&!h._isPaused()&&h._isRegistered()&&t(h,i)){n=!0;break}}if(r&&!n)for(var a=0;a<r.length;++a){var _=r[a];if(_.isEnabled()&&!_._isPaused()&&_._isRegistered()&&t(_,i)){n=!0;break}}if(s&&!n)for(;o<s.length;++o){var u=s[o];if(u.isEnabled()&&!u._isPaused()&&u._isRegistered()&&t(u,i)){n=!0;break}}},t._setDirty=function(e,t){var i=this._priorityDirtyFlagMap;null==i[e]?i[e]=t:i[e]|=t},t._sortNumberAsc=function(e,t){return e-t},t._removeListenerInCallback=function(e,t){if(null==e)return!1;for(var i=e.length-1;i>=0;i--){var n=e[i];if(n._onCustomEvent===t||n.onEvent===t)return n._setRegistered(!1),null!=n._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(n._getSceneGraphPriority(),n),n._setSceneGraphPriority(null)),0===this._inDispatch?h.js.array.removeAt(e,i):this._toRemovedListeners.push(n),!0}return!1},t._removeListenerInVector=function(e,t){if(null==e)return!1;for(var i=e.length-1;i>=0;i--){var n=e[i];if(n===t)return n._setRegistered(!1),null!=n._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(n._getSceneGraphPriority(),n),n._setSceneGraphPriority(null)),0===this._inDispatch?h.js.array.removeAt(e,i):this._toRemovedListeners.push(n),!0}return!1},e}(),We=e("l",new Ye);h.eventManager=We,function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed"}(Be||(Be=e("q",{}))),$(Be),h.SystemEventType=Be}}}));
