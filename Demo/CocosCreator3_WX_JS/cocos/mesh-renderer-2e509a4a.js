System.register(["./coordinates-converts-utils-bf8713a9.js","./event-enum-5a5aa40e.js","./renderable-component-658e90bd.js","./texture-buffer-pool-d3259f64.js","./mesh-3d4ecfd0.js"],(function(e){"use strict";var t,i,n,o,s,a,r,h,l,d,c,u,p,_,m,g,f,b,w,M,S,y,v,I,O,P;return{setters:[function(e){t=e.e3,i=e.bD,n=e.e2,o=e.fN,s=e.e4,a=e.e5,r=e.e9,h=e.ec,l=e.fr,d=e.e7,c=e.e8,u=e.l,p=e.e0,_=e.fF,m=e.fO,g=e.ea,f=e.b4,b=e.fs,w=e.fw,M=e.ft,S=e.fu,y=e.fm},function(e){v=e.T},function(e){I=e.a,O=e.d},function(){},function(e){P=e.M}],execute:function(){var R,z,C,F,k,D,j,L,T,x,B,N,A,U,W,E,V,H,q,G,J,K,Q,X,Y,Z,$,ee,te,ie,ne,oe=e("a",function(e){function i(){for(var t,i=arguments.length,n=new Array(i),o=0;o<i;o++)n[o]=arguments[o];return(t=e.call.apply(e,[this].concat(n))||this)._morphRenderingInstance=null,t._usedMaterials=new Set,t}t(i,e);var n=i.prototype;return n.getMacroPatches=function(e){return this._morphRenderingInstance?this._morphRenderingInstance.requiredPatches(e):void 0},n.initSubModel=function(t,i,n){return e.prototype.initSubModel.call(this,t,i,this._launderMaterial(n))},n.setSubModelMaterial=function(t,i){return e.prototype.setSubModelMaterial.call(this,t,this._launderMaterial(i))},n._updateLocalDescriptors=function(t,i){e.prototype._updateLocalDescriptors.call(this,t,i),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(t,i)},n._launderMaterial=function(e){return e},n.setMorphRendering=function(e){this._morphRenderingInstance=e},i}(I)),se=i({OFF:0,ON:1}),ae=i({OFF:0,ON:1}),re=(R=n("cc.ModelLightmapSettings"),z=o("_recieveShadow"),R((B=function(){function e(){d(this,"texture",k,this),d(this,"uvParam",D,this),d(this,"_bakeable",j,this),d(this,"_castShadow",L,this),d(this,"_receiveShadow",T,this),d(this,"_lightmapSize",x,this)}return s(e,[{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e}},{key:"lightmapSize",get:function(){return this._lightmapSize},set:function(e){this._lightmapSize=e}}]),e}(),k=a((F=B).prototype,"texture",[g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),D=a(F.prototype,"uvParam",[g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new f}}),j=a(F.prototype,"_bakeable",[g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),L=a(F.prototype,"_castShadow",[g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),T=a(F.prototype,"_receiveShadow",[z],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),x=a(F.prototype,"_lightmapSize",[g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),a(F.prototype,"bakeable",[r],Object.getOwnPropertyDescriptor(F.prototype,"bakeable"),F.prototype),a(F.prototype,"castShadow",[r],Object.getOwnPropertyDescriptor(F.prototype,"castShadow"),F.prototype),a(F.prototype,"receiveShadow",[r],Object.getOwnPropertyDescriptor(F.prototype,"receiveShadow"),F.prototype),a(F.prototype,"lightmapSize",[r],Object.getOwnPropertyDescriptor(F.prototype,"lightmapSize"),F.prototype),C=F))||C);e("M",(N=n("cc.MeshRenderer"),A=b(),U=w(100),W=M(),E=h(se),V=S(),H=h(ae),q=S(),G=h(P),J=S(),K=y(),N(Q=A(Q=U(Q=W(Q=l((ne=ie=function(e){function i(){var t;return t=e.call(this)||this,d(t,"lightmapSettings",Y,c(t)),d(t,"_mesh",Z,c(t)),d(t,"_shadowCastingMode",$,c(t)),d(t,"_shadowReceivingMode",ee,c(t)),t._modelType=void 0,t._model=null,t._morphInstance=null,d(t,"_enableMorph",te,c(t)),t._modelType=I,t}t(i,e),s(i,[{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(e){this._shadowCastingMode=e,this._updateCastShadow()}},{key:"receiveShadow",get:function(){return this._shadowReceivingMode},set:function(e){this._shadowReceivingMode=e,this._updateReceiveShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(e){var t=this._mesh;this._mesh=e,this._mesh&&this._mesh.initialize(),this._watchMorphInMesh(),this._onMeshChanged(t),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"model",get:function(){return this._model}},{key:"enableMorph",get:function(){return this._enableMorph},set:function(e){this._enableMorph=e}}]);var n=i.prototype;return n.onLoad=function(){this._mesh&&this._mesh.initialize(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},n.onRestore=function(){this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},n.onEnable=function(){this._model||this._updateModels(),this._attachToScene()},n.onDisable=function(){this._model&&this._detachFromScene()},n.onDestroy=function(){this._model&&(u.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()},n.setWeights=function(e,t){this._morphInstance&&this._morphInstance.setWeights(t,e)},n.setInstancedAttribute=function(e,t){if(this.model)for(var i=this.model.instancedAttributes,n=i.attributes,o=i.views,s=0;s<n.length;s++)if(n[s].name===e){o[s].set(t);break}},n._updateLightmap=function(e,t,i,n,o){this.lightmapSettings.texture=e,this.lightmapSettings.uvParam.x=t,this.lightmapSettings.uvParam.y=i,this.lightmapSettings.uvParam.z=n,this.lightmapSettings.uvParam.w=o,this._onUpdateLightingmap()},n._updateModels=function(){if(this.enabledInHierarchy&&this._mesh){var e=this._model;e?(e.destroy(),e.initialize(),e.node=e.transform=this.node):this._createModel(),this._model&&(this._model.createBoundingShape(this._mesh.struct.minPosition,this._mesh.struct.maxPosition),this._updateModelParams(),this._onUpdateLightingmap())}},n._createModel=function(){var e=this._morphInstance&&this._modelType===I?oe:this._modelType,t=this._model=u.director.root.createModel(e);t.visFlags=this.visibility,t.node=t.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&t instanceof oe&&t.setMorphRendering(this._morphInstance)},n._attachToScene=function(){if(this.node.scene&&this._model){var e=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),e.addModel(this._model)}},n._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},n._updateModelParams=function(){if(this._mesh&&this._model){this.node.hasChangedFlags|=v.POSITION,this._model.transform.hasChangedFlags|=v.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();var e=this._mesh?this._mesh.renderingSubMeshes.length:0,t=this._mesh.renderingSubMeshes;if(t)for(var i=0;i<e;++i){var n=this.getRenderMaterial(i);n&&!n.isValid&&(n=null);var o=t[i];o&&this._model.initSubModel(i,o,n||this._getBuiltinMaterial())}this._model.enabled=!0}},n._onUpdateLightingmap=function(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])},n._onMaterialModified=function(e,t){this._model&&this._model.inited&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())},n._onRebuildPSO=function(e,t){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(e,t),this._onUpdateLightingmap())},n._onMeshChanged=function(){},n._clearMaterials=function(){if(this._model)for(var e=this._model.subModels,t=0;t<e.length;++t)this._onMaterialModified(t,null)},n._getBuiltinMaterial=function(){return p.get("missing-material")},n._onVisibilityChange=function(e){this._model&&(this._model.visFlags=e)},n._updateCastShadow=function(){this._model&&(this._shadowCastingMode===se.OFF?this._model.castShadow=!1:(_(this._shadowCastingMode===se.ON,"ShadowCastingMode "+this._shadowCastingMode+" is not supported."),this._model.castShadow=!0))},n._updateReceiveShadow=function(){this._model&&(this._shadowReceivingMode===ae.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)},n._isBatchingEnabled=function(){for(var e=0;e<this._materials.length;++e){var t=this._materials[e];if(t)for(var i=0;i<t.passes.length;++i)if(t.passes[i].batchingScheme)return!0}return!1},n._watchMorphInMesh=function(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),this._enableMorph&&this._mesh&&this._mesh.struct.morph&&this._mesh.morphRendering){var e=this._mesh.struct.morph;this._morphInstance=this._mesh.morphRendering.createInstance();for(var t=this._mesh.struct.primitives.length,i=0;i<t;++i){var n=e.subMeshMorphs[i];if(n){var o=n.weights||e.weights,s=o?o.slice():new Array(n.targets.length).fill(0);this._morphInstance.setWeights(i,s)}}this._model&&this._model instanceof oe&&this._model.setMorphRendering(this._morphInstance)}},n._syncMorphWeights=function(e){if(this._morphInstance){var t=this._morphInstance[e];t&&t.renderResources&&t.renderResources.setWeights(t.weights)}},i}(O),ie.ShadowCastingMode=se,ie.ShadowReceivingMode=ae,Y=a((X=ne).prototype,"lightmapSettings",[g,r,m],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new re}}),Z=a(X.prototype,"_mesh",[g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$=a(X.prototype,"_shadowCastingMode",[g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return se.OFF}}),ee=a(X.prototype,"_shadowReceivingMode",[g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ae.ON}}),a(X.prototype,"shadowCastingMode",[E,V,m],Object.getOwnPropertyDescriptor(X.prototype,"shadowCastingMode"),X.prototype),a(X.prototype,"receiveShadow",[H,q,m],Object.getOwnPropertyDescriptor(X.prototype,"receiveShadow"),X.prototype),a(X.prototype,"mesh",[G,J],Object.getOwnPropertyDescriptor(X.prototype,"mesh"),X.prototype),a(X.prototype,"enableMorph",[K,m],Object.getOwnPropertyDescriptor(X.prototype,"enableMorph"),X.prototype),te=a(X.prototype,"_enableMorph",[g],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Q=X))||Q)||Q)||Q)||Q)||Q))}}}));
