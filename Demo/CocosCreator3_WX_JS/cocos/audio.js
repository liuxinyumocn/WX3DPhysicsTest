System.register(["./coordinates-converts-utils-bf8713a9.js","./json-asset-0797cbb7.js","./factory-9595a1ce.js"],(function(t){"use strict";var e,i,n,o,r,s,a,u,_,c,d,l,h,p,f,v,y,m,g,A,T,E,P,N,O;return{setters:[function(t){e=t.l,i=t.ck,n=t.e3,o=t.bl,r=t.e8,s=t.bD,a=t.e2,u=t.ec,_=t.e4,c=t.c5,d=t.e5,l=t.e6,h=t.e7,p=t.ea,f=t.a,v=t.ci,y=t.fs,m=t.ft,g=t.fu,A=t.fn,T=t.d_,E=t.eD},function(){},function(t){P=t.d,N=t.i,O=t.m}],execute:function(){var I={INITIALIZING:0,PLAYING:1,STOPPED:2},D=function(){function t(t){var i=this;this._state=I.STOPPED,this._duration=0,this._clip=void 0,this._onHide=void 0,this._onShow=void 0,this._interrupted=!1,this._blocking=!1,this._duration=t.duration,this._clip=t.audioClip,this._onHide=function(){i._blocking=!0,i._state===I.PLAYING&&(i.pause(),i._interrupted=!0)},this._onShow=function(){i._blocking=!1,i._interrupted&&(i.play(),i._interrupted=!1)},e.game.on(e.Game.EVENT_HIDE,this._onHide),e.game.on(e.Game.EVENT_SHOW,this._onShow)}var i=t.prototype;return i.getState=function(){return this._state},i.getDuration=function(){return this._duration},i.destroy=function(){e.game.off(e.Game.EVENT_HIDE,this._onHide),e.game.off(e.Game.EVENT_SHOW,this._onShow)},t}();function L(t){var e=i.__audioSupport;return new Promise((function(i,n){var o=document.createElement("audio");o.src=t;var r=function(){clearTimeout(s),o.removeEventListener("canplaythrough",a,!1),o.removeEventListener("error",u,!1),e.USE_LOADER_EVENT&&o.removeEventListener(e.USE_LOADER_EVENT,a,!1)},s=setTimeout((function(){0===o.readyState?u():a()}),8e3),a=function(){r(),i(o)},u=function(){r(),n("load audio failure - "+t)};o.addEventListener("canplaythrough",a,!1),o.addEventListener("error",u,!1),e.USE_LOADER_EVENT&&o.addEventListener(e.USE_LOADER_EVENT,a,!1)}))}e.internal.AudioPlayer=D;var b=function(){function t(){this._playingAudios=void 0,this._playingAudios=[]}var e=t.prototype;return e.addPlaying=function(t){this._playingAudios.push(t)},e.removePlaying=function(t){var e=this._playingAudios.indexOf(t);e>-1&&this._playingAudios.splice(e,1)},t}();b.maxAudioChannel=24,e.internal.AudioManager=b;var S=function(t){function e(){return t.apply(this,arguments)||this}return n(e,t),e.prototype.discardOnePlayingIfNeeded=function(){if(!(this._playingAudios.length<b.maxAudioChannel)){var t,e,i=this._playingAudios.findIndex((function(t){return t instanceof HTMLAudioElement}));i>-1?(t=this._playingAudios[i],this._playingAudios.splice(i,1),t.pause(),t.src=""):null===(e=t=this._playingAudios.shift())||void 0===e||e.stop()}},e}(b),C=function(t){function i(n){var o;return(o=t.call(this,n)||this)._volume=1,o._loop=!1,o._nativeAudio=void 0,o._cbRegistered=!1,o._remove_cb=void 0,o._post_play=void 0,o._on_gesture=void 0,o._post_gesture=void 0,o._nativeAudio=n.nativeAudio,o._remove_cb=function(){o._cbRegistered&&(e.game.canvas.removeEventListener("touchend",o._on_gesture),e.game.canvas.removeEventListener("mouseup",o._on_gesture),o._cbRegistered=!1)},o._post_play=function(){o._state=I.PLAYING,o._clip.emit("started"),o._remove_cb(),i._manager.addPlaying(r(o))},o._post_gesture=function(){o._interrupted?(o._post_play(),o._interrupted=!1):(o._nativeAudio.pause(),o._nativeAudio.currentTime=0)},o._on_gesture=function(){if(o._nativeAudio){var t=o._nativeAudio.play();if(!t)return o._state=I.PLAYING,void e.director.once(e.Director.EVENT_AFTER_UPDATE,o._post_gesture);t.then(o._post_gesture),o._remove_cb()}},o._nativeAudio.volume=o._volume,o._nativeAudio.loop=o._loop,o._nativeAudio.addEventListener("ended",(function(){o._state=I.STOPPED,o._nativeAudio.currentTime=0,o._clip.emit("ended"),i._manager.removePlaying(r(o))})),e.game.canvas.addEventListener("touchend",o._on_gesture),e.game.canvas.addEventListener("mouseup",o._on_gesture),o._cbRegistered=!0,o}n(i,t);var s=i.prototype;return s.play=function(){var t=this;if(this._nativeAudio)if(this._blocking)this._interrupted=!0;else{this._state===I.PLAYING&&(this.pause(),this.setCurrentTime(0)),i._manager.discardOnePlayingIfNeeded();var n=this._nativeAudio.play();if(!n)return this._state=I.PLAYING,void e.director.once(e.Director.EVENT_AFTER_UPDATE,this._post_play);n.then(this._post_play).catch((function(){t._interrupted=!0}))}},s.pause=function(){this._nativeAudio&&(this._interrupted=!1,this._state===I.PLAYING&&(this._nativeAudio.pause(),this._state=I.STOPPED,i._manager.removePlaying(this)))},s.stop=function(){this._nativeAudio&&(this._nativeAudio.currentTime=0,this._interrupted=!1,this._state===I.PLAYING&&(this._nativeAudio.pause(),this._state=I.STOPPED,i._manager.removePlaying(this)))},s.playOneShot=function(t){void 0===t&&(t=1),L(this._nativeAudio.src).then((function(e){i._manager.discardOnePlayingIfNeeded(),e.volume=t,e.play(),i._manager.addPlaying(e),e.addEventListener("ended",(function(){i._manager.removePlaying(e)}))}),(function(t){console.error(t)}))},s.setCurrentTime=function(t){this._nativeAudio&&(this._nativeAudio.currentTime=o(t,0,this._duration))},s.getCurrentTime=function(){return this._nativeAudio?this._nativeAudio.currentTime:0},s.setVolume=function(t){this._volume=t,this._nativeAudio&&(this._nativeAudio.volume=t)},s.getVolume=function(){return this._nativeAudio?this._nativeAudio.volume:this._volume},s.setLoop=function(t){this._loop=t,this._nativeAudio&&(this._nativeAudio.loop=t)},s.getLoop=function(){return this._loop},s.destroy=function(){this._nativeAudio&&(this._nativeAudio.src=""),t.prototype.destroy.call(this)},i}(D);C._manager=new S;var w,G,x,k,V,B,U,M,Y=function(t){function e(){return t.apply(this,arguments)||this}return n(e,t),e.prototype.discardOnePlayingIfNeeded=function(){if(!(this._playingAudios.length<b.maxAudioChannel)){var t,e=this._playingAudios.findIndex((function(t){return t instanceof AudioBufferSourceNode}));e>-1?(t=this._playingAudios[e],this._playingAudios.splice(e,1)):t=this._playingAudios.shift(),t&&t.stop()}},e}(b),R=function(t){function s(n){var o;(o=t.call(this,n)||this)._startTime=0,o._offset=0,o._volume=1,o._loop=!1,o._currentTimer=0,o._nativeAudio=void 0,o._context=void 0,o._sourceNode=void 0,o._gainNode=void 0,o._startInvoked=!1,o._onEndedCB=void 0,o._onGestureCB=void 0,o._onGestureProceedCB=void 0;var s=i.__audioSupport;return o._nativeAudio=n.nativeAudio,o._context=s.context,o._sourceNode=o._context.createBufferSource(),o._gainNode=o._context.createGain(),o._gainNode.connect(o._context.destination),o._onEndedCB=o._onEnded.bind(r(o)),o._onGestureCB=o._onGesture.bind(r(o)),o._onGestureProceedCB=o._onGestureProceed.bind(r(o)),"running"!==o._context.state&&o._context.resume&&(e.game.canvas.addEventListener("touchend",o._onGestureCB),e.game.canvas.addEventListener("mouseup",o._onGestureCB)),o}n(s,t);var a=s.prototype;return a.play=function(){if(this._nativeAudio){if(this._state===I.PLAYING&&(this.pause(),this.setCurrentTime(0)),this._blocking||"running"!==this._context.state)return this._interrupted=!0,void("interrupted"!==this._context.state&&"suspended"!==this._context.state||!this._context.resume||this._onGesture());this._doPlay()}},a.pause=function(){this._interrupted=!1,this._state===I.PLAYING&&(this._doStop(),this._offset+=this._context.currentTime-this._startTime,this._state=I.STOPPED,clearInterval(this._currentTimer))},a.stop=function(){this._offset=0,this._interrupted=!1,this._state===I.PLAYING&&(this._doStop(),this._state=I.STOPPED,clearInterval(this._currentTimer))},a.playOneShot=function(t){if(void 0===t&&(t=1),this._nativeAudio){"interrupted"!==this._context.state&&"suspended"!==this._context.state||this._context.resume&&this._context.resume().catch((function(t){console.error(t)})),s._manager.discardOnePlayingIfNeeded();var e=this._context.createGain();e.connect(this._context.destination),e.gain.value=t;var i=this._context.createBufferSource();i.buffer=this._nativeAudio,i.loop=!1,i.connect(e),i.start(),s._manager.addPlaying(i),i.onended=function(){s._manager.removePlaying(i)}}},a.setCurrentTime=function(t){this._offset=o(t,0,this._nativeAudio&&this._nativeAudio.duration||this._duration),this._state===I.PLAYING&&(this._doStop(),this._doPlay())},a.getCurrentTime=function(){return this._state!==I.PLAYING?this._offset:this._context.currentTime-this._startTime+this._offset},a.setVolume=function(t,e){if(this._volume=t,!e&&this._gainNode.gain.setTargetAtTime)try{this._gainNode.gain.setTargetAtTime(t,this._context.currentTime,0)}catch(e){this._gainNode.gain.setTargetAtTime(t,this._context.currentTime,.01)}else this._gainNode.gain.value=t},a.getVolume=function(){return this._volume},a.setLoop=function(t){this._loop=t,this._sourceNode.loop=t},a.getLoop=function(){return this._loop},a.destroy=function(){t.prototype.destroy.call(this)},a._doPlay=function(){var t=this;s._manager.discardOnePlayingIfNeeded(),this._state=I.PLAYING,this._sourceNode=this._context.createBufferSource(),this._sourceNode.buffer=this._nativeAudio,this._sourceNode.loop=this._loop,this._sourceNode.connect(this._gainNode),this._startTime=this._context.currentTime,this._startInvoked=!1,e.director.once(e.Director.EVENT_AFTER_UPDATE,this._playAndEmit,this),clearInterval(this._currentTimer),this._currentTimer=window.setInterval((function(){t._onEnded(),clearInterval(t._currentTimer),t._sourceNode.loop&&(t._currentTimer=window.setInterval(t._onEndedCB,1e3*t._nativeAudio.duration))}),1e3*(this._nativeAudio.duration-this._offset))},a._doStop=function(){this._startInvoked?this._sourceNode.stop():e.director.off(e.Director.EVENT_AFTER_UPDATE,this._playAndEmit,this),s._manager.removePlaying(this)},a._playAndEmit=function(){this._sourceNode.start(0,this._offset),this._clip.emit("started"),this._startInvoked=!0,s._manager.addPlaying(this)},a._onEnded=function(){this._offset=0,this._startTime=this._context.currentTime,this._sourceNode.loop||(this._clip.emit("ended"),this._state=I.STOPPED,s._manager.removePlaying(this))},a._onGestureProceed=function(){this._interrupted&&(this._doPlay(),this._interrupted=!1),e.game.canvas.removeEventListener("touchend",this._onGestureCB),e.game.canvas.removeEventListener("mouseup",this._onGestureCB)},a._onGesture=function(){"running"!==this._context.state?this._context.resume().then(this._onGestureProceedCB).catch((function(t){console.error(t)})):this._onGestureProceed()},s}(D);R._manager=new Y;var j,H,W,z,F,K,Z,J,q,Q,X,$,tt,et,it,nt,ot,rt=s({WEB_AUDIO:0,DOM_AUDIO:1,JSB_AUDIO:2,UNKNOWN_AUDIO:3}),st=t("AudioClip",(w=a("cc.AudioClip"),G=u(rt),w((M=U=function(t){function e(){var e;return e=t.call(this)||this,h(e,"_duration",V,r(e)),h(e,"_loadMode",B,r(e)),e._nativeAudio=null,e._player=null,e.loaded=!1,e}n(e,t);var i=e.prototype;return i.destroy=function(){return this._player&&this._player.destroy(),t.prototype.destroy.call(this)},i.play=function(){this._player&&this._player.play()},i.pause=function(){this._player&&this._player.pause()},i.stop=function(){this._player&&this._player.stop()},i.playOneShot=function(t){this._player&&this._player.playOneShot(t)},i.setCurrentTime=function(t){this._player&&this._player.setCurrentTime(t)},i.getCurrentTime=function(){return this._player?this._player.getCurrentTime():0},i.getDuration=function(){return this._player?this._player.getDuration():this._duration},i.setVolume=function(t,e){this._player&&this._player.setVolume(t,e||!1)},i.getVolume=function(){return this._player?this._player.getVolume():1},i.setLoop=function(t){this._player&&this._player.setLoop(t)},i.getLoop=function(){return!!this._player&&this._player.getLoop()},i._getPlayer=function(t){var e;return"undefined"!=typeof AudioBuffer&&t instanceof AudioBuffer?(e=R,this._loadMode=rt.WEB_AUDIO):(e=C,this._loadMode=rt.DOM_AUDIO),e},_(e,[{key:"_nativeAsset",set:function(t){if(this._nativeAudio=t,t){var e=this._getPlayer(t);this._player=new e({nativeAudio:t,duration:this._duration,audioClip:this}),this.loaded=!0,this.emit("load")}else this._player=null,this._loadMode=rt.UNKNOWN_AUDIO,this._duration=0,this.loaded=!1},get:function(){return this._nativeAudio}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,audioLoadMode:this.loadMode,ext:this._native,__isNative__:!0}}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.getState():I.INITIALIZING}}]),e}(c),U.PlayingState=I,U.AudioType=rt,U.preventDeferredLoadDependents=!0,V=d((k=M).prototype,"_duration",[p],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),B=d(k.prototype,"_loadMode",[G],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rt.UNKNOWN_AUDIO}}),d(k.prototype,"_nativeDep",[l],Object.getOwnPropertyDescriptor(k.prototype,"_nativeDep"),k.prototype),x=k))||x));function at(t,e,i){L(t).then((function(t){i(null,t)}),(function(t){f(t),i(new Error(t),null)}))}function ut(t,e,i){e.xhrResponseType="arraybuffer",O(t,e,e.onFileProgress,i)}function _t(t,e,n){var o=i.__audioSupport;0!==o.format.length?(o.WEB_AUDIO&&e.audioLoadMode!==rt.DOM_AUDIO?ut:at)(t,e,n):n(new Error(v(4927)))}function ct(t,e,i,n){var o=new st;o._nativeUrl=t,o._nativeAsset=e,o._duration=e.duration,n(null,o)}e.AudioClip=st,P.register({".mp3":_t,".ogg":_t,".wav":_t,".m4a":_t}),P.downloadDomAudio=at,N.register({".mp3":ct,".ogg":ct,".wav":ct,".m4a":ct});var dt,lt=(j=a("cc.AudioSource"),H=y(),W=m(),z=u(st),F=u(st),K=g(),Z=g(),J=g(),q=A(),Q=g(),dt=j(X=H(X=W((ot=function(t){function e(){for(var e,i=arguments.length,n=new Array(i),o=0;o<i;o++)n[o]=arguments[o];return e=t.call.apply(t,[this].concat(n))||this,h(e,"_clip",tt,r(e)),h(e,"_loop",et,r(e)),h(e,"_playOnAwake",it,r(e)),h(e,"_volume",nt,r(e)),e._cachedCurrentTime=0,e}n(e,t);var i=e.prototype;return i.onLoad=function(){this._syncStates()},i.onEnable=function(){this._playOnAwake&&this.play()},i.onDisable=function(){this.pause()},i.onDestroy=function(){this.stop()},i.play=function(){this._clip&&this._clip.play()},i.pause=function(){this._clip&&this._clip.pause()},i.stop=function(){this._clip&&this._clip.stop()},i.playOneShot=function(t,e){void 0===e&&(e=1),t.playOneShot(this._volume*e)},i._syncStates=function(){this._clip&&(this._clip.setCurrentTime(this._cachedCurrentTime),this._clip.setLoop(this._loop),this._clip.setVolume(this._volume,!0),this._volume=this._clip.getVolume())},_(e,[{key:"clip",set:function(t){this._clip=t,this._syncStates()},get:function(){return this._clip}},{key:"loop",set:function(t){this._loop=t,this._clip&&this._clip.setLoop(t)},get:function(){return this._loop}},{key:"playOnAwake",set:function(t){this._playOnAwake=t},get:function(){return this._playOnAwake}},{key:"volume",set:function(t){Number.isNaN(t)?console.warn("illegal audio volume!"):(t=o(t,0,1),this._clip?(this._clip.setVolume(t),this._volume=this._clip.getVolume()):this._volume=t)},get:function(){return this._volume}},{key:"currentTime",set:function(t){Number.isNaN(t)?console.warn("illegal audio time!"):(t=o(t,0,this.duration),this._cachedCurrentTime=t,this._clip&&this._clip.setCurrentTime(this._cachedCurrentTime))},get:function(){return this._clip?this._clip.getCurrentTime():this._cachedCurrentTime}},{key:"duration",get:function(){return this._clip?this._clip.getDuration():0}},{key:"state",get:function(){return this._clip?this._clip.state:st.PlayingState.INITIALIZING}},{key:"playing",get:function(){return this.state===st.PlayingState.PLAYING}}]),e}(T),tt=d(($=ot).prototype,"_clip",[z],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),et=d($.prototype,"_loop",[p],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),it=d($.prototype,"_playOnAwake",[p],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),nt=d($.prototype,"_volume",[p],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),d($.prototype,"clip",[F,K],Object.getOwnPropertyDescriptor($.prototype,"clip"),$.prototype),d($.prototype,"loop",[Z],Object.getOwnPropertyDescriptor($.prototype,"loop"),$.prototype),d($.prototype,"playOnAwake",[J],Object.getOwnPropertyDescriptor($.prototype,"playOnAwake"),$.prototype),d($.prototype,"volume",[q,Q],Object.getOwnPropertyDescriptor($.prototype,"volume"),$.prototype),X=$))||X)||X)||X,t({AudioSource:dt,AudioSourceComponent:dt}),dt);e.AudioSourceComponent=lt,E.setClassAlias(lt,"cc.AudioSourceComponent")}}}));
